<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="éº»é›€è¨ˆç®—">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a202c">
    
    <title>éº»é›€ç‚¹æ•°è¨ˆç®—æ©Ÿ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'landscape': {'raw': '(orientation: landscape)'},
                        'portrait': {'raw': '(orientation: portrait)'}
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; background-color: #1a202c; color: white; height: 100vh; height: -webkit-fill-available; overflow: hidden; user-select: none; touch-action: manipulation; }
        html { height: -webkit-fill-available; }

        /* ç‰Œã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ï¼ˆç¸¦ç”»é¢æ™‚ã«å°‘ã—å°ã•ãï¼‰ */
        .tile {
            width: 2.6rem; height: 3.6rem;
            display: flex; align-items: center; justify-content: center;
            background-color: #f7fafc; border-radius: 0.25rem;
            font-size: 2rem; line-height: 1;
            box-shadow: 0 3px 5px rgba(0,0,0,0.4); cursor: pointer; position: relative; transition: transform 0.1s; touch-action: none; color: #333;
            flex-shrink: 0; /* ç¸¦ç”»é¢ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«ç¸®ã¾ãªã„ã‚ˆã†ã« */
        }
        @media (orientation: portrait) {
            .tile { width: 2.2rem; height: 3.1rem; font-size: 1.7rem; }
            .palette-tile { font-size: 1.8rem !important; height: 3rem !important; }
        }

        .tile-man { color: #c53030; } .tile-pin { color: #2b6cb0; } .tile-sou { color: #2f855a; } .tile-ji { color: #000; }
        .tile-empty { background-color: transparent; border: 2px dashed #4a5568; box-shadow: none; color: transparent; }
        .agari-tile { border: 3px solid #ecc94b; transform: translateY(-4px); z-index: 10; }
        .agari-tile::after { content: 'å’Œ'; position: absolute; top: -10px; right: -8px; background-color: #e53e3e; color: white; font-size: 0.6rem; width: 1.2rem; height: 1.2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid white; font-weight: bold; }
        .palette-tile { width: 100%; height: 3.5rem; display: flex; align-items: center; justify-content: center; background-color: #f7fafc; border-radius: 0.25rem; font-size: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .modal-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); z-index: 50; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* é•·æŠ¼ã—æ¼”å‡ºç”¨ */
        .press-active { transform: scale(0.98); transition: transform 0.1s; }
    </style>
</head>
<body class="flex flex-col h-full p-2 box-border text-gray-100 relative safe-area-inset">

    <div class="flex flex-1 gap-2 mb-2 min-h-0 flex-col landscape:flex-row">
        
        <div class="bg-gray-800 rounded-lg p-2 flex flex-col gap-2 shadow-lg overflow-y-auto no-scrollbar border border-gray-700 w-full landscape:w-1/3 shrink-0 landscape:shrink">
            <div class="grid grid-cols-2 gap-2">
                <button id="btn-prevalent" class="bg-gray-700 py-1.5 rounded text-xs font-bold border border-gray-600 transition-all" onclick="togglePrevalent()">æ±å ´</button>
                <button id="btn-seat" class="bg-red-900 py-1.5 rounded text-xs font-bold border border-red-700 transition-all" onclick="toggleSeat()">æ±å®¶(è¦ª)</button>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button id="btn-win-type" class="bg-red-800 py-1.5 rounded text-xs font-bold border border-red-600 transition-all" onclick="toggleWinType()">ãƒ­ãƒ³ã‚ãŒã‚Š</button>
                <button id="btn-reach" class="bg-gray-700 py-1.5 rounded text-xs font-bold border border-gray-600 text-gray-400 transition-all" onclick="toggleReach()">ç«‹ç›´ãªã—</button>
            </div>
            <div class="flex gap-2">
                <div class="flex-1 flex items-center justify-between bg-gray-700 px-2 py-1 rounded border border-gray-600">
                    <span class="text-xs">ãƒ‰ãƒ©</span>
                    <div class="flex items-center gap-1">
                        <button class="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-sm active:bg-gray-500" onclick="updCnt('dora',-1)">-</button>
                        <span id="dora-disp" class="font-mono text-sm w-5 text-center text-yellow-400">0</span>
                        <button class="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-sm active:bg-gray-500" onclick="updCnt('dora',1)">+</button>
                    </div>
                </div>
                <div class="flex-1 flex items-center justify-between bg-gray-700 px-2 py-1 rounded border border-gray-600">
                    <span class="text-xs">æœ¬å ´</span>
                    <div class="flex items-center gap-1">
                        <button class="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-sm active:bg-gray-500" onclick="updCnt('honba',-1)">-</button>
                        <span id="honba-disp" class="font-mono text-sm w-5 text-center">0</span>
                        <button class="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-sm active:bg-gray-500" onclick="updCnt('honba',1)">+</button>
                    </div>
                </div>
            </div>

            <div id="score-container" class="mt-auto bg-gray-900 p-2 rounded border border-gray-700 flex flex-col justify-center min-h-[4.5rem] cursor-pointer transition-colors active:bg-gray-800">
                <div id="result-score" class="text-center text-2xl font-bold text-yellow-400">--- ç‚¹</div>
                <div id="result-yaku" class="text-center text-[10px] text-gray-300 mt-1 leading-tight whitespace-pre-wrap">å½¹ãªã—</div>
                <div class="text-center text-[8px] text-gray-500 mt-1 portrait:hidden">â€»é•·æŠ¼ã—ã§è©³ç´°ã‚’è¡¨ç¤º</div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-2 flex flex-col shadow-lg border border-gray-700 w-full landscape:w-2/3 flex-1 min-h-0">
            <div class="flex gap-1 mb-1 shrink-0">
                <button onclick="renderPalette('man')" class="flex-1 py-1.5 rounded-t bg-blue-600 text-white text-xs font-bold tab-btn" data-type="man">è¬å­</button>
                <button onclick="renderPalette('pin')" class="flex-1 py-1.5 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn" data-type="pin">ç­’å­</button>
                <button onclick="renderPalette('sou')" class="flex-1 py-1.5 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn" data-type="sou">ç´¢å­</button>
                <button onclick="renderPalette('ji')" class="flex-1 py-1.5 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn" data-type="ji">å­—ç‰Œ</button>
            </div>
            <div id="tile-container" class="grid grid-cols-9 gap-1 auto-rows-min overflow-y-auto flex-1 content-start p-1 bg-gray-900 rounded inner-shadow mb-2"></div>
            
            <div class="flex gap-2 shrink-0">
                <button onclick="openCamera()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded font-bold text-sm shadow flex items-center justify-center gap-1 border border-blue-400 active:scale-95 transition-transform">
                    ğŸ“· æ’®å½±
                </button>
                <button onclick="clearHand()" class="flex-1 bg-red-800 hover:bg-red-700 text-white py-3 rounded font-bold text-sm shadow border border-red-700 active:scale-95 transition-transform">
                    ã‚¯ãƒªã‚¢
                </button>
                <button onclick="calculateFull()" class="flex-[2] bg-yellow-600 hover:bg-yellow-500 text-white py-3 rounded font-bold text-lg shadow border border-yellow-400 active:scale-95 transition-transform">
                    è¨ˆç®—
                </button>
            </div>
        </div>
    </div>

    <div class="portrait:h-20 landscape:h-24 shrink-0 bg-green-900 rounded-lg p-1 flex flex-col justify-center relative border-b-4 border-green-950 shadow-inner overflow-hidden">
        <div class="text-[9px] text-green-200 opacity-60 font-mono absolute top-0.5 left-2">TAP:ä¸ŠãŒã‚Šç‰Œ / UP-FLICK:å‰Šé™¤ <span class="portrait:inline hidden">/ æ¨ªãƒ•ãƒªãƒƒã‚¯:ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</span></div>
        
        <div id="hand-scroll-view" class="w-full overflow-x-auto no-scrollbar flex items-center landscape:justify-center mt-3 z-10">
            <div id="hand-container" class="flex gap-1 px-1 flex-nowrap"></div>
        </div>
    </div>

    <div id="camera-modal" class="modal-overlay flex-col">
        <video id="camera-video" class="w-full h-full object-cover" autoplay playsinline></video>
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="w-11/12 h-1/3 border-4 border-yellow-400 rounded-lg flex items-center justify-center bg-black/20 backdrop-blur-sm">
                <span class="text-yellow-400 font-bold opacity-70 tracking-widest text-xl">æ å†…ã«ç‰Œã‚’ä¸¦ã¹ã¦ãã ã•ã„</span>
            </div>
        </div>
        <div class="absolute bottom-8 w-full flex justify-around items-center px-8 safe-area-bottom">
            <button onclick="closeCamera()" class="text-white bg-gray-800 px-6 py-3 rounded-full font-bold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button onclick="takePhoto()" class="w-20 h-20 bg-white rounded-full border-4 border-gray-300 shadow-xl active:bg-gray-200"></button>
            <div class="w-24"></div>
        </div>
        <canvas id="camera-canvas" class="hidden"></canvas>
    </div>

    <div id="detail-modal" class="modal-overlay" onclick="closeDetail()">
        <div class="bg-gray-800 w-11/12 max-w-md rounded-lg p-4 shadow-xl border border-gray-700 relative max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
            <button onclick="closeDetail()" class="absolute top-2 right-2 text-gray-400 hover:text-white bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center">âœ•</button>
            <h3 class="text-lg font-bold text-yellow-400 mb-3 text-center border-b border-gray-700 pb-2">è¨ˆç®—è©³ç´°</h3>
            <div id="detail-content" class="text-sm space-y-4">
                </div>
        </div>
    </div>

    <script>
        // --- 1. å®šæ•°ãƒ»çŠ¶æ…‹ç®¡ç† ---
        const TILES = { man: ['ğŸ€‡','ğŸ€ˆ','ğŸ€‰','ğŸ€Š','ğŸ€‹','ğŸ€Œ','ğŸ€','ğŸ€','ğŸ€'], pin: ['ğŸ€™','ğŸ€š','ğŸ€›','ğŸ€œ','ğŸ€','ğŸ€','ğŸ€Ÿ','ğŸ€ ','ğŸ€¡'], sou: ['ğŸ€','ğŸ€‘','ğŸ€’','ğŸ€“','ğŸ€”','ğŸ€•','ğŸ€–','ğŸ€—','ğŸ€˜'], ji: ['ğŸ€€','ğŸ€','ğŸ€‚','ğŸ€ƒ','ğŸ€†','ğŸ€…','ğŸ€„'] };
        const TYPE_ORDER = { 'man':0, 'pin':1, 'sou':2, 'ji':3 };
        const WINDS = ['æ±','å—','è¥¿','åŒ—'];
        let currentHand = []; let idCounter = 0;
        let settings = { prevalent: 0, seat: 0, winType: 'ron', reach: 0, dora: 0, honba: 0 };
        let lastCalculationResult = null; // æœ€å¾Œã®è¨ˆç®—çµæœã‚’ä¿æŒ

        function init() { renderPalette('man'); renderHand(); updateUI(); setupLongPress(); }

        // --- 2. UIæ“ä½œç³» ---
        function updateUI() {
            document.getElementById('btn-prevalent').textContent = WINDS[settings.prevalent] + "å ´";
            const sBtn = document.getElementById('btn-seat');
            sBtn.textContent = WINDS[settings.seat] + "å®¶" + (settings.seat===0?"(è¦ª)":"(å­)");
            sBtn.className = settings.seat===0 ? "bg-red-900 py-1.5 rounded text-xs font-bold border border-red-700 transition-all" : "bg-blue-900 py-1.5 rounded text-xs font-bold border border-blue-700 transition-all";
            const wBtn = document.getElementById('btn-win-type');
            wBtn.textContent = settings.winType === 'ron' ? "ãƒ­ãƒ³ã‚ãŒã‚Š" : "ãƒ„ãƒ¢ã‚ãŒã‚Š";
            wBtn.className = settings.winType === 'ron' ? "bg-red-800 py-1.5 rounded text-xs font-bold border border-red-600 transition-all" : "bg-green-700 py-1.5 rounded text-xs font-bold border border-green-600 transition-all";
            const rBtn = document.getElementById('btn-reach');
            rBtn.textContent = ["ç«‹ç›´ãªã—", "ç«‹ç›´(1é£œ)", "Wç«‹ç›´(2é£œ)"][settings.reach];
            rBtn.className = ["bg-gray-700 text-gray-400","bg-red-600 text-white","bg-yellow-600 text-white"][settings.reach] + " py-1.5 rounded text-xs font-bold border border-gray-600 transition-all";
            document.getElementById('dora-disp').textContent = settings.dora;
            document.getElementById('honba-disp').textContent = settings.honba;
        }
        function togglePrevalent() { settings.prevalent = (settings.prevalent+1)%2; updateUI(); }
        function toggleSeat() { settings.seat = (settings.seat+1)%4; updateUI(); }
        function toggleWinType() { settings.winType = settings.winType==='ron'?'tsumo':'ron'; updateUI(); }
        function toggleReach() { settings.reach = (settings.reach+1)%3; updateUI(); }
        function updCnt(k, d) { settings[k] = Math.max(0, settings[k]+d); updateUI(); }

        // --- 3. æ‰‹ç‰Œãƒ»ãƒ‘ãƒ¬ãƒƒãƒˆæ“ä½œ ---
        function renderPalette(type) {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.className = b.dataset.type===type ? "flex-1 py-1.5 rounded-t bg-blue-600 text-white text-xs font-bold tab-btn transition-colors" : "flex-1 py-1.5 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn transition-colors";
            });
            const c = document.getElementById('tile-container'); c.innerHTML = '';
            TILES[type].forEach((char, i) => {
                const d = document.createElement('div'); d.className = `palette-tile ${['tile-man','tile-pin','tile-sou','tile-ji'][TYPE_ORDER[type]]}`;
                d.textContent = char; d.onclick = () => addTile(type, i+1, char); c.appendChild(d);
            });
        }
        function addTile(type, val, char) {
            if (currentHand.length < 14) {
                currentHand.push({ type, value: val, char, id: idCounter++, isAgari: false });
                currentHand.sort((a,b) => { if (TYPE_ORDER[a.type] !== TYPE_ORDER[b.type]) return TYPE_ORDER[a.type] - TYPE_ORDER[b.type]; return a.value - b.value; });
                renderHand();
            }
        }
        function renderHand() {
            const c = document.getElementById('hand-container'); c.innerHTML = '';
            currentHand.forEach(t => {
                const d = document.createElement('div'); d.className = `tile ${['tile-man','tile-pin','tile-sou','tile-ji'][TYPE_ORDER[t.type]]}`;
                if (t.isAgari) d.classList.add('agari-tile'); d.textContent = t.char;
                let sy=0, isDrag=false;
                d.addEventListener('touchstart', e=>{ sy=e.touches[0].clientY; isDrag=true; d.style.transition='none'; }, {passive:false});
                d.addEventListener('touchmove', e=>{ if(!isDrag)return; let dy = e.touches[0].clientY - sy; if(dy<0) { e.preventDefault(); d.style.transform=`translateY(${dy}px)`; d.style.opacity = dy<-50?'0.5':'1'; } }, {passive:false});
                d.addEventListener('touchend', e=>{ if(!isDrag)return; isDrag=false; let dy = e.changedTouches[0].clientY - sy; d.style.transition='transform 0.2s, opacity 0.2s'; if(dy < -50) { d.style.transform='translateY(-100px)'; d.style.opacity='0'; setTimeout(()=>{ currentHand = currentHand.filter(x=>x.id!==t.id); renderHand(); }, 200); } else if(Math.abs(dy)<10) { d.style.transform=''; d.style.opacity='1'; currentHand.forEach(x => x.isAgari = (x.id === t.id)); renderHand(); } else { d.style.transform=''; d.style.opacity='1'; } });
                c.appendChild(d);
            });
            for(let i=currentHand.length; i<14; i++){ const d = document.createElement('div'); d.className='tile tile-empty'; c.appendChild(d); }
            // æ‰‹ç‰Œè¿½åŠ æ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å³ç«¯ã¸
            const scrollView = document.getElementById('hand-scroll-view'); scrollView.scrollLeft = scrollView.scrollWidth;
        }
        function clearHand() { currentHand=[]; renderHand(); document.getElementById('result-score').textContent="--- ç‚¹"; lastCalculationResult = null; }

        // --- 4. ã‚«ãƒ¡ãƒ©æ©Ÿèƒ½ï¼ˆãƒ‡ãƒ¢ï¼‰ ---
        let videoStream = null;
        async function openCamera() {
            const modal = document.getElementById('camera-modal'); const video = document.getElementById('camera-video'); modal.classList.add('active');
            try { videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false }); video.srcObject = videoStream; } catch (err) { alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); closeCamera(); }
        }
        function closeCamera() {
            const modal = document.getElementById('camera-modal'); modal.classList.remove('active');
            if (videoStream) { videoStream.getTracks().forEach(track => track.stop()); videoStream = null; }
        }
        function takePhoto() {
            const video = document.getElementById('camera-video'); video.style.opacity = '0.2'; setTimeout(() => { video.style.opacity = '1'; }, 100);
            simulateImageRecognition(); closeCamera();
        }
        function simulateImageRecognition() {
            clearHand();
            const mockTiles = [{t:'man', v:2}, {t:'man', v:3}, {t:'man', v:4}, {t:'pin', v:3}, {t:'pin', v:4}, {t:'pin', v:5}, {t:'sou', v:6}, {t:'sou', v:7}, {t:'sou', v:8}, {t:'sou', v:2}, {t:'sou', v:2}, {t:'sou', v:2}, {t:'man', v:8}, {t:'man', v:8}];
            mockTiles.forEach(item => { addTile(item.t, item.v, TILES[item.t][item.v - 1]); });
            if(currentHand.length>0) { currentHand[currentHand.length-1].isAgari=true; renderHand(); }
            alert("ğŸ“· ãƒ‡ãƒ¢: ãƒ€ãƒŸãƒ¼ã®æ‰‹ç‰Œã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
        }

        // --- 5. è©³ç´°è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ï¼ˆé•·æŠ¼ã—ï¼‰ ---
        let pressTimer;
        function setupLongPress() {
            const target = document.getElementById('score-container');
            target.addEventListener('touchstart', (e) => {
                if (!lastCalculationResult) return;
                target.classList.add('press-active');
                pressTimer = setTimeout(() => { openDetail(lastCalculationResult); target.classList.remove('press-active'); }, 500); // 0.5ç§’é•·æŠ¼ã—
            }, {passive: true});
            ['touchend', 'touchmove', 'touchcancel'].forEach(evt => {
                target.addEventListener(evt, () => { clearTimeout(pressTimer); target.classList.remove('press-active'); }, {passive: true});
            });
        }
        function openDetail(res) {
            if(!res || !res.fuDetails) return;
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('detail-content');
            
            let html = `
                <div class="bg-gray-900/50 p-2 rounded border border-gray-700">
                    <h4 class="font-bold text-yellow-300 mb-1">ğŸ€„ ç¬¦è¨ˆç®—ã®å†…è¨³</h4>
                    <ul class="list-disc list-inside text-gray-300 space-y-1">
            `;
            let totalFuRaw = 0;
            res.fuDetails.forEach(d => {
                html += `<li class="flex justify-between"><span>${d.text}</span><span>+${d.points} ç¬¦</span></li>`;
                totalFuRaw += d.points;
            });
            html += `</ul><div class="border-t border-gray-600 mt-2 pt-1 flex justify-between font-bold"><span>åˆè¨ˆ</span><span>${totalFuRaw} ç¬¦</span></div>`;
            html += `<div class="flex justify-between text-yellow-400 mt-1"><span>åˆ‡ã‚Šä¸Šã’å¾Œ</span><span class="text-lg">${res.fu} ç¬¦</span></div></div>`;

            html += `
                <div class="bg-gray-900/50 p-2 rounded border border-gray-700 flex justify-between items-center">
                    <span class="font-bold text-yellow-300">ğŸ€… é£œæ•°</span>
                    <span class="text-lg font-bold">${res.han} é£œ</span>
                </div>
                <div class="text-center text-gray-400 text-xs mt-2">
                    åŸºæœ¬ç‚¹ = ç¬¦ Ã— 2^(é£œæ•°+2)<br>
                    (æº€è²«ä»¥ä¸Šã¯å›ºå®šç‚¹)
                </div>
            `;
            content.innerHTML = html;
            modal.classList.add('active');
        }
        function closeDetail() { document.getElementById('detail-modal').classList.remove('active'); }

        // --- 6. è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãƒ»ã‚³ã‚¢ (è©³ç´°è¨˜éŒ²ã«å¯¾å¿œã—ã¦æ‹¡å¼µ) ---
        function calculateFull() {
            const resScore = document.getElementById('result-score'); const resYaku = document.getElementById('result-yaku');
            if (currentHand.length !== 14) { resScore.textContent = "æšæ•°ä¸è¶³"; resYaku.textContent = "ç‰Œã¯14æšå¿…è¦ã§ã™"; lastCalculationResult = null; return; }
            const agariTileData = currentHand.find(t => t.isAgari);
            if (!agariTileData) { resScore.textContent = "æŒ‡å®šãªã—"; resYaku.textContent = "ä¸ŠãŒã‚Šç‰Œã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„"; lastCalculationResult = null; return; }
            // ä¸ŠãŒã‚Šç‰Œã®æ–‡å­—åˆ—å®šç¾©ã‚’ä½œæˆ (ä¾‹: 'man1')
            const agariTileStr = agariTileData.type + agariTileData.value;

            const counts = {}; currentHand.forEach(t => { const k = t.type + t.value; counts[k] = (counts[k]||0) + 1; });
            const pairs = Object.values(counts).filter(c => c === 2).length;
            if (pairs === 7) {
                const res = calcChiitoiResult(counts);
                displayResult(res, resScore, resYaku); lastCalculationResult = res; return;
            }
            const decompositions = decompose(counts);
            if (decompositions.length === 0) {
                if (isKokushi(counts)) {
                    const score = settings.seat===0 ? 48000 : 32000;
                    resScore.textContent = `${score}ç‚¹`; resYaku.textContent = "å½¹æº€ å›½å£«ç„¡åŒ";
                    lastCalculationResult = { han:13, fu:0, score: score+settings.honba*300, yakuNames:["å›½å£«ç„¡åŒ"], fuDetails:[] }; return;
                }
                resScore.textContent = "å½¹ãªã—"; resYaku.textContent = "ã‚¢ã‚¬ãƒªå½¢ã«ãªã£ã¦ã„ã¾ã›ã‚“"; lastCalculationResult = null; return;
            }
            let bestResult = { han: 0, fu: 0, score: 0, yakuNames: [], fuDetails: [] };
            decompositions.forEach(groups => {
                const res = evalHand(groups, counts, agariTileStr); // æ–‡å­—åˆ—ã§æ¸¡ã™
                if (res.score > bestResult.score) bestResult = res;
            });
            if (bestResult.han === 0) { resScore.textContent = "å½¹ãªã—"; resYaku.textContent = "ã‚¢ã‚¬ãƒªå½¢ã§ã™ãŒå½¹ãŒã‚ã‚Šã¾ã›ã‚“"; lastCalculationResult = null; }
            else { displayResult(bestResult, resScore, resYaku); lastCalculationResult = bestResult; }
        }

        // ... (decompose, decomposeMentsu, isKokushi ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥ã€‚å‰ã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãã®ã¾ã¾ç¶­æŒã—ã¦ãã ã•ã„) ...
        function decompose(counts) { const results = []; const keys = Object.keys(counts); keys.forEach(headKey => { if (counts[headKey] >= 2) { const workingCounts = {...counts}; workingCounts[headKey] -= 2; const headGroup = { type: 'head', tile: headKey }; const mentsuRes = decomposeMentsu(workingCounts); mentsuRes.forEach(mList => { results.push([headGroup, ...mList]); }); } }); return results; }
        function decomposeMentsu(c) { let first = null; const keys = ['man','pin','sou','ji']; for(let t of keys) { const limit = t==='ji'?7:9; for(let v=1; v<=limit; v++) { if (c[t+v] > 0) { first = t+v; break; } } if(first) break; } if (!first) return [[]]; const results = []; const type = first.substring(0, first.length-1); const val = parseInt(first.substring(first.length-1)); if (c[first] >= 3) { const nextC = {...c}; nextC[first] -= 3; const tails = decomposeMentsu(nextC); tails.forEach(t => { results.push([{type:'koutsu', tile:first}, ...t]); }); } if (type !== 'ji' && val <= 7) { const k1 = type + val; const k2 = type + (val+1); const k3 = type + (val+2); if (c[k1]>0 && c[k2]>0 && c[k3]>0) { const nextC = {...c}; nextC[k1]--; nextC[k2]--; nextC[k3]--; const tails = decomposeMentsu(nextC); tails.forEach(t => { results.push([{type:'shuntsu', tile:k1}, ...t]); }); } } return results; }
        function isKokushi(c) { const yaochu = ['man1','man9','pin1','pin9','sou1','sou9','ji1','ji2','ji3','ji4','ji5','ji6','ji7']; const keys = Object.keys(c); if(keys.length !== 13) return false; return keys.every(k => yaochu.includes(k)); }

        // --- ç¬¦è¨ˆç®—ã®è©³ç´°è¨˜éŒ²æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸ evalHand ---
        function evalHand(groups, counts, agariTileStr) {
            let han = 0; let yaku = []; let fuDetails = [];
            if (settings.reach === 1) { han+=1; yaku.push("ç«‹ç›´(1)"); } if (settings.reach === 2) { han+=2; yaku.push("Wç«‹ç›´(2)"); }
            if (settings.winType === 'tsumo') { han+=1; yaku.push("é–€å‰æ¸…è‡ªæ‘¸(1)"); }
            if (settings.dora > 0) { han+=settings.dora; yaku.push(`ãƒ‰ãƒ©(${settings.dora})`); }
            
            const head = groups.find(g => g.type === 'head'); const mentsu = groups.filter(g => g.type !== 'head');
            const shuntsu = mentsu.filter(g => g.type === 'shuntsu'); const koutsu = mentsu.filter(g => g.type === 'koutsu');

            // (å½¹åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            const isTanyao = Object.keys(counts).every(k => { const t = k.slice(0,-1), v=parseInt(k.slice(-1)); return t!=='ji' && v>1 && v<9; }); if (isTanyao) { han+=1; yaku.push("æ–­å¹ºä¹(1)"); }
            let yakuhaiHan = 0; koutsu.forEach(k => { if (k.tile === 'ji5' || k.tile === 'ji6' || k.tile === 'ji7') yakuhaiHan++; if (k.tile === `ji${settings.prevalent+1}`) yakuhaiHan++; if (k.tile === `ji${settings.seat+1}`) yakuhaiHan++; }); if (yakuhaiHan>0) { han+=yakuhaiHan; yaku.push(`å½¹ç‰Œ(${yakuhaiHan})`); }
            const headVal = parseInt(head.tile.slice(-1)); const headType = head.tile.slice(0,-1); const isHeadYakuhai = (headType==='ji' && (headVal>=5 || headVal===settings.prevalent+1 || headVal===settings.seat+1));
            const isPinfu = (shuntsu.length === 4 && !isHeadYakuhai); if (isPinfu) { han+=1; yaku.push("å¹³å’Œ(1)"); }
            let iipeiko = 0; const seqStr = shuntsu.map(s => s.tile).sort(); for(let i=0; i<seqStr.length-1; i++) { if(seqStr[i] === seqStr[i+1]) { iipeiko++; i++; } } if(iipeiko === 1) { han+=1; yaku.push("ä¸€ç›ƒå£(1)"); } if(iipeiko === 2) { han+=3; yaku.push("äºŒç›ƒå£(3)"); }
            const types = new Set(Object.keys(counts).map(k=>k.slice(0,-1))); const hasJi = types.has('ji'); types.delete('ji'); if(types.size === 1) { if(hasJi) { han+=3; yaku.push("æ··ä¸€è‰²(3)"); } else { han+=6; yaku.push("æ¸…ä¸€è‰²(6)"); } }
            if (koutsu.length === 4) { han+=2; yaku.push("å¯¾ã€…å’Œ(2)"); } if (koutsu.length === 3) { han+=2; yaku.push("ä¸‰æš—åˆ»(2)"); } if (koutsu.length === 4) { han+=8; yaku.push("å››æš—åˆ»(å½¹æº€)"); }
            const sMap = {man:[], pin:[], sou:[]}; shuntsu.forEach(s => sMap[s.tile.slice(0,-1)].push(parseInt(s.tile.slice(-1)))); let sanshoku = false; sMap.man.forEach(v => { if(sMap.pin.includes(v) && sMap.sou.includes(v)) sanshoku = true; }); if(sanshoku) { han+=2; yaku.push("ä¸‰è‰²åŒé †(2)"); }
            let ittsu = false; ['man','pin','sou'].forEach(t => { const vals = shuntsu.filter(s=>s.tile.startsWith(t)).map(s=>parseInt(s.tile.slice(-1))); if(vals.includes(1) && vals.includes(4) && vals.includes(7)) ittsu = true; }); if(ittsu) { han+=2; yaku.push("ä¸€æ°—é€šè²«(2)"); }

            // --- ç¬¦è¨ˆç®—ï¼ˆè©³ç´°è¨˜éŒ²ï¼‰ ---
            fuDetails.push({ text: 'å‰¯åº•', points: 20 });
            let fu = 20;
            if (settings.winType === 'ron') { fu += 10; fuDetails.push({ text: 'é–€å‰åŠ ç¬¦', points: 10 }); }
            if (settings.winType === 'tsumo') { fu += 2; fuDetails.push({ text: 'ãƒ„ãƒ¢ç¬¦', points: 2 }); }

            // åˆ»å­ã®ç¬¦ï¼ˆæ˜åˆ»/æš—åˆ»ã®åˆ¤å®šãŒå¿…è¦ã€‚ç°¡æ˜“çš„ã«ã€ãƒ­ãƒ³ä¸ŠãŒã‚Šã§å¯¾è±¡ç‰Œãªã‚‰æ˜åˆ»æ‰±ã„ã¨ã™ã‚‹ï¼‰
            koutsu.forEach(k => {
                const t = k.tile.slice(0,-1), v=parseInt(k.tile.slice(-1));
                const isYaochu = (t==='ji' || v===1 || v===9);
                // ç°¡æ˜“åˆ¤å®šï¼šãƒ­ãƒ³ã‚ãŒã‚Šã§ã€ã‹ã¤ã“ã®åˆ»å­ãŒã‚¢ã‚¬ãƒªç‰Œã¨åŒã˜ãªã‚‰æ˜åˆ»(Min)ã€ãã‚Œä»¥å¤–ã¯æš—åˆ»(An)
                // â€»æœ¬æ¥ã¯é³´ãçŠ¶æ…‹ã®ç®¡ç†ãŒå¿…è¦ã ãŒã€é–€å‰å‰æã‚¢ãƒ—ãƒªã®ãŸã‚ã“ã®æ¨å®šã§é€²ã‚ã‚‹
                const isAnkou = (settings.winType === 'tsumo' || k.tile !== agariTileStr);
                const p = isYaochu ? (isAnkou ? 8 : 4) : (isAnkou ? 4 : 2);
                fu += p;
                fuDetails.push({ text: `${isYaochu?'å¹ºä¹':'ä¸­å¼µ'}${isAnkou?'æš—åˆ»':'æ˜åˆ»'}`, points: p });
            });

            // é›€é ­ã®ç¬¦
            if (isHeadYakuhai) { fu += 2; fuDetails.push({ text: 'å½¹ç‰Œé›€é ­', points: 2 }); }

            // å¾…ã¡ã®ç¬¦ (ç°¡æ˜“åˆ¤å®š: å¹³å’ŒãŒã¤ã‹ãªã„ãªã‚‰æ‚ªå½¢ã¨ã¿ãªã™)
            if (!isPinfu) { fu += 2; fuDetails.push({ text: 'å¾…ã¡(åµŒå¼µ/è¾ºå¼µ/å˜é¨)', points: 2 }); }

            // åˆ‡ã‚Šä¸Šã’å‡¦ç†
            if (isPinfu && settings.winType==='tsumo') { fu = 20; fuDetails = [{ text: 'å¹³å’Œãƒ„ãƒ¢(å›ºå®š)', points: 20 }]; }
            else { fu = Math.ceil(fu/10)*10; }

            return calculateFinalScore(han, fu, yaku, fuDetails);
        }

        // ä¸ƒå¯¾å­ç”¨è¨ˆç®—
        function calcChiitoiResult(counts) {
            let han=2; let yaku=["ä¸ƒå¯¾å­(2)"];
            // ... (å½¹åˆ¤å®šçœç•¥) ...
            if(settings.reach===1) {han++; yaku.push("ç«‹ç›´(1)");} if(settings.reach===2) {han+=2; yaku.push("Wç«‹ç›´(2)");} if(settings.winType==='tsumo') {han++; yaku.push("é–€å‰æ¸…è‡ªæ‘¸(1)");} if(settings.dora>0) {han+=settings.dora; yaku.push(`ãƒ‰ãƒ©(${settings.dora})`);}
            const isTanyao = Object.keys(counts).every(k => { const t = k.slice(0,-1), v=parseInt(k.slice(-1)); return t!=='ji' && v>1 && v<9; }); if (isTanyao) { han++; yaku.push("æ–­å¹ºä¹(1)"); }
            const types = new Set(Object.keys(counts).map(k=>k.slice(0,-1))); const hasJi = types.has('ji'); types.delete('ji'); if(types.size===1) { if(hasJi){han+=3;yaku.push("æ··ä¸€è‰²(3)");} else{han+=6;yaku.push("æ¸…ä¸€è‰²(6)");} }
            // ...
            const fuDetails = [{ text: 'ä¸ƒå¯¾å­(å›ºå®š)', points: 25 }];
            return calculateFinalScore(han, 25, yaku, fuDetails);
        }

        // å…±é€šç‚¹æ•°ç®—å‡º
        function calculateFinalScore(han, fu, yakuNames, fuDetails) {
            let base = fu * Math.pow(2, han+2);
            if(han>=5) base=2000; if(han>=6) base=3000; if(han>=8) base=4000; if(han>=11) base=6000; if(han>=13) base=8000;
            let score=0;
            if(settings.seat===0){ score = settings.winType==='ron' ? Math.ceil((base*6)/100)*100 : Math.ceil((base*2)/100)*100 * 3; }
            else { score = settings.winType==='ron' ? Math.ceil((base*4)/100)*100 : Math.ceil((base*2)/100)*100 + Math.ceil((base*1)/100)*100*2; }
            score += settings.honba * 300;
            return { han, fu, score, yakuNames, fuDetails };
        }

        function displayResult(res, elScore, elYaku) {
            elScore.textContent = `${res.score}ç‚¹`;
            elYaku.textContent = `${res.han}é£œ ${res.fu}ç¬¦\n${res.yakuNames.join(' ')}`;
        }

        init();
    </script>
</body>
</html>