<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="éº»é›€è¨ˆç®—">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a202c">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text x=%2250%%22 y=%2250%%22 style=%22dominant-baseline:central;text-anchor:middle;font-size:90px;%22>ğŸ€„</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%231a202c%22/><text x=%2250%%22 y=%2250%%22 style=%22dominant-baseline:central;text-anchor:middle;font-size:75px;%22>ğŸ€„</text></svg>">

    <title>éº»é›€ç‚¹æ•°è¨ˆç®—æ©Ÿ Pro v2.8.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        tailwind.config = { theme: { extend: { screens: { 'landscape': {'raw': '(orientation: landscape)'}, 'portrait': {'raw': '(orientation: portrait)'} } } } }
    </script>
    <style>
        html { background-color: #1a202c; }
        body { font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; background-color: #1a202c; color: white; height: 100vh; height: 100dvh; overflow: hidden; user-select: none; touch-action: manipulation; margin: 0; padding: 0; }
        #app-container { max-width: 1024px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; }
        
        .tile { width: 2.6rem; height: 3.6rem; display: flex; align-items: center; justify-content: center; background-color: #f7fafc; border-radius: 0.25rem; font-size: 2rem; line-height: 1; box-shadow: 0 3px 5px rgba(0,0,0,0.4); cursor: pointer; position: relative; transition: transform 0.1s; touch-action: pan-x; color: #333; flex-shrink: 0; }
        @media (orientation: portrait) { .tile { width: 2.2rem; height: 3.1rem; font-size: 1.7rem; } .palette-tile { font-size: 1.8rem !important; height: 2.8rem !important; } }
        .tile-man { color: #c53030; } .tile-pin { color: #2b6cb0; } .tile-sou { color: #2f855a; } .tile-ji { color: #000; }
        .tile-empty { background-color: transparent; border: 2px dashed #4a5568; box-shadow: none; color: transparent; }
        .agari-tile { border: 3px solid #ecc94b; transform: translateY(-4px); z-index: 10; }
        .agari-tile::after { content: 'å’Œ'; position: absolute; top: -10px; right: -8px; background-color: #e53e3e; color: white; font-size: 0.6rem; width: 1.2rem; height: 1.2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid white; font-weight: bold; }
        .palette-tile { width: 100%; height: 3.2rem; display: flex; align-items: center; justify-content: center; background-color: #f7fafc; border-radius: 0.25rem; font-size: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #hand-scroll-view { scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.4) transparent; }
        #hand-scroll-view::-webkit-scrollbar { height: 6px; } #hand-scroll-view::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.15); border-radius: 10px; } #hand-scroll-view::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.5); border-radius: 10px; }
        .modal-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); z-index: 50; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .press-active { transform: scale(0.98); transition: transform 0.1s; }
        .snap-x-mandatory { scroll-snap-type: x mandatory; } .snap-center { scroll-snap-align: center; }
        .btn-select.active { background-color: #ecc94b; color: #1a202c; border-color: #d69e2e; }
        .sortable-ghost { opacity: 0.4; background-color: #2d3748; border-radius: 0.5rem; }

        .entrance-tile-anim { animation: tileDrop 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes tileDrop { to { opacity: 1; transform: translateY(0) scale(1); } }

        /* â˜…å¤‰æ›´: æ¨ªç”»é¢ã§ã‚‚å¹…ã„ã£ã±ã„ã«ã—ã¤ã¤ã€ç¶ºéº—ãªæ¥•å††å½¢ã§ã¼ã‹ã™ */
        .title-img-layer {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* å¸¸ã«ç”»é¢å¹…ã„ã£ã±ã„ã«åºƒã’ã‚‹ */
            mask-image: radial-gradient(circle at center, black 30%, transparent 85%);
            -webkit-mask-image: radial-gradient(circle at center, black 30%, transparent 85%);
            transition: opacity 1.5s ease-in-out;
        }
        @media (orientation: landscape) {
            .title-img-layer {
                /* æ¨ªç”»é¢å°‚ç”¨ã®ãƒã‚¹ã‚¯: å·¦å³ã¯åºƒãã€ä¸Šä¸‹ã¯æ—©ãé€æ˜ã«ãªã‚‹æ¥•å††å½¢ */
                mask-image: radial-gradient(ellipse 60% 80% at center, black 20%, transparent 100%);
                -webkit-mask-image: radial-gradient(ellipse 60% 80% at center, black 20%, transparent 100%);
            }
        }
    </style>
</head>
<body>

<div id="entrance-screen" class="fixed inset-0 z-[100] bg-[#1a202c] flex flex-col transition-opacity duration-700 ease-in-out">
    
    <div class="absolute top-[max(16px,env(safe-area-inset-top))] right-4 flex items-center gap-1.5 bg-gray-800/80 pl-3 pr-2 py-1.5 rounded-full border border-gray-600 shadow-lg z-10">
        <span class="text-[10px] text-gray-400 font-bold">Name:</span>
        <span id="entrance-username-display" class="text-sm text-white font-bold max-w-[80px] truncate">ã‚²ã‚¹ãƒˆ</span>
        <button onclick="editUsername()" class="text-sm bg-gray-700 hover:bg-gray-600 w-6 h-6 rounded-full flex items-center justify-center transition-transform active:scale-90 ml-1">âœï¸</button>
    </div>

    <div class="flex-[3] landscape:flex-[4] flex items-center justify-center relative overflow-hidden mt-10 landscape:mt-[max(16px,env(safe-area-inset-top))] w-full landscape:mb-4">
        <div class="w-full h-full relative flex items-center justify-center">
            <img id="bg-img-0" src="image1.jpg?v=2" alt="Title Image 1" class="title-img-layer opacity-100">
            <img id="bg-img-1" src="image2.jpg?v=2" alt="Title Image 2" class="title-img-layer opacity-0">
            <img id="bg-img-2" src="image3.jpg?v=2" alt="Title Image 3" class="title-img-layer opacity-0">
        </div>
    </div>
    
    <div class="flex-1 flex flex-col items-center justify-center landscape:justify-end gap-3 relative shrink-0 z-10 landscape:mb-2">
        <button id="btn-entrance" onclick="startEntrance()" class="w-56 h-7 bg-gradient-to-b from-[#fefcf6] to-[#e6e1d6] rounded-sm shadow-[0_5px_15px_rgba(0,0,0,0.8)] border border-[#c4bcac] flex items-center justify-center relative transition-transform active:scale-95 cursor-pointer">
            <div class="w-2.5 h-2.5 bg-red-600 rounded-full shadow-inner"></div>
            <div class="absolute left-3 w-0.5 h-full bg-black/20"></div>
            <div class="absolute left-5 w-0.5 h-full bg-black/20"></div>
            <div class="absolute right-3 w-0.5 h-full bg-black/20"></div>
            <div class="absolute right-5 w-0.5 h-full bg-black/20"></div>
        </button>
        <div class="text-[10px] text-yellow-500 font-bold tracking-[0.4em] animate-pulse pointer-events-none mt-1">TAP TO ENTER</div>
    </div>

    <div class="flex-1 flex flex-col justify-end w-full pb-[max(35px,env(safe-area-inset-bottom)+20px)] landscape:pb-[max(25px,env(safe-area-inset-bottom)+10px)] px-2 shrink-0 z-10">
        <div id="entrance-tiles-container" class="flex gap-0.5 landscape:gap-1 flex-nowrap justify-center w-full"></div>
    </div>
</div>

<div id="app-container" class="hidden pt-[max(8px,env(safe-area-inset-top))] pl-[max(8px,env(safe-area-inset-left))] pr-[max(8px,env(safe-area-inset-right))] flex-col h-full">

    <div class="flex-1 min-h-0 flex flex-col landscape:grid landscape:grid-cols-10 landscape:grid-rows-[auto_1fr] gap-2 p-2 pt-1 landscape:pt-2">

        <div class="order-1 landscape:order-none flex gap-1.5 landscape:gap-2 items-stretch w-full landscape:col-span-7 landscape:col-start-4 landscape:row-start-1 shrink-0 h-12">
            
            <button id="btn-header-action" onclick="handleHeaderAction()" class="w-12 h-12 bg-indigo-700 hover:bg-indigo-600 text-white font-bold rounded shadow transition-colors border border-indigo-500 flex flex-col items-center justify-center active:scale-95 shrink-0">
                <span id="btn-header-icon" class="text-lg leading-none mb-0.5">ğŸ®</span>
                <span id="btn-header-text" class="text-[9px] leading-none whitespace-nowrap">å±€é–‹å§‹</span>
            </button>

            <div id="local-header" class="flex-1 bg-gray-800 rounded border border-gray-700 px-3 flex items-center justify-center shadow-inner overflow-hidden h-full">
                <span class="text-[10px] text-gray-400 font-bold mr-2">Player:</span>
                <span id="local-username-display" class="text-sm font-bold text-white truncate max-w-[120px]">ã‚²ã‚¹ãƒˆ</span>
            </div>

            <div id="scoreboard" class="hidden flex-1 bg-gray-900 rounded border border-gray-700 px-2 py-1 items-center shadow-inner overflow-hidden h-full">
                <div class="flex flex-col items-start justify-center shrink-0 pr-2 border-r border-gray-700 h-full">
                    <div class="flex items-center gap-1 mb-1">
                        <span class="text-[9px] text-gray-400 font-mono leading-none">ID:</span>
                        <span id="room-id-display" class="text-[10px] text-white font-bold leading-none">----</span>
                        <span id="room-type-display" class="text-[8px] text-gray-500 leading-none"></span>
                    </div>
                    <span id="game-status-display" class="text-[10px] text-yellow-300 font-bold leading-none whitespace-nowrap">æ±1å±€ 0æœ¬å ´</span>
                </div>
                
                <div id="player-grid" class="flex flex-nowrap gap-1.5 items-center w-full overflow-x-auto no-scrollbar pl-2 h-full">
                    <div id="player-box-0" class="flex flex-col items-center bg-gray-800/80 px-1 py-0.5 rounded cursor-move active:bg-gray-700 transition-colors shrink-0 w-16 border border-transparent">
                        <span class="text-[7px] text-gray-500 leading-none mb-0.5 pointer-events-none">â£¿</span>
                        <span id="name-0" class="text-[9px] text-gray-300 leading-none mb-1 pointer-events-none w-full truncate text-center">Aã•ã‚“</span>
                        <span id="score-0" class="text-red-400 font-bold text-[12px] leading-none pointer-events-none">25000</span>
                    </div>
                    <div id="player-box-1" class="flex flex-col items-center bg-gray-800/80 px-1 py-0.5 rounded cursor-move active:bg-gray-700 transition-colors shrink-0 w-16 border border-transparent">
                        <span class="text-[7px] text-gray-500 leading-none mb-0.5 pointer-events-none">â£¿</span>
                        <span id="name-1" class="text-[9px] text-gray-300 leading-none mb-1 pointer-events-none w-full truncate text-center">Bã•ã‚“</span>
                        <span id="score-1" class="text-blue-400 font-bold text-[12px] leading-none pointer-events-none">25000</span>
                    </div>
                    <div id="player-box-2" class="flex flex-col items-center bg-gray-800/80 px-1 py-0.5 rounded cursor-move active:bg-gray-700 transition-colors shrink-0 w-16 border border-transparent">
                        <span class="text-[7px] text-gray-500 leading-none mb-0.5 pointer-events-none">â£¿</span>
                        <span id="name-2" class="text-[9px] text-gray-300 leading-none mb-1 pointer-events-none w-full truncate text-center">Cã•ã‚“</span>
                        <span id="score-2" class="text-green-400 font-bold text-[12px] leading-none pointer-events-none">25000</span>
                    </div>
                    <div id="player-box-3" class="flex flex-col items-center bg-gray-800/80 px-1 py-0.5 rounded cursor-move active:bg-gray-700 transition-colors shrink-0 w-16 border border-transparent">
                        <span class="text-[7px] text-gray-500 leading-none mb-0.5 pointer-events-none">â£¿</span>
                        <span id="name-3" class="text-[9px] text-gray-300 leading-none mb-1 pointer-events-none w-full truncate text-center">Dã•ã‚“</span>
                        <span id="score-3" class="text-yellow-400 font-bold text-[12px] leading-none pointer-events-none">25000</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-center justify-center gap-0.5 shrink-0 px-1 w-[3.5rem] bg-gray-800 rounded border border-gray-700 h-full shadow-inner">
                <div class="flex gap-2">
                    <button onclick="openRulebook()" class="text-base hover:scale-110 transition-transform leading-none mt-0.5" title="ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª">ğŸ“–</button>
                    <button onclick="returnToEntrance()" class="text-base hover:scale-110 transition-transform leading-none mt-0.5" title="ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ã¸æˆ»ã‚‹">ğŸ </button>
                </div>
                <span class="text-[8px] text-gray-500 font-mono leading-none mt-1">v2.8.8</span>
            </div>
        </div>

        <div class="order-2 landscape:order-none bg-gray-800 rounded-lg p-2 flex flex-col gap-1.5 shadow-lg overflow-y-auto no-scrollbar border border-gray-700 w-full landscape:col-span-3 landscape:col-start-1 landscape:row-start-1 landscape:row-span-2 min-h-0">
            <div class="grid grid-cols-2 gap-1.5 mt-1">
                <button id="btn-prevalent" class="bg-gray-700 py-1.5 portrait:py-1 rounded text-xs font-bold border border-gray-600 transition-all leading-tight" onclick="togglePrevalent()">æ±å ´</button>
                <button id="btn-seat" class="bg-red-900 py-1.5 portrait:py-1 rounded text-xs font-bold border border-red-700 transition-all leading-tight" onclick="toggleSeat()">æ±å®¶(è¦ª)</button>
            </div>
            <div class="grid grid-cols-2 gap-1.5">
                <button id="btn-win-type" class="bg-red-800 py-1.5 portrait:py-1 rounded text-xs font-bold border border-red-600 transition-all leading-tight" onclick="toggleWinType()">ãƒ­ãƒ³ã‚ãŒã‚Š</button>
                <button id="btn-reach" class="bg-gray-700 py-1.5 portrait:py-1 rounded text-xs font-bold border border-gray-600 text-gray-400 transition-all leading-tight" onclick="toggleReach()">ç«‹ç›´ãªã—</button>
            </div>
            
            <div class="flex gap-1.5">
                <div class="flex-1 flex flex-col items-center bg-gray-700 pt-1 pb-1.5 rounded border border-gray-600">
                    <span class="text-[10px] font-bold text-gray-400 leading-none mb-1.5">ãƒ‰ãƒ©</span>
                    <div class="flex items-center gap-2 w-full justify-center">
                        <button class="w-7 h-5 bg-gray-600 rounded flex items-center justify-center text-xs font-bold active:bg-gray-500" onclick="updCnt('dora',-1)">-</button>
                        <span id="dora-disp" class="font-mono text-sm w-4 text-center text-yellow-400 leading-none">0</span>
                        <button class="w-7 h-5 bg-gray-600 rounded flex items-center justify-center text-xs font-bold active:bg-gray-500" onclick="updCnt('dora',1)">+</button>
                    </div>
                </div>
                <div class="flex-1 flex flex-col items-center bg-gray-700 pt-1 pb-1.5 rounded border border-gray-600">
                    <span class="text-[10px] font-bold text-gray-400 leading-none mb-1.5">æœ¬å ´</span>
                    <div class="flex items-center gap-2 w-full justify-center">
                        <button class="w-7 h-5 bg-gray-600 rounded flex items-center justify-center text-xs font-bold active:bg-gray-500" onclick="updCnt('honba',-1)">-</button>
                        <span id="honba-disp" class="font-mono text-sm w-4 text-center leading-none">0</span>
                        <button class="w-7 h-5 bg-gray-600 rounded flex items-center justify-center text-xs font-bold active:bg-gray-500" onclick="updCnt('honba',1)">+</button>
                    </div>
                </div>
            </div>

            <div id="score-container" onclick="openDetailBtn(event)" class="mt-auto bg-gray-900 p-2 rounded border border-gray-700 flex flex-col justify-center min-h-[4rem] landscape:min-h-[5.5rem] cursor-pointer transition-colors active:bg-gray-800 relative">
                <div id="result-score" class="text-center text-2xl landscape:text-3xl font-bold text-yellow-400">--- ç‚¹</div>
                <div id="result-yaku" class="text-center text-[10px] landscape:text-[11px] text-gray-300 mt-1 leading-tight whitespace-pre-wrap">å½¹ãªã—</div>
                <div class="text-center text-[8px] text-gray-500 mt-0.5">â€»ã‚¿ãƒƒãƒ—ã§è©³ç´°ã‚’è¡¨ç¤º</div>
            </div>
        </div>

        <div class="order-3 landscape:order-none bg-gray-800 rounded-lg p-2 flex flex-col shadow-lg border border-gray-700 w-full landscape:col-span-7 landscape:col-start-4 landscape:row-start-2 min-h-0">
            <div class="flex gap-1 mb-1.5 shrink-0">
                <button onclick="renderPalette('man')" class="flex-1 py-1.5 rounded-t bg-blue-600 text-white text-xs font-bold tab-btn" data-type="man">è¬å­</button>
                <button onclick="renderPalette('pin')" class="flex-1 py-1.5 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn" data-type="pin">ç­’å­</button>
                <button onclick="renderPalette('sou')" class="flex-1 py-1.5 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn" data-type="sou">ç´¢å­</button>
                <button onclick="renderPalette('ji')" class="flex-1 py-1.5 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn" data-type="ji">å­—ç‰Œ</button>
            </div>
            <div id="tile-container" class="grid grid-cols-9 gap-1 auto-rows-min overflow-y-auto flex-1 content-start p-1 bg-gray-900 rounded inner-shadow mb-2"></div>
            
            <div class="flex gap-1.5 shrink-0 w-full">
                <button onclick="openCamera()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 portrait:py-2.5 rounded font-bold text-sm shadow flex items-center justify-center gap-1 border border-blue-400 active:scale-95 transition-transform">ğŸ“· æ’®å½±</button>
                <button onclick="clearHand()" class="flex-1 bg-red-800 hover:bg-red-700 text-white py-2 portrait:py-2.5 rounded font-bold text-sm shadow border border-red-700 active:scale-95 transition-transform">ã‚¯ãƒªã‚¢</button>
                <button id="btn-calc" onclick="calculateFull()" class="flex-[2] bg-yellow-600 hover:bg-yellow-500 text-white py-2 portrait:py-2.5 rounded font-bold text-base shadow border border-yellow-400 active:scale-95 transition-transform">è¨ˆç®—ã™ã‚‹</button>
                <button id="btn-recalc" onclick="calculateFull()" class="hidden flex-[2] bg-yellow-600 hover:bg-yellow-500 text-white py-2 portrait:py-2.5 rounded font-bold text-base shadow border border-yellow-400 active:scale-95 transition-transform">å†è¨ˆç®—</button>
                <button id="btn-transfer" onclick="openTransferModal(event)" class="hidden flex-1 bg-green-600 hover:bg-green-500 text-white py-2 portrait:py-2.5 rounded font-bold text-base shadow border border-green-400 active:scale-95 transition-transform">ğŸ’° é€ä¿¡</button>
            </div>
        </div>
    </div>

    <div class="shrink-0 w-full bg-green-900 border-t-4 border-green-950 shadow-[0_-4px_10px_rgba(0,0,0,0.3)] relative flex flex-col justify-center pt-2 pb-[max(12px,env(safe-area-inset-bottom))] pl-[max(8px,env(safe-area-inset-left))] pr-[max(8px,env(safe-area-inset-right))] z-20">
        <div class="text-[9px] text-green-200 opacity-80 font-mono absolute top-0.5 left-[max(12px,env(safe-area-inset-left))] pointer-events-none">TAP:ä¸ŠãŒã‚Šç‰Œ / UP-FLICK:å‰Šé™¤ <span class="portrait:inline hidden">/ å·¦å³:ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</span></div>
        <div id="hand-scroll-view" class="w-full overflow-x-auto flex items-center landscape:justify-center mt-2 z-10">
            <div id="hand-container" class="flex gap-0.5 landscape:gap-1 px-2 pt-4 pb-2 flex-nowrap min-w-max"></div>
        </div>
    </div>
</div>

    <div id="room-modal" class="modal-overlay" onclick="closeRoomModal()">
        <div class="bg-gray-800 w-11/12 max-w-sm landscape:max-w-2xl rounded-lg p-4 landscape:p-5 shadow-xl border border-gray-700 relative max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <button onclick="closeRoomModal()" class="absolute top-2 right-2 text-gray-400 hover:text-white bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center z-20">âœ•</button>
            <h3 class="text-lg landscape:text-base font-bold text-indigo-400 mb-4 text-center border-b border-gray-700 pb-2">ğŸ® å±€ã®é–‹å§‹</h3>
            
            <div class="flex flex-col landscape:flex-row gap-3">
                <div class="flex-1 border border-gray-600 p-3 landscape:p-2 rounded-lg bg-gray-700/50 relative overflow-hidden flex flex-col justify-between">
                    <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                    <div>
                        <div class="text-xs landscape:text-[10px] text-indigo-300 font-bold mb-2 pl-2">â–¼ æ–°ã—ãå“ã‚’ä½œã‚‹å ´åˆ</div>
                        <div class="flex gap-2 mb-3 landscape:mb-2 pl-2">
                            <button id="btn-tonpu" onclick="setGameType('tonpu')" class="btn-select flex-1 py-1.5 bg-gray-800 text-gray-300 rounded border border-gray-600 text-xs font-bold active">æ±é¢¨æˆ¦</button>
                            <button id="btn-hanchan" onclick="setGameType('hanchan')" class="btn-select flex-1 py-1.5 bg-gray-800 text-gray-300 rounded border border-gray-600 text-xs font-bold">åŠè˜æˆ¦</button>
                        </div>
                    </div>
                    <div class="pl-2 mt-auto">
                        <button onclick="window.createRoomFromModal()" class="w-full bg-indigo-700 hover:bg-indigo-600 text-white text-sm landscape:text-xs font-bold py-2 rounded shadow border border-indigo-500 transition-transform active:scale-95">ğŸŒ å“ã‚’ä½œæˆã—ã¦å…¥å®¤</button>
                    </div>
                </div>

                <div class="flex-1 border border-gray-600 p-3 landscape:p-2 rounded-lg bg-gray-700/50 relative overflow-hidden flex flex-col justify-between">
                    <div class="absolute top-0 left-0 w-1 h-full bg-green-500"></div>
                    <div class="text-xs landscape:text-[10px] text-green-300 font-bold mb-2 pl-2">â–¼ ä½œã‚‰ã‚ŒãŸå“ã«å…¥ã‚‹å ´åˆ</div>
                    <div class="pl-2 mt-auto">
                        <button onclick="window.joinRoomFromModal()" class="w-full bg-green-700 hover:bg-green-600 text-white text-sm landscape:text-xs font-bold py-2 rounded shadow border border-green-500 transition-transform active:scale-95">ğŸšª IDã‚’å…¥åŠ›ã—ã¦å‚åŠ </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="rule-modal" class="modal-overlay" onclick="closeRulebook()">
        <div class="bg-gray-800 w-11/12 max-w-md rounded-lg p-3 shadow-xl border border-gray-700 relative max-h-[85vh] flex flex-col" onclick="event.stopPropagation()">
            <button onclick="closeRulebook()" class="absolute top-2 right-2 text-gray-400 hover:text-white bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center z-20">âœ•</button>
            <h3 class="text-base font-bold text-yellow-400 mb-2 text-center border-b border-gray-700 pb-2 shrink-0">ğŸ“– å½¹ãƒ»ç¬¦è¨ˆç®—ãƒ«ãƒ¼ãƒ«</h3>
            
            <div class="flex-1 overflow-x-auto overflow-y-hidden snap-x-mandatory flex no-scrollbar" id="rule-scroll-container" onscroll="updateRuleDots()">
                
                <div class="w-full shrink-0 snap-center overflow-y-auto px-2 max-h-full pb-4">
                    <h4 class="text-sm font-bold text-white bg-blue-900 px-2 py-1 rounded border border-blue-700 sticky top-0">ğŸ€„ å½¹ã®é£œæ•°ä¸€è¦§è¡¨</h4>
                    <div class="mt-2"><div class="text-xs font-bold text-yellow-300 mb-1 border-b border-gray-600">1é£œ</div><div class="text-[11px] text-gray-300 grid grid-cols-2 gap-x-1 gap-y-0.5 mb-2"><span>ç«‹ç›´ (ãƒªãƒ¼ãƒ)</span><span>ä¸€ç™º</span><span>é–€å‰æ¸…è‡ªæ‘¸å’Œ (ãƒ„ãƒ¢)</span><span>æ–­å¹ºä¹ (ã‚¿ãƒ³ãƒ¤ã‚ª)</span><span>å¹³å’Œ (ãƒ”ãƒ³ãƒ•)</span><span>ä¸€ç›ƒå£ (ã‚¤ãƒ¼ãƒšãƒ¼ã‚³ãƒ¼)</span><span>å½¹ç‰Œ (ç™½/ç™¼/ä¸­/å ´é¢¨/è‡ªé¢¨)</span><span>å¶ºä¸Šé–‹èŠ± / æ§æ§“</span><span>æµ·åº•æ’ˆæœˆ / æ²³åº•æ’ˆé­š</span></div><div class="text-xs font-bold text-yellow-300 mb-1 border-b border-gray-600">2é£œ</div><div class="text-[11px] text-gray-300 grid grid-cols-2 gap-x-1 gap-y-0.5 mb-2"><span>ä¸‰è‰²åŒé † <span class="text-gray-500">(é³´1)</span></span><span>ä¸€æ°—é€šè²« <span class="text-gray-500">(é³´1)</span></span><span>æ··å…¨å¸¯å¹ºä¹ <span class="text-gray-500">(é³´1)</span></span><span>ä¸ƒå¯¾å­ (ãƒãƒ¼ãƒˆã‚¤ãƒ„)</span><span>å¯¾ã€…å’Œ (ãƒˆã‚¤ãƒˆã‚¤)</span><span>ä¸‰æš—åˆ» (ã‚µãƒ³ã‚¢ãƒ³ã‚³ã‚¦)</span><span>ä¸‰è‰²åŒåˆ»</span><span>ä¸‰æ§“å­</span><span>å°ä¸‰å…ƒ</span><span>ãƒ€ãƒ–ãƒ«ç«‹ç›´</span></div><div class="text-xs font-bold text-yellow-300 mb-1 border-b border-gray-600">3é£œ</div><div class="text-[11px] text-gray-300 grid grid-cols-2 gap-x-1 gap-y-0.5 mb-2"><span>æ··ä¸€è‰² <span class="text-gray-500">(é³´2)</span></span><span>ç´”å…¨å¸¯å¹ºä¹ <span class="text-gray-500">(é³´2)</span></span><span>äºŒç›ƒå£ (ãƒªãƒ£ãƒ³ãƒšãƒ¼ã‚³ãƒ¼)</span></div><div class="text-xs font-bold text-yellow-300 mb-1 border-b border-gray-600">6é£œ</div><div class="text-[11px] text-gray-300 grid grid-cols-2 gap-x-1 gap-y-0.5 mb-2"><span>æ¸…ä¸€è‰² (ãƒãƒ³ã‚¤ãƒ„) <span class="text-gray-500">(é³´5)</span></span></div><div class="text-xs font-bold text-red-400 mb-1 border-b border-gray-600">å½¹æº€</div><div class="text-[10px] text-gray-300 grid grid-cols-2 gap-x-1 gap-y-0.5"><span>å›½å£«ç„¡åŒ / å››æš—åˆ»</span><span>å¤§ä¸‰å…ƒ / å­—ä¸€è‰²</span><span>å°å››å–œ / å¤§å››å–œ</span><span>ç·‘ä¸€è‰² / æ¸…è€é ­</span><span>ä¹è“®å®ç‡ˆ / å››æ§“å­</span><span>å¤©å’Œ / åœ°å’Œ</span></div></div>
                </div>
                
                <div class="w-full shrink-0 snap-center overflow-y-auto px-2 max-h-full pb-4">
                    <h4 class="text-sm font-bold text-white bg-green-900 px-2 py-1 rounded border border-green-700 sticky top-0">ğŸ§® ç¬¦è¨ˆç®—ã®ãƒ«ãƒ¼ãƒ«</h4>
                    <div class="mt-2 space-y-2"><div class="bg-gray-700/50 p-1.5 rounded"><div class="text-xs font-bold text-yellow-300">â‘  åŸºæœ¬ç¬¦ (å‰¯åº•)</div><div class="text-[11px] text-gray-300 pl-2">ä¸€å¾‹ <span class="font-bold text-white">20ç¬¦</span></div></div><div class="bg-gray-700/50 p-1.5 rounded"><div class="text-xs font-bold text-yellow-300">â‘¡ ã‚¢ã‚¬ãƒªæ–¹</div><div class="text-[11px] text-gray-300 pl-2 flex justify-between"><span>é–€å‰ãƒ­ãƒ³: <span class="text-white font-bold">+10ç¬¦</span></span><span>ãƒ„ãƒ¢: <span class="text-white font-bold">+2ç¬¦</span></span></div></div><div class="bg-gray-700/50 p-1.5 rounded"><div class="text-xs font-bold text-yellow-300 mb-1">â‘¢ é¢å­ (ãƒ¡ãƒ³ãƒ„)</div><table class="w-full text-[10px] text-center border-collapse"><tr class="bg-gray-600 text-gray-200"><th class="p-0.5 border border-gray-500">ç¨®é¡</th><th class="p-0.5 border border-gray-500">æ˜åˆ»</th><th class="p-0.5 border border-gray-500">æš—åˆ»</th><th class="p-0.5 border border-gray-500">æ˜æ§“</th><th class="p-0.5 border border-gray-500">æš—æ§“</th></tr><tr class="text-gray-300"><td class="p-0.5 border border-gray-600">ä¸­å¼µç‰Œ<br><span class="text-[8px]">(2ã€œ8)</span></td><td class="border border-gray-600">2</td><td class="border border-gray-600">4</td><td class="border border-gray-600">8</td><td class="border border-gray-600">16</td></tr><tr class="text-gray-300"><td class="p-0.5 border border-gray-600">å¹ºä¹ç‰Œ<br><span class="text-[8px]">(1,9,å­—)</span></td><td class="border border-gray-600">4</td><td class="border border-gray-600">8</td><td class="border border-gray-600">16</td><td class="border border-gray-600">32</td></tr></table><div class="text-[9px] text-gray-400 mt-0.5">â€»é †å­(ã‚·ãƒ¥ãƒ³ãƒ„)ã¯ã™ã¹ã¦0ç¬¦</div></div><div class="bg-gray-700/50 p-1.5 rounded"><div class="text-xs font-bold text-yellow-300">â‘£ é›€é ­ (ã‚¢ã‚¿ãƒ) ã¨ â‘¤ å¾…ã¡</div><div class="text-[11px] text-gray-300 pl-2">å½¹ç‰Œã®é›€é ­: <span class="text-white font-bold">+2ç¬¦</span><br>åµŒå¼µ/è¾ºå¼µ/å˜é¨ å¾…ã¡: <span class="text-white font-bold">+2ç¬¦</span><br><span class="text-[9px] text-gray-400">â€»ä¸¡é¢ãƒ»åŒç¢°å¾…ã¡ã¯0ç¬¦</span></div></div><div class="bg-gray-700/50 p-1.5 rounded border border-red-900/50"><div class="text-xs font-bold text-red-400">â‘¥ ä¾‹å¤–ãƒ«ãƒ¼ãƒ«</div><div class="text-[11px] text-gray-300 pl-2">ä¸ƒå¯¾å­ (ãƒãƒ¼ãƒˆã‚¤ãƒ„): <span class="text-white font-bold">25ç¬¦å›ºå®š</span><br>å¹³å’Œãƒ„ãƒ¢: <span class="text-white font-bold">20ç¬¦å›ºå®š</span></div></div></div>
                </div>
                
                <div class="w-full shrink-0 snap-center overflow-y-auto px-2 max-h-full pb-4">
                    
                    <h4 class="text-sm font-bold text-white bg-blue-900 px-2 py-1 rounded border border-blue-700 sticky top-0 z-10">ğŸ“Š ç‚¹æ•°æ—©è¦‹è¡¨ (å­)</h4>
                    <div class="mt-2 text-[10px] text-gray-300 overflow-x-auto no-scrollbar">
                        <table class="w-full text-center border-collapse mb-4 min-w-[280px]">
                            <tr class="bg-gray-700 text-yellow-300">
                                <th class="p-0.5 border border-gray-600">ç¬¦</th>
                                <th class="p-0.5 border border-gray-600">1é£œ</th>
                                <th class="p-0.5 border border-gray-600">2é£œ</th>
                                <th class="p-0.5 border border-gray-600">3é£œ</th>
                                <th class="p-0.5 border border-gray-600">4é£œ</th>
                            </tr>
                            <tr>
                                <td class="p-0.5 border border-gray-600 font-bold text-white leading-tight">20<br><span class="text-[7px] text-gray-400 font-normal">ãƒ„ãƒ¢ã®ã¿</span></td>
                                <td class="p-0.5 border border-gray-600">-</td>
                                <td class="p-0.5 border border-gray-600 leading-tight">1500<br><span class="text-[7px] text-gray-400">400/700</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">2700<br><span class="text-[7px] text-gray-400">700/1300</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">5200<br><span class="text-[7px] text-gray-400">1300/2600</span></td>
                            </tr>
                            <tr class="bg-gray-800/50">
                                <td class="p-0.5 border border-gray-600 font-bold text-white leading-tight">25<br><span class="text-[7px] text-gray-400 font-normal">ä¸ƒå¯¾å­</span></td>
                                <td class="p-0.5 border border-gray-600">-</td>
                                <td class="p-0.5 border border-gray-600 leading-tight">1600<br><span class="text-[7px] text-gray-400">ãƒ­ãƒ³ã®ã¿</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">3200<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 800/1600</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">6400<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 1600/3200</span></td>
                            </tr>
                            <tr>
                                <td class="p-0.5 border border-gray-600 font-bold text-white leading-tight">30</td>
                                <td class="p-0.5 border border-gray-600 leading-tight">1000<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 300/500</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">2000<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 500/1000</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">3900<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 1000/2000</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">7700<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 2000/3900</span></td>
                            </tr>
                            <tr class="bg-gray-800/50">
                                <td class="p-0.5 border border-gray-600 font-bold text-white leading-tight">40</td>
                                <td class="p-0.5 border border-gray-600 leading-tight">1300<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 400/700</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">2600<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 700/1300</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">5200<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 1300/2600</span></td>
                                <td class="p-0.5 border border-gray-600 text-red-300 font-bold leading-tight">æº€è²«<br><span class="text-[7px] text-gray-400 font-normal">ãƒ„ãƒ¢ 2000/4000</span></td>
                            </tr>
                            <tr>
                                <td class="p-0.5 border border-gray-600 font-bold text-white leading-tight">50</td>
                                <td class="p-0.5 border border-gray-600 leading-tight">1600<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 400/800</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">3200<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 800/1600</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">6400<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 1600/3200</span></td>
                                <td class="p-0.5 border border-gray-600 text-red-300 font-bold leading-tight">æº€è²«<br><span class="text-[7px] text-gray-400 font-normal">ãƒ„ãƒ¢ 2000/4000</span></td>
                            </tr>
                        </table>
                    </div>

                    <h4 class="text-sm font-bold text-white bg-red-900 px-2 py-1 rounded border border-red-700 sticky top-0 z-10">ğŸ“Š ç‚¹æ•°æ—©è¦‹è¡¨ (è¦ª)</h4>
                    <div class="mt-2 text-[10px] text-gray-300 overflow-x-auto no-scrollbar">
                        <table class="w-full text-center border-collapse mb-2 min-w-[280px]">
                            <tr class="bg-gray-700 text-yellow-300">
                                <th class="p-0.5 border border-gray-600">ç¬¦</th>
                                <th class="p-0.5 border border-gray-600">1é£œ</th>
                                <th class="p-0.5 border border-gray-600">2é£œ</th>
                                <th class="p-0.5 border border-gray-600">3é£œ</th>
                                <th class="p-0.5 border border-gray-600">4é£œ</th>
                            </tr>
                            <tr>
                                <td class="p-0.5 border border-gray-600 font-bold text-white leading-tight">20<br><span class="text-[7px] text-gray-400 font-normal">ãƒ„ãƒ¢ã®ã¿</span></td>
                                <td class="p-0.5 border border-gray-600">-</td>
                                <td class="p-0.5 border border-gray-600 leading-tight">2100<br><span class="text-[7px] text-gray-400">700ï½µï½°ï¾™</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">3900<br><span class="text-[7px] text-gray-400">1300ï½µï½°ï¾™</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">7800<br><span class="text-[7px] text-gray-400">2600ï½µï½°ï¾™</span></td>
                            </tr>
                            <tr class="bg-gray-800/50">
                                <td class="p-0.5 border border-gray-600 font-bold text-white leading-tight">25<br><span class="text-[7px] text-gray-400 font-normal">ä¸ƒå¯¾å­</span></td>
                                <td class="p-0.5 border border-gray-600">-</td>
                                <td class="p-0.5 border border-gray-600 leading-tight">2400<br><span class="text-[7px] text-gray-400">ãƒ­ãƒ³ã®ã¿</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">4800<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 1600ï½µï½°ï¾™</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">9600<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 3200ï½µï½°ï¾™</span></td>
                            </tr>
                            <tr>
                                <td class="p-0.5 border border-gray-600 font-bold text-white leading-tight">30</td>
                                <td class="p-0.5 border border-gray-600 leading-tight">1500<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 500ï½µï½°ï¾™</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">2900<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 1000ï½µï½°ï¾™</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">5800<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 2000ï½µï½°ï¾™</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">11600<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 3900ï½µï½°ï¾™</span></td>
                            </tr>
                            <tr class="bg-gray-800/50">
                                <td class="p-0.5 border border-gray-600 font-bold text-white leading-tight">40</td>
                                <td class="p-0.5 border border-gray-600 leading-tight">2000<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 700ï½µï½°ï¾™</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">3900<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 1300ï½µï½°ï¾™</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">7700<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 2600ï½µï½°ï¾™</span></td>
                                <td class="p-0.5 border border-gray-600 text-red-300 font-bold leading-tight">æº€è²«<br><span class="text-[7px] text-gray-400 font-normal">ãƒ„ãƒ¢ 4000ï½µï½°ï¾™</span></td>
                            </tr>
                            <tr>
                                <td class="p-0.5 border border-gray-600 font-bold text-white leading-tight">50</td>
                                <td class="p-0.5 border border-gray-600 leading-tight">2400<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 800ï½µï½°ï¾™</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">4800<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 1600ï½µï½°ï¾™</span></td>
                                <td class="p-0.5 border border-gray-600 leading-tight">9600<br><span class="text-[7px] text-gray-400">ãƒ„ãƒ¢ 3200ï½µï½°ï¾™</span></td>
                                <td class="p-0.5 border border-gray-600 text-red-300 font-bold leading-tight">æº€è²«<br><span class="text-[7px] text-gray-400 font-normal">ãƒ„ãƒ¢ 4000ï½µï½°ï¾™</span></td>
                            </tr>
                        </table>
                    </div>

                    <div class="mt-3 flex justify-between text-[9px] font-bold text-gray-400 bg-gray-800 p-1.5 rounded border border-gray-700">
                        <span>ã€æº€è²«ã€‘å­ 8000 / è¦ª 12000</span>
                        <span>ã€è·³æº€ã€‘å­ 12000 / è¦ª 18000</span>
                    </div>
                    <div class="flex justify-between text-[9px] font-bold text-gray-400 bg-gray-800 p-1.5 rounded border border-gray-700 mt-1">
                        <span>ã€å€æº€ã€‘å­ 16000 / è¦ª 24000</span>
                        <span>ã€ä¸‰å€æº€ã€‘å­ 24000 / è¦ª 36000</span>
                    </div>
                </div>

            </div>
            
            <div class="flex justify-center items-center gap-2 pt-2 shrink-0 border-t border-gray-700" id="rule-dots">
                <div class="w-2 h-2 rounded-full bg-yellow-400 transition-colors"></div>
                <div class="w-2 h-2 rounded-full bg-gray-600 transition-colors"></div>
                <div class="w-2 h-2 rounded-full bg-gray-600 transition-colors"></div>
            </div>
            <div class="text-center text-[9px] text-gray-400 mt-1 shrink-0">â—€ å·¦å³ã«ãƒ•ãƒªãƒƒã‚¯ã—ã¦åˆ‡ã‚Šæ›¿ãˆ â–¶</div>
        </div>
    </div>
    
    <div id="transfer-modal" class="modal-overlay" onclick="closeTransferModal()"><div class="bg-gray-800 w-11/12 max-w-sm rounded-lg p-4 shadow-xl border border-gray-700 relative" onclick="event.stopPropagation()"><h3 class="text-lg font-bold text-yellow-400 mb-3 text-center border-b border-gray-700 pb-2">ç‚¹æ•°ã®ç§»å‹•</h3><div class="mb-3"><div class="text-xs text-gray-400 mb-1">ğŸ€„ ã‚¢ã‚¬ã£ãŸäºº <span class="text-[8px]">(ğŸ‘‘ã¯ç¾åœ¨ã®è¦ª)</span></div><div class="flex gap-1"><button id="ta-0" onclick="setTransferAgari(0)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold active text-xs">Aã•ã‚“</button><button id="ta-1" onclick="setTransferAgari(1)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold text-xs">Bã•ã‚“</button><button id="ta-2" onclick="setTransferAgari(2)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold text-xs">Cã•ã‚“</button><button id="ta-3" onclick="setTransferAgari(3)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold text-xs">Dã•ã‚“</button></div></div><div id="transfer-furi-section" class="mb-3"><div class="text-xs text-gray-400 mb-1">ğŸ˜­ æŒ¯ã‚Šè¾¼ã‚“ã äºº</div><div class="flex gap-1"><button id="tf-0" onclick="setTransferFuri(0)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold text-xs">Aã•ã‚“</button><button id="tf-1" onclick="setTransferFuri(1)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold active text-xs">Bã•ã‚“</button><button id="tf-2" onclick="setTransferFuri(2)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold text-xs">Cã•ã‚“</button><button id="tf-3" onclick="setTransferFuri(3)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold text-xs">Dã•ã‚“</button></div></div><div id="transfer-oya-section" class="mb-3 hidden"><div class="text-xs text-gray-400 mb-1">ğŸ‘‘ è¦ªã¯èª°ï¼Ÿ (è‡ªå‹•é¸æŠæ¸ˆ)</div><div class="flex gap-1"><button id="to-0" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold text-xs pointer-events-none">Aã•ã‚“</button><button id="to-1" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold active text-xs pointer-events-none">Bã•ã‚“</button><button id="to-2" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold text-xs pointer-events-none">Cã•ã‚“</button><button id="to-3" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold text-xs pointer-events-none">Dã•ã‚“</button></div></div><div class="text-center font-bold text-yellow-400 text-2xl my-3" id="transfer-amount-text">0 ç‚¹</div><div class="flex gap-2"><button onclick="closeTransferModal()" class="w-1/3 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded shadow border border-gray-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button onclick="window.executeTransfer()" class="w-2/3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded shadow-lg border border-yellow-400 active:scale-95 transition-transform">æ±ºå®šã—ã¦åæ˜ </button></div></div></div>

    <div id="camera-modal" class="modal-overlay flex-col"><video id="camera-video" class="w-full h-full object-cover" autoplay playsinline></video><div class="absolute inset-0 flex items-center justify-center pointer-events-none"><div class="w-11/12 h-1/3 border-4 border-yellow-400 rounded-lg flex items-center justify-center bg-black/20 backdrop-blur-sm"><span class="text-yellow-400 font-bold opacity-70 tracking-widest text-xl">æ å†…ã«ç‰Œã‚’ä¸¦ã¹ã¦ãã ã•ã„</span></div></div><div class="absolute bottom-8 w-full flex justify-around items-center px-8 pb-[env(safe-area-inset-bottom)]"><button onclick="closeCamera()" class="text-white bg-gray-800 px-6 py-3 rounded-full font-bold shadow-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button onclick="takePhoto()" class="w-20 h-20 bg-white rounded-full border-4 border-gray-300 shadow-xl active:bg-gray-200"></button><div class="w-24"></div></div><canvas id="camera-canvas" class="hidden"></canvas></div>
    <div id="detail-modal" class="modal-overlay" onclick="closeDetail()"><div class="bg-gray-800 w-11/12 max-w-md rounded-lg p-4 shadow-xl border border-gray-700 relative max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()"><button onclick="closeDetail()" class="absolute top-2 right-2 text-gray-400 hover:text-white bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center">âœ•</button><h3 class="text-lg font-bold text-yellow-400 mb-3 text-center border-b border-gray-700 pb-2">è¨ˆç®—è©³ç´°</h3><div id="detail-content" class="text-sm space-y-4"></div></div></div>

    <script>
        const TILES = { man: ['ğŸ€‡','ğŸ€ˆ','ğŸ€‰','ğŸ€Š','ğŸ€‹','ğŸ€Œ','ğŸ€','ğŸ€','ğŸ€'], pin: ['ğŸ€™','ğŸ€š','ğŸ€›','ğŸ€œ','ğŸ€','ğŸ€','ğŸ€Ÿ','ğŸ€ ','ğŸ€¡'], sou: ['ğŸ€','ğŸ€‘','ğŸ€’','ğŸ€“','ğŸ€”','ğŸ€•','ğŸ€–','ğŸ€—','ğŸ€˜'], ji: ['ğŸ€€','ğŸ€','ğŸ€‚','ğŸ€ƒ','ğŸ€†','ğŸ€…','ğŸ€„'] };
        const TYPE_ORDER = { 'man':0, 'pin':1, 'sou':2, 'ji':3 };
        const WINDS = ['æ±','å—','è¥¿','åŒ—'];
        let currentHand = []; let idCounter = 0;
        let settings = { prevalent: 0, seat: 0, winType: 'ron', reach: 0, dora: 0, honba: 0 };
        let lastCalculationResult = null; 

        window.globalGameState = { bakaze: 0, oya: 0, honba: 0 };
        window.globalNames = ["Aã•ã‚“", "Bã•ã‚“", "Cã•ã‚“", "Dã•ã‚“"];
        window.globalSeatOrder = [0, 1, 2, 3];
        window.globalGameType = 'tonpu';
        window.myUsername = localStorage.getItem('mj_username') || "ã‚²ã‚¹ãƒˆ";

        // â˜…ã‚¹ãƒ©ã‚¤ãƒ‰ã‚·ãƒ§ãƒ¼ã®ãƒ­ã‚¸ãƒƒã‚¯
        let currentImageIndex = 0;
        let imageCycleTimer = null;
        
        function cycleTitleImage() {
            const nextIndex = (currentImageIndex + 1) % 3;
            document.getElementById(`bg-img-${currentImageIndex}`).classList.remove('opacity-100');
            document.getElementById(`bg-img-${currentImageIndex}`).classList.add('opacity-0');
            
            document.getElementById(`bg-img-${nextIndex}`).classList.remove('opacity-0');
            document.getElementById(`bg-img-${nextIndex}`).classList.add('opacity-100');
            
            currentImageIndex = nextIndex;
        }

        function startImageCycle() {
            if (imageCycleTimer) clearInterval(imageCycleTimer); 
            imageCycleTimer = setInterval(cycleTitleImage, 5000); 
        }
        
        startImageCycle();

        function updateUsernameDisplay() {
            document.getElementById('entrance-username-display').textContent = window.myUsername;
            document.getElementById('local-username-display').textContent = window.myUsername;
        }

        window.editUsername = function() {
            let newName = prompt("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (æœ€å¤§4æ–‡å­—)", window.myUsername);
            if (newName !== null) {
                newName = newName.trim().substring(0, 4);
                if (newName === "") newName = "ã‚²ã‚¹ãƒˆ";
                window.myUsername = newName;
                localStorage.setItem('mj_username', window.myUsername);
                updateUsernameDisplay();
            }
        }

        window.startEntrance = function() {
            clearInterval(imageCycleTimer);

            const btn = document.getElementById('btn-entrance');
            btn.disabled = true;
            btn.classList.remove('active:scale-95');
            const container = document.getElementById('entrance-tiles-container');
            container.innerHTML = ''; 

            const seq = [
                { c: 'ğŸ€‡', cls: 'tile-man' }, { c: 'ğŸ€ˆ', cls: 'tile-man' }, { c: 'ğŸ€‰', cls: 'tile-man' },
                { c: 'ğŸ€‡', cls: 'tile-man' }, { c: 'ğŸ€ˆ', cls: 'tile-man' }, { c: 'ğŸ€‰', cls: 'tile-man' },
                { c: 'ğŸ€', cls: 'tile-sou' }, { c: 'ğŸ€‘', cls: 'tile-sou' }, { c: 'ğŸ€’', cls: 'tile-sou' },
                { c: 'ğŸ€™', cls: 'tile-pin' }, { c: 'ğŸ€š', cls: 'tile-pin' }, { c: 'ğŸ€›', cls: 'tile-pin' },
                { c: 'ğŸ€¡', cls: 'tile-pin' }, { c: 'ğŸ€¡', cls: 'tile-pin' }
            ];

            seq.forEach((tile, index) => {
                const d = document.createElement('div');
                d.className = `tile ${tile.cls} w-[6vw] h-[8.5vw] max-w-[2.2rem] max-h-[3rem] text-[5vw] landscape:w-9 landscape:h-12 landscape:text-3xl landscape:max-w-none landscape:max-h-none shadow-lg border-b-2 border-gray-300 opacity-0`;
                d.style.transform = 'translateY(-20px) scale(0.8)';
                d.textContent = tile.c;
                d.id = `entrance-tile-${index}`;
                container.appendChild(d);
            });

            let delay = 0;
            seq.forEach((tile, index) => {
                setTimeout(() => {
                    const d = document.getElementById(`entrance-tile-${index}`);
                    d.classList.add('entrance-tile-anim');
                    if (index === seq.length - 1) {
                        setTimeout(() => {
                            const screen = document.getElementById('entrance-screen');
                            screen.style.opacity = '0'; 
                            setTimeout(() => {
                                screen.classList.add('hidden');
                                const app = document.getElementById('app-container');
                                app.classList.remove('hidden');
                                app.classList.add('flex'); 
                            }, 700); 
                        }, 1000); 
                    }
                }, delay);
                delay += 120; 
            });
        };

        window.returnToEntrance = function() {
            startImageCycle();

            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('flex');
            const screen = document.getElementById('entrance-screen');
            screen.classList.remove('hidden');
            screen.style.opacity = '1';
            document.getElementById('entrance-tiles-container').innerHTML = '';
            const btn = document.getElementById('btn-entrance');
            btn.disabled = false;
            btn.classList.add('active:scale-95');
        }

        window.handleHeaderAction = function() {
            if (window.currentRoomId) {
                if (confirm("å¯¾æˆ¦ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å®¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                    window.currentRoomId = null;
                    document.getElementById('local-header').classList.remove('hidden');
                    document.getElementById('scoreboard').classList.add('hidden');
                    document.getElementById('scoreboard').classList.remove('flex');
                    
                    const btn = document.getElementById('btn-header-action');
                    btn.className = "w-12 h-12 bg-indigo-700 hover:bg-indigo-600 text-white font-bold rounded shadow transition-colors border border-indigo-500 flex flex-col items-center justify-center active:scale-95 shrink-0";
                    document.getElementById('btn-header-icon').textContent = "ğŸ®";
                    document.getElementById('btn-header-text').textContent = "å±€é–‹å§‹";
                    
                    window.globalGameState = { bakaze: 0, oya: 0, honba: 0 };
                    window.applyGameStateToUI();
                    updateActionButtons(lastCalculationResult !== null);
                }
            } else {
                openRoomModal();
            }
        }

        function init() { 
            updateUsernameDisplay();
            renderPalette('man'); 
            renderHand(); 
            updateUI(); 
            
            applyGameStateToUI(); 
        }

        window.applyGameStateToUI = function() {
            let bakazeText = WINDS[window.globalGameState.bakaze % 4];
            let oyaPos = window.globalSeatOrder.indexOf(window.globalGameState.oya);
            if(oyaPos === -1) oyaPos = window.globalGameState.oya; 
            const kyokuNum = oyaPos + 1;

            document.getElementById('game-status-display').textContent = `${bakazeText}${kyokuNum}å±€ ${window.globalGameState.honba}æœ¬å ´`;
            
            if (window.currentRoomId) {
                settings.prevalent = window.globalGameState.bakaze % 4; 
                settings.honba = window.globalGameState.honba;
                
                let mySeatIndex = window.globalNames.indexOf(window.myUsername);
                if (mySeatIndex !== -1) {
                    let myPos = window.globalSeatOrder.indexOf(mySeatIndex);
                    if (myPos !== -1) {
                        settings.seat = (myPos - oyaPos + 4) % 4;
                    } else {
                        settings.seat = 0;
                    }
                } else {
                    settings.seat = 0;
                }
            } else {
                settings.prevalent = window.globalGameState.bakaze % 4; 
                settings.honba = window.globalGameState.honba;         
                settings.seat = 0;
            }
            updateUI();
        }

        function openRoomModal() { document.getElementById('room-modal').classList.add('active'); }
        window.openRoomModal = openRoomModal;
        function closeRoomModal() { document.getElementById('room-modal').classList.remove('active'); }
        window.closeRoomModal = closeRoomModal;
        function openRulebook() { document.getElementById('rule-modal').classList.add('active'); }
        window.openRulebook = openRulebook;
        function closeRulebook() { document.getElementById('rule-modal').classList.remove('active'); }
        
        function updateRuleDots() { const container = document.getElementById('rule-scroll-container'); const dots = document.getElementById('rule-dots').children; const pageIndex = Math.round(container.scrollLeft / container.clientWidth); for(let i = 0; i < dots.length; i++) { dots[i].className = i === pageIndex ? "w-2 h-2 rounded-full bg-yellow-400 transition-colors" : "w-2 h-2 rounded-full bg-gray-600 transition-colors"; } }

        function updateUI() {
            document.getElementById('btn-prevalent').textContent = WINDS[settings.prevalent] + "å ´";
            const sBtn = document.getElementById('btn-seat'); sBtn.textContent = WINDS[settings.seat] + "å®¶" + (settings.seat===0?"(è¦ª)":"(å­)"); sBtn.className = settings.seat===0 ? "bg-red-900 py-1.5 portrait:py-1 rounded text-xs font-bold border border-red-700 transition-all leading-tight" : "bg-blue-900 py-1.5 portrait:py-1 rounded text-xs font-bold border border-blue-700 transition-all leading-tight";
            const wBtn = document.getElementById('btn-win-type'); wBtn.textContent = settings.winType === 'ron' ? "ãƒ­ãƒ³ã‚ãŒã‚Š" : "ãƒ„ãƒ¢ã‚ãŒã‚Š"; wBtn.className = settings.winType === 'ron' ? "bg-red-800 py-1.5 portrait:py-1 rounded text-xs font-bold border border-red-600 transition-all leading-tight" : "bg-green-700 py-1.5 portrait:py-1 rounded text-xs font-bold border border-green-600 transition-all leading-tight";
            const rBtn = document.getElementById('btn-reach'); rBtn.textContent = ["ç«‹ç›´ãªã—", "ç«‹ç›´(1é£œ)", "Wç«‹ç›´(2é£œ)"][settings.reach]; rBtn.className = ["bg-gray-700 text-gray-400","bg-red-600 text-white","bg-yellow-600 text-white"][settings.reach] + " py-1.5 portrait:py-1 rounded text-xs font-bold border border-gray-600 transition-all leading-tight";
            document.getElementById('dora-disp').textContent = settings.dora; document.getElementById('honba-disp').textContent = settings.honba;
        }
        function togglePrevalent() { settings.prevalent = (settings.prevalent+1)%4; updateUI(); }
        function toggleSeat() { settings.seat = (settings.seat+1)%4; updateUI(); }
        function toggleWinType() { settings.winType = settings.winType==='ron'?'tsumo':'ron'; updateUI(); }
        function toggleReach() { settings.reach = (settings.reach+1)%3; updateUI(); }
        function updCnt(k, d) { settings[k] = Math.max(0, settings[k]+d); updateUI(); }
        function renderPalette(type) {
            document.querySelectorAll('.tab-btn').forEach(b => { b.className = b.dataset.type===type ? "flex-1 py-1.5 rounded-t bg-blue-600 text-white text-xs font-bold tab-btn transition-colors" : "flex-1 py-1.5 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn transition-colors"; });
            const c = document.getElementById('tile-container'); c.innerHTML = '';
            TILES[type].forEach((char, i) => { const d = document.createElement('div'); d.className = `palette-tile ${['tile-man','tile-pin','tile-sou','tile-ji'][TYPE_ORDER[type]]}`; d.textContent = char; d.onclick = () => addTile(type, i+1, char); c.appendChild(d); });
        }
        function addTile(type, val, char) {
            if (currentHand.length < 14) { currentHand.push({ type, value: val, char, id: idCounter++, isAgari: false }); currentHand.sort((a,b) => { if (TYPE_ORDER[a.type] !== TYPE_ORDER[b.type]) return TYPE_ORDER[a.type] - TYPE_ORDER[b.type]; return a.value - b.value; }); renderHand(); }
        }
        function renderHand() {
            const c = document.getElementById('hand-container'); c.innerHTML = '';
            currentHand.forEach(t => {
                const d = document.createElement('div'); d.className = `tile ${['tile-man','tile-pin','tile-sou','tile-ji'][TYPE_ORDER[t.type]]}`; if (t.isAgari) d.classList.add('agari-tile'); d.textContent = t.char;
                let sy=0, sx=0, isDrag=false;
                d.addEventListener('touchstart', e=>{ sy=e.touches[0].clientY; sx=e.touches[0].clientX; isDrag=true; d.style.transition='none'; }, {passive:false});
                d.addEventListener('touchmove', e=>{ if(!isDrag)return; let dy = e.touches[0].clientY - sy; let dx = e.touches[0].clientX - sx; if(dy < 0 && Math.abs(dy) > Math.abs(dx)) { e.preventDefault(); d.style.transform=`translateY(${dy}px)`; d.style.opacity = dy<-50?'0.5':'1'; } }, {passive:false});
                d.addEventListener('touchend', e=>{ if(!isDrag)return; isDrag=false; let dy = e.changedTouches[0].clientY - sy; let dx = e.changedTouches[0].clientX - sx; d.style.transition='transform 0.2s, opacity 0.2s'; if(dy < -50 && Math.abs(dy) > Math.abs(dx)) { d.style.transform='translateY(-100px)'; d.style.opacity='0'; setTimeout(()=>{ currentHand = currentHand.filter(x=>x.id!==t.id); renderHand(); }, 200); } else if(Math.abs(dy)<10 && Math.abs(dx)<10) { d.style.transform=''; d.style.opacity='1'; currentHand.forEach(x => x.isAgari = (x.id === t.id)); renderHand(); } else { d.style.transform=''; d.style.opacity='1'; } });
                c.appendChild(d);
            });
            for(let i=currentHand.length; i<14; i++){ const d = document.createElement('div'); d.className='tile tile-empty'; c.appendChild(d); }
            const scrollView = document.getElementById('hand-scroll-view'); scrollView.scrollLeft = scrollView.scrollWidth;
        }

        function updateActionButtons(isSuccess) {
            const btnCalc = document.getElementById('btn-calc'); const btnRecalc = document.getElementById('btn-recalc'); const btnTransfer = document.getElementById('btn-transfer');
            if (!isSuccess) {
                btnCalc.classList.remove('hidden'); btnRecalc.classList.add('hidden'); btnRecalc.classList.remove('flex-1'); btnRecalc.classList.add('flex-[2]'); btnTransfer.classList.add('hidden');
            } else {
                btnCalc.classList.add('hidden');
                if (window.currentRoomId) { btnRecalc.classList.remove('hidden', 'flex-[2]'); btnRecalc.classList.add('flex-1'); btnTransfer.classList.remove('hidden'); } 
                else { btnRecalc.classList.remove('hidden', 'flex-1'); btnRecalc.classList.add('flex-[2]'); btnTransfer.classList.add('hidden'); }
            }
        }
        function clearHand() { currentHand=[]; renderHand(); document.getElementById('result-score').textContent="--- ç‚¹"; document.getElementById('result-yaku').textContent="å½¹ãªã—"; lastCalculationResult = null; updateActionButtons(false); }
        window.clearHand = clearHand;
        
        let videoStream = null;
        async function openCamera() { const modal = document.getElementById('camera-modal'); const video = document.getElementById('camera-video'); modal.classList.add('active'); try { videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false }); video.srcObject = videoStream; } catch (err) { alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); closeCamera(); } }
        window.openCamera = openCamera;
        function closeCamera() { const modal = document.getElementById('camera-modal'); modal.classList.remove('active'); if (videoStream) { videoStream.getTracks().forEach(track => track.stop()); videoStream = null; } }
        window.closeCamera = closeCamera;
        function takePhoto() { const video = document.getElementById('camera-video'); video.style.opacity = '0.2'; setTimeout(() => { video.style.opacity = '1'; }, 100); simulateImageRecognition(); closeCamera(); }
        window.takePhoto = takePhoto;
        function simulateImageRecognition() { clearHand(); const mockTiles = [{t:'man', v:2}, {t:'man', v:3}, {t:'man', v:4}, {t:'pin', v:3}, {t:'pin', v:4}, {t:'pin', v:5}, {t:'sou', v:6}, {t:'sou', v:7}, {t:'sou', v:8}, {t:'sou', v:2}, {t:'sou', v:2}, {t:'sou', v:2}, {t:'man', v:8}, {t:'man', v:8}]; mockTiles.forEach(item => { addTile(item.t, item.v, TILES[item.t][item.v - 1]); }); if(currentHand.length>0) { currentHand[currentHand.length-1].isAgari=true; renderHand(); } alert("ğŸ“· ãƒ‡ãƒ¢: ãƒ€ãƒŸãƒ¼ã®æ‰‹ç‰Œã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ"); }

        window.openDetailBtn = function(e) {
            if (e && e.target.id === 'btn-transfer') return;
            openDetail(lastCalculationResult);
        }

        function openDetail(res) {
            if(!res || !res.fuDetails) return; const modal = document.getElementById('detail-modal'); const content = document.getElementById('detail-content');
            let html = `<div class="bg-gray-900/50 p-2 rounded border border-gray-700"><h4 class="font-bold text-yellow-300 mb-1">ğŸ€„ ç¬¦è¨ˆç®—ã®å†…è¨³</h4><ul class="list-disc list-inside text-gray-300 space-y-1">`;
            let totalFuRaw = 0; res.fuDetails.forEach(d => { html += `<li class="flex justify-between"><span>${d.text}</span><span>+${d.points} ç¬¦</span></li>`; totalFuRaw += d.points; });
            html += `</ul><div class="border-t border-gray-600 mt-2 pt-1 flex justify-between font-bold"><span>åˆè¨ˆ</span><span>${totalFuRaw} ç¬¦</span></div><div class="flex justify-between text-yellow-400 mt-1"><span>åˆ‡ã‚Šä¸Šã’å¾Œ</span><span class="text-lg">${res.fu} ç¬¦</span></div></div><div class="bg-gray-900/50 p-2 rounded border border-gray-700 flex justify-between items-center mt-3"><span class="font-bold text-yellow-300">ğŸ€… é£œæ•°</span><span class="text-lg font-bold">${res.han} é£œ</span></div><div class="text-center text-gray-400 text-xs mt-3">åŸºæœ¬ç‚¹ = ç¬¦ Ã— 2^(é£œæ•°+2)<br>(æº€è²«ä»¥ä¸Šã¯å›ºå®šç‚¹)</div>`;
            content.innerHTML = html; modal.classList.add('active');
        }
        function closeDetail() { document.getElementById('detail-modal').classList.remove('active'); }
        window.closeDetail = closeDetail;

        function calculateFull() {
            const resScore = document.getElementById('result-score'); const resYaku = document.getElementById('result-yaku');
            if (currentHand.length !== 14) { resScore.textContent = "æšæ•°ä¸è¶³"; resYaku.textContent = "ç‰Œã¯14æšå¿…è¦ã§ã™"; lastCalculationResult = null; updateActionButtons(false); return; }
            const agariTileData = currentHand.find(t => t.isAgari);
            if (!agariTileData) { resScore.textContent = "æŒ‡å®šãªã—"; resYaku.textContent = "ä¸ŠãŒã‚Šç‰Œã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„"; lastCalculationResult = null; updateActionButtons(false); return; }
            const agariTileStr = agariTileData.type + agariTileData.value;
            const counts = {}; currentHand.forEach(t => { const k = t.type + t.value; counts[k] = (counts[k]||0) + 1; });
            const pairs = Object.values(counts).filter(c => c === 2).length;
            if (pairs === 7) { const res = calcChiitoiResult(counts); displayResult(res, resScore, resYaku); lastCalculationResult = res; updateActionButtons(true); return; }
            const decompositions = decompose(counts);
            if (decompositions.length === 0) { 
                if (isKokushi(counts)) { 
                    const score = settings.seat===0 ? 48000 : 32000; 
                    const pay = settings.seat===0 ? { type: settings.winType, total: score + settings.honba*300 } : { type: settings.winType, total: score + settings.honba*300 };
                    if(settings.winType !== 'ron') {
                        if(settings.seat===0) { pay.type='tsumo_oya'; pay.ko = 16000 + settings.honba*100; }
                        else { pay.type='tsumo_ko'; pay.oya = 16000 + settings.honba*100; pay.ko = 8000 + settings.honba*100; }
                    }
                    resScore.textContent = `${score}ç‚¹`; resYaku.textContent = "å½¹æº€ å›½å£«ç„¡åŒ"; 
                    lastCalculationResult = { han:13, fu:0, score: score+settings.honba*300, yakuNames:["å›½å£«ç„¡åŒ"], fuDetails:[], payments_oya: pay, payments_ko: pay }; 
                    updateActionButtons(true); return; 
                } 
                resScore.textContent = "å½¹ãªã—"; resYaku.textContent = "ã‚¢ã‚¬ãƒªå½¢ã«ãªã£ã¦ã„ã¾ã›ã‚“"; lastCalculationResult = null; updateActionButtons(false); return; 
            }
            let bestResult = { han: 0, fu: 0, score: -1, yakuNames: [], fuDetails: [] };
            decompositions.forEach(groups => { const res = evalHand(groups, counts, agariTileStr); if (res.score > bestResult.score || (res.score === bestResult.score && res.han > bestResult.han)) { bestResult = res; } });
            if (bestResult.score === -1 || bestResult.han === 0) { 
                resScore.textContent = "å½¹ãªã—"; resYaku.textContent = "ã‚¢ã‚¬ãƒªå½¢ã§ã™ãŒå½¹ãŒã‚ã‚Šã¾ã›ã‚“"; lastCalculationResult = null; updateActionButtons(false);
            } else { 
                displayResult(bestResult, resScore, resYaku); lastCalculationResult = bestResult; updateActionButtons(true); 
            }
        }
        window.calculateFull = calculateFull;

        function decompose(counts) { const results = []; const keys = Object.keys(counts); keys.forEach(headKey => { if (counts[headKey] >= 2) { const workingCounts = {...counts}; workingCounts[headKey] -= 2; const headGroup = { type: 'head', tile: headKey }; const mentsuRes = decomposeMentsu(workingCounts); mentsuRes.forEach(mList => { results.push([headGroup, ...mList]); }); } }); return results; }
        function decomposeMentsu(c) { let first = null; const keys = ['man','pin','sou','ji']; for(let t of keys) { const limit = t==='ji'?7:9; for(let v=1; v<=limit; v++) { if (c[t+v] > 0) { first = t+v; break; } } if(first) break; } if (!first) return [[]]; const results = []; const type = first.substring(0, first.length-1); const val = parseInt(first.substring(first.length-1)); if (c[first] >= 3) { const nextC = {...c}; nextC[first] -= 3; const tails = decomposeMentsu(nextC); tails.forEach(t => { results.push([{type:'koutsu', tile:first}, ...t]); }); } if (type !== 'ji' && val <= 7) { const k1 = type + val; const k2 = type + (val+1); const k3 = type + (val+2); if (c[k1]>0 && c[k2]>0 && c[k3]>0) { const nextC = {...c}; nextC[k1]--; nextC[k2]--; nextC[k3]--; const tails = decomposeMentsu(nextC); tails.forEach(t => { results.push([{type:'shuntsu', tile:k1}, ...t]); }); } } return results; }
        function isKokushi(c) { const yaochu = ['man1','man9','pin1','pin9','sou1','sou9','ji1','ji2','ji3','ji4','ji5','ji6','ji7']; const keys = Object.keys(c); if(keys.length !== 13) return false; return keys.every(k => yaochu.includes(k)); }
        function evalHand(groups, counts, agariTileStr) {
            let bestRes = { han: 0, fu: 0, score: -1, yakuNames: [], fuDetails: [] };
            const head = groups.find(g => g.type === 'head'); const mentsu = groups.filter(g => g.type !== 'head'); const shuntsu = mentsu.filter(g => g.type === 'shuntsu'); const koutsu = mentsu.filter(g => g.type === 'koutsu');
            let possibleWaits = []; if (head.tile === agariTileStr) possibleWaits.push({ type: 'tanki', fu: 2, pinfu: false, name: 'å˜é¨å¾…ã¡' });
            koutsu.forEach(k => { if (k.tile === agariTileStr) possibleWaits.push({ type: 'shanpon', fu: 0, pinfu: false, name: 'åŒç¢°å¾…ã¡', targetGroup: k }); });
            shuntsu.forEach(s => { let t = s.tile.slice(0, -1), v = parseInt(s.tile.slice(-1)); let aT = agariTileStr.slice(0, -1), aV = parseInt(agariTileStr.slice(-1)); if (t === aT) { if (aV === v + 1) possibleWaits.push({ type: 'kanchan', fu: 2, pinfu: false, name: 'åµŒå¼µå¾…ã¡' }); else if (aV === v && v === 7) possibleWaits.push({ type: 'penchan', fu: 2, pinfu: false, name: 'è¾ºå¼µå¾…ã¡' }); else if (aV === v + 2 && v === 1) possibleWaits.push({ type: 'penchan', fu: 2, pinfu: false, name: 'è¾ºå¼µå¾…ã¡' }); else if (aV === v || aV === v + 2) possibleWaits.push({ type: 'ryanmen', fu: 0, pinfu: true, name: 'ä¸¡é¢å¾…ã¡' }); } });
            let baseHan = 0; let baseYaku = []; if (settings.reach === 1) { baseHan+=1; baseYaku.push("ç«‹ç›´(1)"); } if (settings.reach === 2) { baseHan+=2; baseYaku.push("Wç«‹ç›´(2)"); } if (settings.winType === 'tsumo') { baseHan+=1; baseYaku.push("é–€å‰æ¸…è‡ªæ‘¸(1)"); } if (settings.dora > 0) { baseHan+=settings.dora; baseYaku.push(`ãƒ‰ãƒ©(${settings.dora})`); }
            const isTanyao = Object.keys(counts).every(k => { const t = k.slice(0,-1), v=parseInt(k.slice(-1)); return t!=='ji' && v>1 && v<9; }); if (isTanyao) { baseHan+=1; baseYaku.push("æ–­å¹ºä¹(1)"); }
            let yakuhaiHan = 0; koutsu.forEach(k => { if (k.tile === 'ji5' || k.tile === 'ji6' || k.tile === 'ji7') yakuhaiHan++; if (k.tile === `ji${settings.prevalent+1}`) yakuhaiHan++; if (k.tile === `ji${settings.seat+1}`) yakuhaiHan++; }); if (yakuhaiHan>0) { baseHan+=yakuhaiHan; baseYaku.push(`å½¹ç‰Œ(${yakuhaiHan})`); }
            const headVal = parseInt(head.tile.slice(-1)); const headType = head.tile.slice(0,-1); const isHeadYakuhai = (headType==='ji' && (headVal>=5 || headVal===settings.prevalent+1 || headVal===settings.seat+1));
            let iipeiko = 0; const seqStr = shuntsu.map(s => s.tile).sort(); for(let i=0; i<seqStr.length-1; i++) { if(seqStr[i] === seqStr[i+1]) { iipeiko++; i++; } } if(iipeiko === 1) { baseHan+=1; baseYaku.push("ä¸€ç›ƒå£(1)"); } if(iipeiko === 2) { baseHan+=3; baseYaku.push("äºŒç›ƒå£(3)"); }
            const types = new Set(Object.keys(counts).map(k=>k.slice(0,-1))); const hasJi = types.has('ji'); types.delete('ji'); if(types.size === 1) { if(hasJi) { baseHan+=3; baseYaku.push("æ··ä¸€è‰²(3)"); } else { baseHan+=6; baseYaku.push("æ¸…ä¸€è‰²(6)"); } }
            if (koutsu.length === 4) { baseHan+=2; baseYaku.push("å¯¾ã€…å’Œ(2)"); }
            const sMap = {man:[], pin:[], sou:[]}; shuntsu.forEach(s => sMap[s.tile.slice(0,-1)].push(parseInt(s.tile.slice(-1)))); let sanshoku = false; sMap.man.forEach(v => { if(sMap.pin.includes(v) && sMap.sou.includes(v)) sanshoku = true; }); if(sanshoku) { baseHan+=2; baseYaku.push("ä¸‰è‰²åŒé †(2)"); }
            let ittsu = false; ['man','pin','sou'].forEach(t => { const vals = shuntsu.filter(s=>s.tile.startsWith(t)).map(s=>parseInt(s.tile.slice(-1))); if(vals.includes(1) && vals.includes(4) && vals.includes(7)) ittsu = true; }); if(ittsu) { baseHan+=2; baseYaku.push("ä¸€æ°—é€šè²«(2)"); }
            possibleWaits.forEach(wait => {
                let han = baseHan; let yaku = [...baseYaku]; let fuDetails = [{ text: 'å‰¯åº•', points: 20 }]; let fu = 20;
                const isPinfu = (shuntsu.length === 4 && !isHeadYakuhai && wait.pinfu); if (isPinfu) { han += 1; yaku.push("å¹³å’Œ(1)"); }
                let ankouCount = 0; koutsu.forEach(k => { let isAnkou = true; if (wait.type === 'shanpon' && wait.targetGroup === k && settings.winType === 'ron') { isAnkou = false; } if (isAnkou) ankouCount++; });
                if (ankouCount === 3) { han += 2; yaku.push("ä¸‰æš—åˆ»(2)"); } if (ankouCount === 4) { han += 8; yaku.push("å››æš—åˆ»(å½¹æº€)"); }
                if (settings.winType === 'ron') { fu += 10; fuDetails.push({ text: 'é–€å‰åŠ ç¬¦', points: 10 }); } if (settings.winType === 'tsumo') { fu += 2; fuDetails.push({ text: 'ãƒ„ãƒ¢ç¬¦', points: 2 }); }
                koutsu.forEach(k => { const t = k.tile.slice(0,-1), v=parseInt(k.tile.slice(-1)); const isYaochu = (t==='ji' || v===1 || v===9); let isAnkou = true; if (wait.type === 'shanpon' && wait.targetGroup === k && settings.winType === 'ron') { isAnkou = false; } const p = isYaochu ? (isAnkou ? 8 : 4) : (isAnkou ? 4 : 2); fu += p; fuDetails.push({ text: `${isYaochu?'å¹ºä¹':'ä¸­å¼µ'}${isAnkou?'æš—åˆ»':'æ˜åˆ»'}`, points: p }); });
                if (isHeadYakuhai) { fu += 2; fuDetails.push({ text: 'å½¹ç‰Œé›€é ­', points: 2 }); } if (wait.fu > 0) { fu += wait.fu; fuDetails.push({ text: wait.name, points: wait.fu }); }
                if (isPinfu && settings.winType === 'tsumo') { fu = 20; fuDetails = [{ text: 'å¹³å’Œãƒ„ãƒ¢(å›ºå®š)', points: 20 }]; } else { fu = Math.ceil(fu/10)*10; }
                let res = calculateFinalScore(han, fu, yaku, fuDetails); if (res.score > bestRes.score || (res.score === bestRes.score && res.han > bestRes.han)) { bestRes = res; }
            });
            return bestRes.score === -1 ? { han: 0, fu: 0, score: 0, yakuNames: [], fuDetails: [] } : bestRes;
        }
        function calcChiitoiResult(counts) { let han=2; let yaku=["ä¸ƒå¯¾å­(2)"]; if(settings.reach===1) {han++; yaku.push("ç«‹ç›´(1)");} if(settings.reach===2) {han+=2; yaku.push("Wç«‹ç›´(2)");} if(settings.winType==='tsumo') {han++; yaku.push("é–€å‰æ¸…è‡ªæ‘¸(1)");} if(settings.dora>0) {han+=settings.dora; yaku.push(`ãƒ‰ãƒ©(${settings.dora})`);} const isTanyao = Object.keys(counts).every(k => { const t = k.slice(0,-1), v=parseInt(k.slice(-1)); return t!=='ji' && v>1 && v<9; }); if (isTanyao) { han++; yaku.push("æ–­å¹ºä¹(1)"); } const types = new Set(Object.keys(counts).map(k=>k.slice(0,-1))); const hasJi = types.has('ji'); types.delete('ji'); if(types.size===1) { if(hasJi){han+=3;yaku.push("æ··ä¸€è‰²(3)");} else{han+=6;yaku.push("æ¸…ä¸€è‰²(6)");} } const fuDetails = [{ text: 'ä¸ƒå¯¾å­(å›ºå®š)', points: 25 }]; return calculateFinalScore(han, 25, yaku, fuDetails); }
        
        function calculateFinalScore(han, fu, yakuNames, fuDetails) { 
            let base = fu * Math.pow(2, han+2); 
            if(han>=5) {
                if(han>=13) base=8000;
                else if(han>=11) base=6000;
                else if(han>=8) base=4000;
                else if(han>=6) base=3000;
                else base=2000; 
            } else {
                if (base > 2000) base = 2000; 
            }
            
            let honba = settings.honba;
            
            let oya_score = 0; let oya_payments = { type: '', total: 0, ko: 0, oya: 0 };
            if (settings.winType==='ron') { 
                oya_score = Math.ceil((base*6)/100)*100; 
                oya_payments = { type: 'ron', total: oya_score + honba*300 }; 
            } else { 
                let k = Math.ceil((base*2)/100)*100; 
                oya_score = k * 3; 
                oya_payments = { type: 'tsumo_oya', total: oya_score + honba*300, ko: k + honba*100 }; 
            }

            let ko_score = 0; let ko_payments = { type: '', total: 0, ko: 0, oya: 0 };
            if (settings.winType==='ron') { 
                ko_score = Math.ceil((base*4)/100)*100; 
                ko_payments = { type: 'ron', total: ko_score + honba*300 }; 
            } else { 
                let o = Math.ceil((base*2)/100)*100; 
                let k = Math.ceil((base*1)/100)*100; 
                ko_score = o + k*2; 
                ko_payments = { type: 'tsumo_ko', total: ko_score + honba*300, oya: o + honba*100, ko: k + honba*100 }; 
            }

            let displayScore = settings.seat === 0 ? oya_score + honba*300 : ko_score + honba*300;

            return { 
                han, fu, score: displayScore, yakuNames, fuDetails, 
                payments_oya: oya_payments,
                payments_ko: ko_payments
            }; 
        }
        function displayResult(res, elScore, elYaku) { elScore.textContent = `${res.score}ç‚¹`; elYaku.textContent = `${res.han}é£œ ${res.fu}ç¬¦\n${res.yakuNames.join(' ')}`; }
        
        init();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyBNYx05vPh_8H217AP4sVYOq7Xu3k9vzVA",
Â  Â  authDomain: "mj-score-app.firebaseapp.com",
Â  Â  projectId: "mj-score-app",
Â  Â  storageBucket: "mj-score-app.firebasestorage.app",
Â  Â  messagingSenderId: "772380184697",
Â  Â  appId: "1:772380184697:web:e4f42a83baf9910bacc4a8"
Â  };

        let app;
        window.currentRoomId = null;
        window.dbInstance = null;
        try { 
            app = initializeApp(firebaseConfig); 
            window.dbInstance = getFirestore(app); 
        } catch(e) { console.error(e); }

        new Sortable(document.getElementById('player-grid'), {
            animation: 150, delay: 200, delayOnTouchOnly: true, ghostClass: 'sortable-ghost',
            onEnd: async function (evt) {
                if (!window.currentRoomId || !window.dbInstance) return;
                const gridChildren = Array.from(document.getElementById('player-grid').children);
                const newOrder = gridChildren.map(child => parseInt(child.id.split('-')[2]));
                try {
                    await updateDoc(doc(window.dbInstance, "rooms", window.currentRoomId), { seatOrder: newOrder });
                } catch(e) { console.error(e); }
            }
        });

        let selectedGameType = 'tonpu';
        window.setGameType = function(type) {
            selectedGameType = type;
            document.getElementById('btn-tonpu').classList.toggle('active', type === 'tonpu');
            document.getElementById('btn-hanchan').classList.toggle('active', type === 'hanchan');
        }

        window.createRoomFromModal = async function() {
            if (!window.dbInstance) return alert("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­å®šãŒæœªå®Œäº†ã§ã™ã€‚");
            const name = window.myUsername; 
            const roomId = Math.floor(1000 + Math.random() * 9000).toString(); 
            try {
                await setDoc(doc(window.dbInstance, "rooms", roomId), { 
                    scores: [25000, 25000, 25000, 25000],
                    names: [name, "å‚åŠ å¾…", "å‚åŠ å¾…", "å‚åŠ å¾…"],
                    seatOrder: [0, 1, 2, 3],
                    gameType: selectedGameType,
                    gameState: { bakaze: 0, oya: 0, honba: 0 } 
                });
                closeRoomModal();
                startListening(roomId);
                alert(`å“ã‚’ä½œã‚Šã¾ã—ãŸï¼\nã¿ã‚“ãªã« ãƒ«ãƒ¼ãƒ ID:ã€ ${roomId} ã€‘ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚`);
            } catch(e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
        }

        window.joinRoomFromModal = async function() {
            if (!window.dbInstance) return alert("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­å®šãŒæœªå®Œäº†ã§ã™ã€‚");
            const name = window.myUsername;
            const roomId = prompt("æ•™ãˆã¦ã‚‚ã‚‰ã£ãŸ4æ¡ã®ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if(!roomId) return;
            try {
                const roomRef = doc(window.dbInstance, "rooms", roomId);
                const docSnap = await getDoc(roomRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let names = data.names || ["", "", "", ""];
                    let seatIndex = names.findIndex(n => n === "å‚åŠ å¾…" || n === "ã‚²ã‚¹ãƒˆ" || n === "");
                    if (seatIndex === -1) { alert("ã™ã§ã«4äººå‚åŠ ã—ã¦ãŠã‚Šã€æº€å¸­ã§ã™ï¼"); return; }
                    names[seatIndex] = name;
                    await updateDoc(roomRef, { names: names });
                    closeRoomModal();
                    startListening(roomId);
                } else { alert("ãã®IDã®å“ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"); }
            } catch(e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
        }

        function startListening(roomId) {
            window.currentRoomId = roomId;
            
            document.getElementById('local-header').classList.add('hidden');
            document.getElementById('scoreboard').classList.remove('hidden');
            document.getElementById('scoreboard').classList.add('flex');
            
            const btn = document.getElementById('btn-header-action');
            btn.className = "w-12 h-12 bg-red-700 hover:bg-red-600 text-white font-bold rounded shadow transition-colors border border-red-500 flex flex-col items-center justify-center active:scale-95 shrink-0";
            document.getElementById('btn-header-icon').textContent = "ğŸšª";
            document.getElementById('btn-header-text').textContent = "é€€å®¤";

            onSnapshot(doc(window.dbInstance, "rooms", roomId), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const scores = data.scores || [25000, 25000, 25000, 25000];
                    window.globalNames = data.names || ["Aã•ã‚“", "Bã•ã‚“", "Cã•ã‚“", "Dã•ã‚“"];
                    window.globalGameState = data.gameState || { bakaze: 0, oya: 0, honba: 0 };
                    window.globalSeatOrder = data.seatOrder || [0, 1, 2, 3];
                    window.globalGameType = data.gameType || 'tonpu';
                    
                    const grid = document.getElementById('player-grid');
                    const elements = [];
                    for(let i=0; i<4; i++) {
                        document.getElementById(`score-${i}`).textContent = scores[i];
                        document.getElementById(`name-${i}`).textContent = window.globalNames[i];
                        elements[i] = document.getElementById(`player-box-${i}`);
                    }
                    window.globalSeatOrder.forEach(idx => { grid.appendChild(elements[idx]); });
                    
                    document.getElementById('room-id-display').textContent = roomId;
                    document.getElementById('room-type-display').textContent = data.gameType === 'hanchan' ? '(åŠè˜)' : '(æ±é¢¨)';
                    
                    window.applyGameStateToUI();
                }
            });
            if(lastCalculationResult) { updateActionButtons(true); }
        }

        let t_agari = 0, t_furi = 1, t_oya = 1;

        window.openTransferModal = function(e) {
            if(e) e.stopPropagation();
            if(!lastCalculationResult) return;
            
            window.updateTransferBtnsText();
            let myIndex = window.globalNames.indexOf(window.myUsername);
            if(myIndex === -1) myIndex = 0;
            
            setTransferAgari(myIndex);
            setTransferOya(window.globalGameState.oya);

            document.getElementById('transfer-modal').classList.add('active');
        }

        window.updateTransferBtnsText = function() {
            for(let i=0; i<4; i++) {
                let name = window.globalNames[i];
                if (i === window.globalGameState.oya) name = "ğŸ‘‘ " + name;
                document.getElementById(`ta-${i}`).textContent = name;
                document.getElementById(`tf-${i}`).textContent = name;
                document.getElementById(`to-${i}`).textContent = name;
            }
        }

        window.updateTransferModalDisplay = function() {
            if(!lastCalculationResult) return;
            const isOya = (t_agari === window.globalGameState.oya);
            const p = isOya ? lastCalculationResult.payments_oya : lastCalculationResult.payments_ko;
            
            document.getElementById('transfer-amount-text').textContent = p.total + " ç‚¹";
            
            if(p.type === 'ron') {
                document.getElementById('transfer-furi-section').classList.remove('hidden');
                document.getElementById('transfer-oya-section').classList.add('hidden');
            } else if (p.type === 'tsumo_ko') {
                document.getElementById('transfer-furi-section').classList.add('hidden');
                document.getElementById('transfer-oya-section').classList.remove('hidden');
            } else { 
                document.getElementById('transfer-furi-section').classList.add('hidden');
                document.getElementById('transfer-oya-section').classList.add('hidden');
            }
        }

        window.closeTransferModal = function() { document.getElementById('transfer-modal').classList.remove('active'); }
        
        window.setTransferAgari = function(val) { 
            t_agari = val; 
            updateTransferBtns('ta', val); 
            window.updateTransferModalDisplay(); 
        }
        window.setTransferFuri = function(val) { t_furi = val; updateTransferBtns('tf', val); }
        window.setTransferOya = function(val) { t_oya = val; updateTransferBtns('to', val); }
        
        function updateTransferBtns(prefix, val) {
            for(let i=0; i<4; i++) {
                const btn = document.getElementById(`${prefix}-${i}`);
                if(i === val) { btn.classList.add('active'); btn.classList.replace('text-gray-300', 'text-gray-900'); }
                else { btn.classList.remove('active'); btn.classList.replace('text-gray-900', 'text-gray-300'); }
            }
        }

        window.executeTransfer = async function() {
            const isOya = (t_agari === window.globalGameState.oya);
            const p = isOya ? lastCalculationResult.payments_oya : lastCalculationResult.payments_ko;
            let diff = [0, 0, 0, 0];
            
            diff[t_agari] += p.total;
            if(p.type === 'ron') {
                if(t_agari === t_furi) return alert("ã‚¢ã‚¬ã£ãŸäººã¨æŒ¯ã‚Šè¾¼ã‚“ã äººã¯åŒã˜ã«ã§ãã¾ã›ã‚“ï¼");
                diff[t_furi] -= p.total;
            } else if (p.type === 'tsumo_oya') {
                for(let i=0; i<4; i++) { if(i !== t_agari) diff[i] -= p.ko; }
            } else if (p.type === 'tsumo_ko') {
                if(t_agari === t_oya) return alert("ã‚¢ã‚¬ã£ãŸäººã¨è¦ªã¯åŒã˜ã«ã§ãã¾ã›ã‚“ï¼");
                for(let i=0; i<4; i++) {
                    if(i === t_agari) continue;
                    if(i === t_oya) diff[i] -= p.oya;
                    else diff[i] -= p.ko;
                }
            }

            let next_bakaze = window.globalGameState.bakaze;
            let next_honba = window.globalGameState.honba;
            let next_oya = window.globalGameState.oya;

            const currentOyaPos = window.globalSeatOrder.indexOf(window.globalGameState.oya);

            if (t_agari === window.globalGameState.oya) {
                next_honba++;
            } else {
                let nextOyaPos = (currentOyaPos + 1) % 4;
                next_oya = window.globalSeatOrder[nextOyaPos];
                next_honba = 0;
                if (nextOyaPos === 0) { next_bakaze++; }
            }

            let newScores = [
                parseInt(document.getElementById('score-0').textContent) + diff[0],
                parseInt(document.getElementById('score-1').textContent) + diff[1],
                parseInt(document.getElementById('score-2').textContent) + diff[2],
                parseInt(document.getElementById('score-3').textContent) + diff[3]
            ];

            if (window.currentRoomId && window.dbInstance) {
                try {
                    await updateDoc(doc(window.dbInstance, "rooms", window.currentRoomId), { 
                        scores: newScores,
                        gameState: { bakaze: next_bakaze, oya: next_oya, honba: next_honba }
                    });
                } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e.message); return; }
            } else {
                for(let i=0; i<4; i++) document.getElementById(`score-${i}`).textContent = newScores[i];
                window.globalGameState = { bakaze: next_bakaze, oya: next_oya, honba: next_honba };
                window.applyGameStateToUI();
            }

            closeTransferModal();
            clearHand(); 
        }
    </script>
</body>
</html>