<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="éº»é›€è¨ˆç®—">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a202c">
    
    <title>éº»é›€ç‚¹æ•°è¨ˆç®—æ©Ÿ Pro v1.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { screens: { 'landscape': {'raw': '(orientation: landscape)'}, 'portrait': {'raw': '(orientation: portrait)'} } } } }
    </script>
    <style>
        html { background-color: #1a202c; }
        body { font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; background-color: #1a202c; color: white; height: 100vh; height: 100dvh; overflow: hidden; user-select: none; touch-action: manipulation; margin: 0; padding: 0; }
        #app-container { max-width: 1024px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; }
        .tile { width: 2.6rem; height: 3.6rem; display: flex; align-items: center; justify-content: center; background-color: #f7fafc; border-radius: 0.25rem; font-size: 2rem; line-height: 1; box-shadow: 0 3px 5px rgba(0,0,0,0.4); cursor: pointer; position: relative; transition: transform 0.1s; touch-action: pan-x; color: #333; flex-shrink: 0; }
        @media (orientation: portrait) { .tile { width: 2.2rem; height: 3.1rem; font-size: 1.7rem; } .palette-tile { font-size: 1.8rem !important; height: 2.8rem !important; } }
        .tile-man { color: #c53030; } .tile-pin { color: #2b6cb0; } .tile-sou { color: #2f855a; } .tile-ji { color: #000; }
        .tile-empty { background-color: transparent; border: 2px dashed #4a5568; box-shadow: none; color: transparent; }
        .agari-tile { border: 3px solid #ecc94b; transform: translateY(-4px); z-index: 10; }
        .agari-tile::after { content: 'å’Œ'; position: absolute; top: -10px; right: -8px; background-color: #e53e3e; color: white; font-size: 0.6rem; width: 1.2rem; height: 1.2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid white; font-weight: bold; }
        .palette-tile { width: 100%; height: 3.2rem; display: flex; align-items: center; justify-content: center; background-color: #f7fafc; border-radius: 0.25rem; font-size: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .no-scrollbar::-webkit-scrollbar { display: none; } .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #hand-scroll-view { scrollbar-width: thin; scrollbar-color: rgba(255, 255, 255, 0.4) transparent; }
        #hand-scroll-view::-webkit-scrollbar { height: 6px; } #hand-scroll-view::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.15); border-radius: 10px; } #hand-scroll-view::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.5); border-radius: 10px; }
        .modal-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); z-index: 50; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .press-active { transform: scale(0.98); transition: transform 0.1s; }
        .snap-x-mandatory { scroll-snap-type: x mandatory; } .snap-center { scroll-snap-align: center; }
        .btn-select.active { background-color: #ecc94b; color: #1a202c; border-color: #d69e2e; }
    </style>
</head>
<body>
<div id="app-container" class="pt-[max(8px,env(safe-area-inset-top))] pl-[max(8px,env(safe-area-inset-left))] pr-[max(8px,env(safe-area-inset-right))] flex flex-col h-full">

    <div class="flex-1 min-h-0 flex flex-col landscape:grid landscape:grid-cols-10 landscape:grid-rows-[auto_1fr] gap-2 p-2 pt-1 landscape:pt-2">

        <div class="hidden landscape:flex landscape:col-span-3 landscape:col-start-1 landscape:row-start-1 gap-2 items-center">
            <button class="bg-gray-800 hover:bg-gray-700 text-gray-500 border border-gray-700 text-[10px] font-bold px-2 py-1.5 rounded shadow flex-1 transition-colors">æº–å‚™ä¸­</button>
            <button class="bg-gray-800 hover:bg-gray-700 text-gray-500 border border-gray-700 text-[10px] font-bold px-2 py-1.5 rounded shadow flex-1 transition-colors">æº–å‚™ä¸­</button>
        </div>

        <div class="flex flex-col landscape:flex-row gap-1.5 landscape:gap-2 justify-between items-stretch landscape:items-center w-full landscape:col-span-7 landscape:col-start-4 landscape:row-start-1 shrink-0">
            
            <div class="flex justify-between items-center w-full landscape:w-auto">
                <div class="flex gap-2">
                    <button onclick="window.createRoom()" class="bg-indigo-700 hover:bg-indigo-600 text-white font-bold text-[11px] px-3 py-1.5 rounded shadow transition-colors border border-indigo-500">ğŸŒ å“ä½œæˆ</button>
                    <button onclick="window.joinRoom()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold text-[11px] px-3 py-1.5 rounded shadow transition-colors border border-gray-500">ğŸšª å‚åŠ </button>
                </div>
                
                <div class="flex landscape:hidden items-center gap-1.5">
                    <button class="bg-gray-800 text-gray-500 border border-gray-700 text-[9px] px-1.5 py-1 rounded shadow">æ‹¡å¼µ</button>
                    <span class="text-[9px] text-gray-500 font-mono tracking-wider ml-0.5">v1.7</span>
                    <button onclick="openRulebook()" class="text-xl hover:scale-110 transition-transform">ğŸ“–</button>
                </div>
            </div>

            <div id="scoreboard" class="flex-1 bg-gray-900 rounded border border-gray-700 px-2 py-1 flex flex-col landscape:flex-row justify-center landscape:justify-between items-center gap-0.5 landscape:gap-0 shadow-inner">
                <div class="w-full landscape:w-auto text-center landscape:text-left mb-0.5 landscape:mb-0">
                    <span class="text-[9px] text-gray-400">ID:<span id="room-id-display" class="text-yellow-400 font-bold ml-1">ãƒ­ãƒ¼ã‚«ãƒ«</span></span>
                </div>
                
                <div class="grid grid-cols-2 landscape:flex gap-x-6 gap-y-0.5 landscape:gap-3 text-[12px] landscape:text-[10px] font-bold w-fit mx-auto landscape:mx-0">
                    <div class="text-red-400 flex justify-between w-[4.5rem] landscape:w-auto"><span>A:</span><span id="score-0">25000</span></div>
                    <div class="text-blue-400 flex justify-between w-[4.5rem] landscape:w-auto"><span>B:</span><span id="score-1">25000</span></div>
                    <div class="text-green-400 flex justify-between w-[4.5rem] landscape:w-auto"><span>C:</span><span id="score-2">25000</span></div>
                    <div class="text-yellow-400 flex justify-between w-[4.5rem] landscape:w-auto"><span>D:</span><span id="score-3">25000</span></div>
                </div>
            </div>

            <div class="hidden landscape:flex items-center gap-2 shrink-0 pl-1">
                <span class="text-[10px] text-gray-500 font-mono tracking-wider mt-0.5">v1.7</span>
                <button onclick="openRulebook()" class="text-xl hover:scale-110 transition-transform" title="ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª">ğŸ“–</button>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-2 flex flex-col gap-1.5 shadow-lg overflow-y-auto no-scrollbar border border-gray-700 w-full landscape:col-span-3 landscape:col-start-1 landscape:row-start-2 min-h-0">
            <div class="grid grid-cols-2 gap-1.5 mt-1">
                <button id="btn-prevalent" class="bg-gray-700 py-1.5 portrait:py-1 rounded text-xs font-bold border border-gray-600 transition-all" onclick="togglePrevalent()">æ±å ´</button>
                <button id="btn-seat" class="bg-red-900 py-1.5 portrait:py-1 rounded text-xs font-bold border border-red-700 transition-all" onclick="toggleSeat()">æ±å®¶(è¦ª)</button>
            </div>
            <div class="grid grid-cols-2 gap-1.5">
                <button id="btn-win-type" class="bg-red-800 py-1.5 portrait:py-1 rounded text-xs font-bold border border-red-600 transition-all" onclick="toggleWinType()">ãƒ­ãƒ³ã‚ãŒã‚Š</button>
                <button id="btn-reach" class="bg-gray-700 py-1.5 portrait:py-1 rounded text-xs font-bold border border-gray-600 text-gray-400 transition-all" onclick="toggleReach()">ç«‹ç›´ãªã—</button>
            </div>
            
            <div class="flex gap-1.5">
                <div class="flex-1 flex items-center justify-between bg-gray-700 px-2 py-1 rounded border border-gray-600">
                    <span class="text-[11px] font-bold text-gray-300">ãƒ‰ãƒ©</span>
                    <div class="flex items-center gap-1">
                        <button class="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-sm active:bg-gray-500" onclick="updCnt('dora',-1)">-</button>
                        <span id="dora-disp" class="font-mono text-sm w-4 text-center text-yellow-400">0</span>
                        <button class="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-sm active:bg-gray-500" onclick="updCnt('dora',1)">+</button>
                    </div>
                </div>
                <div class="flex-1 flex items-center justify-between bg-gray-700 px-2 py-1 rounded border border-gray-600">
                    <span class="text-[11px] font-bold text-gray-300">æœ¬å ´</span>
                    <div class="flex items-center gap-1">
                        <button class="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-sm active:bg-gray-500" onclick="updCnt('honba',-1)">-</button>
                        <span id="honba-disp" class="font-mono text-sm w-4 text-center">0</span>
                        <button class="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-sm active:bg-gray-500" onclick="updCnt('honba',1)">+</button>
                    </div>
                </div>
            </div>

            <div id="score-container" class="mt-auto bg-gray-900 p-2 rounded border border-gray-700 flex flex-col justify-center min-h-[4rem] cursor-pointer transition-colors active:bg-gray-800 relative">
                <div id="result-score" class="text-center text-2xl font-bold text-yellow-400">--- ç‚¹</div>
                <div id="result-yaku" class="text-center text-[10px] text-gray-300 mt-1 leading-tight whitespace-pre-wrap">å½¹ãªã—</div>
                <div class="text-center text-[8px] text-gray-500 mt-0.5 portrait:hidden">â€»é•·æŠ¼ã—ã§è©³ç´°ã‚’è¡¨ç¤º</div>
                
                <button id="btn-transfer" onclick="openTransferModal(event)" class="hidden absolute bottom-1.5 right-1.5 bg-yellow-600 hover:bg-yellow-500 text-white text-[10px] font-bold px-3 py-1 rounded shadow-lg border border-yellow-400 z-10 active:scale-95 transition-transform">
                    ğŸ’° é€ä¿¡
                </button>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-2 flex flex-col shadow-lg border border-gray-700 w-full landscape:col-span-7 landscape:col-start-4 landscape:row-start-2 min-h-0">
            <div class="flex gap-1 mb-1.5 shrink-0">
                <button onclick="renderPalette('man')" class="flex-1 py-1.5 rounded-t bg-blue-600 text-white text-xs font-bold tab-btn" data-type="man">è¬å­</button>
                <button onclick="renderPalette('pin')" class="flex-1 py-1.5 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn" data-type="pin">ç­’å­</button>
                <button onclick="renderPalette('sou')" class="flex-1 py-1.5 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn" data-type="sou">ç´¢å­</button>
                <button onclick="renderPalette('ji')" class="flex-1 py-1.5 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn" data-type="ji">å­—ç‰Œ</button>
            </div>
            <div id="tile-container" class="grid grid-cols-9 gap-1 auto-rows-min overflow-y-auto flex-1 content-start p-1 bg-gray-900 rounded inner-shadow mb-2"></div>
            
            <div class="flex gap-1.5 shrink-0">
                <button onclick="openCamera()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 portrait:py-2.5 rounded font-bold text-sm shadow flex items-center justify-center gap-1 border border-blue-400 active:scale-95 transition-transform">ğŸ“· æ’®å½±</button>
                <button onclick="clearHand()" class="flex-1 bg-red-800 hover:bg-red-700 text-white py-2 portrait:py-2.5 rounded font-bold text-sm shadow border border-red-700 active:scale-95 transition-transform">ã‚¯ãƒªã‚¢</button>
                <button onclick="calculateFull()" class="flex-[2] bg-yellow-600 hover:bg-yellow-500 text-white py-2 portrait:py-2.5 rounded font-bold text-base shadow border border-yellow-400 active:scale-95 transition-transform">è¨ˆç®—ã™ã‚‹</button>
            </div>
        </div>

    </div>

    <div class="shrink-0 w-full bg-green-900 border-t-4 border-green-950 shadow-[0_-4px_10px_rgba(0,0,0,0.3)] relative flex flex-col justify-center pt-2 pb-[max(12px,env(safe-area-inset-bottom))] pl-[max(8px,env(safe-area-inset-left))] pr-[max(8px,env(safe-area-inset-right))] z-20">
        <div class="text-[9px] text-green-200 opacity-80 font-mono absolute top-0.5 left-[max(12px,env(safe-area-inset-left))] pointer-events-none">TAP:ä¸ŠãŒã‚Šç‰Œ / UP-FLICK:å‰Šé™¤ <span class="portrait:inline hidden">/ å·¦å³:ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</span></div>
        <div id="hand-scroll-view" class="w-full overflow-x-auto flex items-center landscape:justify-center mt-2 z-10">
            <div id="hand-container" class="flex gap-0.5 landscape:gap-1 px-2 pt-4 pb-2 flex-nowrap min-w-max"></div>
        </div>
    </div>
</div>

    <div id="rule-modal" class="modal-overlay" onclick="closeRulebook()">
        <div class="bg-gray-800 w-11/12 max-w-md rounded-lg p-3 shadow-xl border border-gray-700 relative max-h-[85vh] flex flex-col" onclick="event.stopPropagation()">
            <button onclick="closeRulebook()" class="absolute top-2 right-2 text-gray-400 hover:text-white bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center z-20">âœ•</button>
            <h3 class="text-base font-bold text-yellow-400 mb-2 text-center border-b border-gray-700 pb-2 shrink-0">ğŸ“– å½¹ãƒ»ç¬¦è¨ˆç®—ãƒ«ãƒ¼ãƒ«</h3>
            <div class="flex-1 overflow-x-auto overflow-y-hidden snap-x-mandatory flex no-scrollbar" id="rule-scroll-container" onscroll="updateRuleDots()">
                <div class="w-full shrink-0 snap-center overflow-y-auto px-2 max-h-full pb-4">
                    <h4 class="text-sm font-bold text-white bg-blue-900 px-2 py-1 rounded border border-blue-700 sticky top-0">ğŸ€„ å½¹ã®é£œæ•°ä¸€è¦§è¡¨</h4>
                    <div class="mt-2"><div class="text-xs font-bold text-yellow-300 mb-1 border-b border-gray-600">1é£œ</div><div class="text-[11px] text-gray-300 grid grid-cols-2 gap-x-1 gap-y-0.5 mb-2"><span>ç«‹ç›´ (ãƒªãƒ¼ãƒ)</span><span>ä¸€ç™º</span><span>é–€å‰æ¸…è‡ªæ‘¸å’Œ (ãƒ„ãƒ¢)</span><span>æ–­å¹ºä¹ (ã‚¿ãƒ³ãƒ¤ã‚ª)</span><span>å¹³å’Œ (ãƒ”ãƒ³ãƒ•)</span><span>ä¸€ç›ƒå£ (ã‚¤ãƒ¼ãƒšãƒ¼ã‚³ãƒ¼)</span><span>å½¹ç‰Œ (ç™½/ç™¼/ä¸­/å ´é¢¨/è‡ªé¢¨)</span><span>å¶ºä¸Šé–‹èŠ± / æ§æ§“</span><span>æµ·åº•æ’ˆæœˆ / æ²³åº•æ’ˆé­š</span></div><div class="text-xs font-bold text-yellow-300 mb-1 border-b border-gray-600">2é£œ</div><div class="text-[11px] text-gray-300 grid grid-cols-2 gap-x-1 gap-y-0.5 mb-2"><span>ä¸‰è‰²åŒé † <span class="text-gray-500">(é³´1)</span></span><span>ä¸€æ°—é€šè²« <span class="text-gray-500">(é³´1)</span></span><span>æ··å…¨å¸¯å¹ºä¹ <span class="text-gray-500">(é³´1)</span></span><span>ä¸ƒå¯¾å­ (ãƒãƒ¼ãƒˆã‚¤ãƒ„)</span><span>å¯¾ã€…å’Œ (ãƒˆã‚¤ãƒˆã‚¤)</span><span>ä¸‰æš—åˆ» (ã‚µãƒ³ã‚¢ãƒ³ã‚³ã‚¦)</span><span>ä¸‰è‰²åŒåˆ»</span><span>ä¸‰æ§“å­</span><span>å°ä¸‰å…ƒ</span><span>ãƒ€ãƒ–ãƒ«ç«‹ç›´</span></div><div class="text-xs font-bold text-yellow-300 mb-1 border-b border-gray-600">3é£œ</div><div class="text-[11px] text-gray-300 grid grid-cols-2 gap-x-1 gap-y-0.5 mb-2"><span>æ··ä¸€è‰² <span class="text-gray-500">(é³´2)</span></span><span>ç´”å…¨å¸¯å¹ºä¹ <span class="text-gray-500">(é³´2)</span></span><span>äºŒç›ƒå£ (ãƒªãƒ£ãƒ³ãƒšãƒ¼ã‚³ãƒ¼)</span></div><div class="text-xs font-bold text-yellow-300 mb-1 border-b border-gray-600">6é£œ</div><div class="text-[11px] text-gray-300 grid grid-cols-2 gap-x-1 gap-y-0.5 mb-2"><span>æ¸…ä¸€è‰² (ãƒãƒ³ã‚¤ãƒ„) <span class="text-gray-500">(é³´5)</span></span></div><div class="text-xs font-bold text-red-400 mb-1 border-b border-gray-600">å½¹æº€</div><div class="text-[10px] text-gray-300 grid grid-cols-2 gap-x-1 gap-y-0.5"><span>å›½å£«ç„¡åŒ / å››æš—åˆ»</span><span>å¤§ä¸‰å…ƒ / å­—ä¸€è‰²</span><span>å°å››å–œ / å¤§å››å–œ</span><span>ç·‘ä¸€è‰² / æ¸…è€é ­</span><span>ä¹è“®å®ç‡ˆ / å››æ§“å­</span><span>å¤©å’Œ / åœ°å’Œ</span></div></div>
                </div>
                <div class="w-full shrink-0 snap-center overflow-y-auto px-2 max-h-full pb-4">
                    <h4 class="text-sm font-bold text-white bg-green-900 px-2 py-1 rounded border border-green-700 sticky top-0">ğŸ§® ç¬¦è¨ˆç®—ã®ãƒ«ãƒ¼ãƒ«</h4>
                    <div class="mt-2 space-y-2"><div class="bg-gray-700/50 p-1.5 rounded"><div class="text-xs font-bold text-yellow-300">â‘  åŸºæœ¬ç¬¦ (å‰¯åº•)</div><div class="text-[11px] text-gray-300 pl-2">ä¸€å¾‹ <span class="font-bold text-white">20ç¬¦</span></div></div><div class="bg-gray-700/50 p-1.5 rounded"><div class="text-xs font-bold text-yellow-300">â‘¡ ã‚¢ã‚¬ãƒªæ–¹</div><div class="text-[11px] text-gray-300 pl-2 flex justify-between"><span>é–€å‰ãƒ­ãƒ³: <span class="text-white font-bold">+10ç¬¦</span></span><span>ãƒ„ãƒ¢: <span class="text-white font-bold">+2ç¬¦</span></span></div></div><div class="bg-gray-700/50 p-1.5 rounded"><div class="text-xs font-bold text-yellow-300 mb-1">â‘¢ é¢å­ (ãƒ¡ãƒ³ãƒ„)</div><table class="w-full text-[10px] text-center border-collapse"><tr class="bg-gray-600 text-gray-200"><th class="p-0.5 border border-gray-500">ç¨®é¡</th><th class="p-0.5 border border-gray-500">æ˜åˆ»</th><th class="p-0.5 border border-gray-500">æš—åˆ»</th><th class="p-0.5 border border-gray-500">æ˜æ§“</th><th class="p-0.5 border border-gray-500">æš—æ§“</th></tr><tr class="text-gray-300"><td class="p-0.5 border border-gray-600">ä¸­å¼µç‰Œ<br><span class="text-[8px]">(2ã€œ8)</span></td><td class="border border-gray-600">2</td><td class="border border-gray-600">4</td><td class="border border-gray-600">8</td><td class="border border-gray-600">16</td></tr><tr class="text-gray-300"><td class="p-0.5 border border-gray-600">å¹ºä¹ç‰Œ<br><span class="text-[8px]">(1,9,å­—)</span></td><td class="border border-gray-600">4</td><td class="border border-gray-600">8</td><td class="border border-gray-600">16</td><td class="border border-gray-600">32</td></tr></table><div class="text-[9px] text-gray-400 mt-0.5">â€»é †å­(ã‚·ãƒ¥ãƒ³ãƒ„)ã¯ã™ã¹ã¦0ç¬¦</div></div><div class="bg-gray-700/50 p-1.5 rounded"><div class="text-xs font-bold text-yellow-300">â‘£ é›€é ­ (ã‚¢ã‚¿ãƒ) ã¨ â‘¤ å¾…ã¡</div><div class="text-[11px] text-gray-300 pl-2">å½¹ç‰Œã®é›€é ­: <span class="text-white font-bold">+2ç¬¦</span><br>åµŒå¼µ/è¾ºå¼µ/å˜é¨ å¾…ã¡: <span class="text-white font-bold">+2ç¬¦</span><br><span class="text-[9px] text-gray-400">â€»ä¸¡é¢ãƒ»åŒç¢°å¾…ã¡ã¯0ç¬¦</span></div></div><div class="bg-gray-700/50 p-1.5 rounded border border-red-900/50"><div class="text-xs font-bold text-red-400">â‘¥ ä¾‹å¤–ãƒ«ãƒ¼ãƒ«</div><div class="text-[11px] text-gray-300 pl-2">ä¸ƒå¯¾å­ (ãƒãƒ¼ãƒˆã‚¤ãƒ„): <span class="text-white font-bold">25ç¬¦å›ºå®š</span><br>å¹³å’Œãƒ„ãƒ¢: <span class="text-white font-bold">20ç¬¦å›ºå®š</span></div></div></div>
                </div>
            </div>
            <div class="flex justify-center items-center gap-2 pt-2 shrink-0 border-t border-gray-700" id="rule-dots"><div class="w-2 h-2 rounded-full bg-yellow-400 transition-colors"></div><div class="w-2 h-2 rounded-full bg-gray-600 transition-colors"></div></div>
            <div class="text-center text-[9px] text-gray-400 mt-1 shrink-0">â—€ å·¦å³ã«ãƒ•ãƒªãƒƒã‚¯ã—ã¦åˆ‡ã‚Šæ›¿ãˆ â–¶</div>
        </div>
    </div>
    
    <div id="transfer-modal" class="modal-overlay" onclick="closeTransferModal()">
        <div class="bg-gray-800 w-11/12 max-w-sm rounded-lg p-4 shadow-xl border border-gray-700 relative" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-yellow-400 mb-3 text-center border-b border-gray-700 pb-2">ç‚¹æ•°ã®ç§»å‹•</h3>
            <div class="mb-3"><div class="text-xs text-gray-400 mb-1">ğŸ€„ ã‚¢ã‚¬ã£ãŸäºº</div><div class="flex gap-1"><button id="ta-0" onclick="setTransferAgari(0)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold active">Aã•ã‚“</button><button id="ta-1" onclick="setTransferAgari(1)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold">Bã•ã‚“</button><button id="ta-2" onclick="setTransferAgari(2)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold">Cã•ã‚“</button><button id="ta-3" onclick="setTransferAgari(3)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold">Dã•ã‚“</button></div></div>
            <div id="transfer-furi-section" class="mb-3"><div class="text-xs text-gray-400 mb-1">ğŸ˜­ æŒ¯ã‚Šè¾¼ã‚“ã äºº</div><div class="flex gap-1"><button id="tf-0" onclick="setTransferFuri(0)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold">Aã•ã‚“</button><button id="tf-1" onclick="setTransferFuri(1)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold active">Bã•ã‚“</button><button id="tf-2" onclick="setTransferFuri(2)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold">Cã•ã‚“</button><button id="tf-3" onclick="setTransferFuri(3)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold">Dã•ã‚“</button></div></div>
            <div id="transfer-oya-section" class="mb-3 hidden"><div class="text-xs text-gray-400 mb-1">ğŸ‘‘ è¦ªã¯èª°ï¼Ÿ (è¦ªã‹ã¶ã‚Šè¨ˆç®—ç”¨)</div><div class="flex gap-1"><button id="to-0" onclick="setTransferOya(0)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold">Aã•ã‚“</button><button id="to-1" onclick="setTransferOya(1)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold active">Bã•ã‚“</button><button id="to-2" onclick="setTransferOya(2)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold">Cã•ã‚“</button><button id="to-3" onclick="setTransferOya(3)" class="btn-select flex-1 py-2 bg-gray-700 text-gray-300 rounded border border-gray-600 font-bold">Dã•ã‚“</button></div></div>
            <div class="text-center font-bold text-yellow-400 text-2xl my-3" id="transfer-amount-text">0 ç‚¹</div>
            <div class="flex gap-2"><button onclick="closeTransferModal()" class="w-1/3 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded shadow border border-gray-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button onclick="executeTransfer()" class="w-2/3 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded shadow-lg border border-yellow-400 active:scale-95 transition-transform">æ±ºå®šã—ã¦åæ˜ </button></div>
        </div>
    </div>

    <div id="camera-modal" class="modal-overlay flex-col"><video id="camera-video" class="w-full h-full object-cover" autoplay playsinline></video><div class="absolute inset-0 flex items-center justify-center pointer-events-none"><div class="w-11/12 h-1/3 border-4 border-yellow-400 rounded-lg flex items-center justify-center bg-black/20 backdrop-blur-sm"><span class="text-yellow-400 font-bold opacity-70 tracking-widest text-xl">æ å†…ã«ç‰Œã‚’ä¸¦ã¹ã¦ãã ã•ã„</span></div></div><div class="absolute bottom-8 w-full flex justify-around items-center px-8 pb-[env(safe-area-inset-bottom)]"><button onclick="closeCamera()" class="text-white bg-gray-800 px-6 py-3 rounded-full font-bold shadow-lg">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button onclick="takePhoto()" class="w-20 h-20 bg-white rounded-full border-4 border-gray-300 shadow-xl active:bg-gray-200"></button><div class="w-24"></div></div><canvas id="camera-canvas" class="hidden"></canvas></div>
    <div id="detail-modal" class="modal-overlay" onclick="closeDetail()"><div class="bg-gray-800 w-11/12 max-w-md rounded-lg p-4 shadow-xl border border-gray-700 relative max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()"><button onclick="closeDetail()" class="absolute top-2 right-2 text-gray-400 hover:text-white bg-gray-700 rounded-full w-8 h-8 flex items-center justify-center">âœ•</button><h3 class="text-lg font-bold text-yellow-400 mb-3 text-center border-b border-gray-700 pb-2">è¨ˆç®—è©³ç´°</h3><div id="detail-content" class="text-sm space-y-4"></div></div></div>

    <script>
        const TILES = { man: ['ğŸ€‡','ğŸ€ˆ','ğŸ€‰','ğŸ€Š','ğŸ€‹','ğŸ€Œ','ğŸ€','ğŸ€','ğŸ€'], pin: ['ğŸ€™','ğŸ€š','ğŸ€›','ğŸ€œ','ğŸ€','ğŸ€','ğŸ€Ÿ','ğŸ€ ','ğŸ€¡'], sou: ['ğŸ€','ğŸ€‘','ğŸ€’','ğŸ€“','ğŸ€”','ğŸ€•','ğŸ€–','ğŸ€—','ğŸ€˜'], ji: ['ğŸ€€','ğŸ€','ğŸ€‚','ğŸ€ƒ','ğŸ€†','ğŸ€…','ğŸ€„'] };
        const TYPE_ORDER = { 'man':0, 'pin':1, 'sou':2, 'ji':3 };
        const WINDS = ['æ±','å—','è¥¿','åŒ—'];
        let currentHand = []; let idCounter = 0;
        let settings = { prevalent: 0, seat: 0, winType: 'ron', reach: 0, dora: 0, honba: 0 };
        let lastCalculationResult = null; 

        function init() { renderPalette('man'); renderHand(); updateUI(); setupLongPress(); }
        function updateUI() {
            document.getElementById('btn-prevalent').textContent = WINDS[settings.prevalent] + "å ´";
            const sBtn = document.getElementById('btn-seat'); sBtn.textContent = WINDS[settings.seat] + "å®¶" + (settings.seat===0?"(è¦ª)":"(å­)"); sBtn.className = settings.seat===0 ? "bg-red-900 py-1.5 portrait:py-1 rounded text-xs font-bold border border-red-700 transition-all" : "bg-blue-900 py-1.5 portrait:py-1 rounded text-xs font-bold border border-blue-700 transition-all";
            const wBtn = document.getElementById('btn-win-type'); wBtn.textContent = settings.winType === 'ron' ? "ãƒ­ãƒ³ã‚ãŒã‚Š" : "ãƒ„ãƒ¢ã‚ãŒã‚Š"; wBtn.className = settings.winType === 'ron' ? "bg-red-800 py-1.5 portrait:py-1 rounded text-xs font-bold border border-red-600 transition-all" : "bg-green-700 py-1.5 portrait:py-1 rounded text-xs font-bold border border-green-600 transition-all";
            const rBtn = document.getElementById('btn-reach'); rBtn.textContent = ["ç«‹ç›´ãªã—", "ç«‹ç›´(1é£œ)", "Wç«‹ç›´(2é£œ)"][settings.reach]; rBtn.className = ["bg-gray-700 text-gray-400","bg-red-600 text-white","bg-yellow-600 text-white"][settings.reach] + " py-1.5 portrait:py-1 rounded text-xs font-bold border border-gray-600 transition-all";
            document.getElementById('dora-disp').textContent = settings.dora; document.getElementById('honba-disp').textContent = settings.honba;
        }
        function togglePrevalent() { settings.prevalent = (settings.prevalent+1)%2; updateUI(); }
        function toggleSeat() { settings.seat = (settings.seat+1)%4; updateUI(); }
        function toggleWinType() { settings.winType = settings.winType==='ron'?'tsumo':'ron'; updateUI(); }
        function toggleReach() { settings.reach = (settings.reach+1)%3; updateUI(); }
        function updCnt(k, d) { settings[k] = Math.max(0, settings[k]+d); updateUI(); }
        function renderPalette(type) {
            document.querySelectorAll('.tab-btn').forEach(b => { b.className = b.dataset.type===type ? "flex-1 py-1.5 rounded-t bg-blue-600 text-white text-xs font-bold tab-btn transition-colors" : "flex-1 py-1.5 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn transition-colors"; });
            const c = document.getElementById('tile-container'); c.innerHTML = '';
            TILES[type].forEach((char, i) => { const d = document.createElement('div'); d.className = `palette-tile ${['tile-man','tile-pin','tile-sou','tile-ji'][TYPE_ORDER[type]]}`; d.textContent = char; d.onclick = () => addTile(type, i+1, char); c.appendChild(d); });
        }
        function addTile(type, val, char) {
            if (currentHand.length < 14) { currentHand.push({ type, value: val, char, id: idCounter++, isAgari: false }); currentHand.sort((a,b) => { if (TYPE_ORDER[a.type] !== TYPE_ORDER[b.type]) return TYPE_ORDER[a.type] - TYPE_ORDER[b.type]; return a.value - b.value; }); renderHand(); }
        }
        function renderHand() {
            const c = document.getElementById('hand-container'); c.innerHTML = '';
            currentHand.forEach(t => {
                const d = document.createElement('div'); d.className = `tile ${['tile-man','tile-pin','tile-sou','tile-ji'][TYPE_ORDER[t.type]]}`; if (t.isAgari) d.classList.add('agari-tile'); d.textContent = t.char;
                let sy=0, sx=0, isDrag=false;
                d.addEventListener('touchstart', e=>{ sy=e.touches[0].clientY; sx=e.touches[0].clientX; isDrag=true; d.style.transition='none'; }, {passive:false});
                d.addEventListener('touchmove', e=>{ if(!isDrag)return; let dy = e.touches[0].clientY - sy; let dx = e.touches[0].clientX - sx; if(dy < 0 && Math.abs(dy) > Math.abs(dx)) { e.preventDefault(); d.style.transform=`translateY(${dy}px)`; d.style.opacity = dy<-50?'0.5':'1'; } }, {passive:false});
                d.addEventListener('touchend', e=>{ if(!isDrag)return; isDrag=false; let dy = e.changedTouches[0].clientY - sy; let dx = e.changedTouches[0].clientX - sx; d.style.transition='transform 0.2s, opacity 0.2s'; if(dy < -50 && Math.abs(dy) > Math.abs(dx)) { d.style.transform='translateY(-100px)'; d.style.opacity='0'; setTimeout(()=>{ currentHand = currentHand.filter(x=>x.id!==t.id); renderHand(); }, 200); } else if(Math.abs(dy)<10 && Math.abs(dx)<10) { d.style.transform=''; d.style.opacity='1'; currentHand.forEach(x => x.isAgari = (x.id === t.id)); renderHand(); } else { d.style.transform=''; d.style.opacity='1'; } });
                c.appendChild(d);
            });
            for(let i=currentHand.length; i<14; i++){ const d = document.createElement('div'); d.className='tile tile-empty'; c.appendChild(d); }
            const scrollView = document.getElementById('hand-scroll-view'); scrollView.scrollLeft = scrollView.scrollWidth;
        }
        
        function clearHand() { 
            currentHand=[]; renderHand(); document.getElementById('result-score').textContent="--- ç‚¹"; document.getElementById('result-yaku').textContent="å½¹ãªã—"; lastCalculationResult = null; 
            document.getElementById('btn-transfer').classList.add('hidden');
        }
        
        function openRulebook() { document.getElementById('rule-modal').classList.add('active'); }
        function closeRulebook() { document.getElementById('rule-modal').classList.remove('active'); }
        function updateRuleDots() { const container = document.getElementById('rule-scroll-container'); const dots = document.getElementById('rule-dots').children; const pageIndex = Math.round(container.scrollLeft / container.clientWidth); for(let i = 0; i < dots.length; i++) { dots[i].className = i === pageIndex ? "w-2 h-2 rounded-full bg-yellow-400 transition-colors" : "w-2 h-2 rounded-full bg-gray-600 transition-colors"; } }

        let videoStream = null;
        async function openCamera() { const modal = document.getElementById('camera-modal'); const video = document.getElementById('camera-video'); modal.classList.add('active'); try { videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false }); video.srcObject = videoStream; } catch (err) { alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); closeCamera(); } }
        function closeCamera() { const modal = document.getElementById('camera-modal'); modal.classList.remove('active'); if (videoStream) { videoStream.getTracks().forEach(track => track.stop()); videoStream = null; } }
        function takePhoto() { const video = document.getElementById('camera-video'); video.style.opacity = '0.2'; setTimeout(() => { video.style.opacity = '1'; }, 100); simulateImageRecognition(); closeCamera(); }
        function simulateImageRecognition() { clearHand(); const mockTiles = [{t:'man', v:2}, {t:'man', v:3}, {t:'man', v:4}, {t:'pin', v:3}, {t:'pin', v:4}, {t:'pin', v:5}, {t:'sou', v:6}, {t:'sou', v:7}, {t:'sou', v:8}, {t:'sou', v:2}, {t:'sou', v:2}, {t:'sou', v:2}, {t:'man', v:8}, {t:'man', v:8}]; mockTiles.forEach(item => { addTile(item.t, item.v, TILES[item.t][item.v - 1]); }); if(currentHand.length>0) { currentHand[currentHand.length-1].isAgari=true; renderHand(); } alert("ğŸ“· ãƒ‡ãƒ¢: ãƒ€ãƒŸãƒ¼ã®æ‰‹ç‰Œã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ"); }

        let pressTimer;
        function setupLongPress() {
            const target = document.getElementById('score-container');
            target.addEventListener('touchstart', (e) => { 
                if (e.target.id === 'btn-transfer') return; 
                if (!lastCalculationResult) return; 
                target.classList.add('press-active'); 
                pressTimer = setTimeout(() => { openDetail(lastCalculationResult); target.classList.remove('press-active'); }, 500); 
            }, {passive: true});
            ['touchend', 'touchmove', 'touchcancel'].forEach(evt => { target.addEventListener(evt, () => { clearTimeout(pressTimer); target.classList.remove('press-active'); }, {passive: true}); });
        }
        function openDetail(res) {
            if(!res || !res.fuDetails) return; const modal = document.getElementById('detail-modal'); const content = document.getElementById('detail-content');
            let html = `<div class="bg-gray-900/50 p-2 rounded border border-gray-700"><h4 class="font-bold text-yellow-300 mb-1">ğŸ€„ ç¬¦è¨ˆç®—ã®å†…è¨³</h4><ul class="list-disc list-inside text-gray-300 space-y-1">`;
            let totalFuRaw = 0; res.fuDetails.forEach(d => { html += `<li class="flex justify-between"><span>${d.text}</span><span>+${d.points} ç¬¦</span></li>`; totalFuRaw += d.points; });
            html += `</ul><div class="border-t border-gray-600 mt-2 pt-1 flex justify-between font-bold"><span>åˆè¨ˆ</span><span>${totalFuRaw} ç¬¦</span></div><div class="flex justify-between text-yellow-400 mt-1"><span>åˆ‡ã‚Šä¸Šã’å¾Œ</span><span class="text-lg">${res.fu} ç¬¦</span></div></div><div class="bg-gray-900/50 p-2 rounded border border-gray-700 flex justify-between items-center mt-3"><span class="font-bold text-yellow-300">ğŸ€… é£œæ•°</span><span class="text-lg font-bold">${res.han} é£œ</span></div><div class="text-center text-gray-400 text-xs mt-3">åŸºæœ¬ç‚¹ = ç¬¦ Ã— 2^(é£œæ•°+2)<br>(æº€è²«ä»¥ä¸Šã¯å›ºå®šç‚¹)</div>`;
            content.innerHTML = html; modal.classList.add('active');
        }
        function closeDetail() { document.getElementById('detail-modal').classList.remove('active'); }

        function calculateFull() {
            const resScore = document.getElementById('result-score'); const resYaku = document.getElementById('result-yaku');
            if (currentHand.length !== 14) { resScore.textContent = "æšæ•°ä¸è¶³"; resYaku.textContent = "ç‰Œã¯14æšå¿…è¦ã§ã™"; lastCalculationResult = null; return; }
            const agariTileData = currentHand.find(t => t.isAgari);
            if (!agariTileData) { resScore.textContent = "æŒ‡å®šãªã—"; resYaku.textContent = "ä¸ŠãŒã‚Šç‰Œã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„"; lastCalculationResult = null; return; }
            const agariTileStr = agariTileData.type + agariTileData.value;
            const counts = {}; currentHand.forEach(t => { const k = t.type + t.value; counts[k] = (counts[k]||0) + 1; });
            const pairs = Object.values(counts).filter(c => c === 2).length;
            if (pairs === 7) { const res = calcChiitoiResult(counts); displayResult(res, resScore, resYaku); lastCalculationResult = res; document.getElementById('btn-transfer').classList.remove('hidden'); return; }
            const decompositions = decompose(counts);
            if (decompositions.length === 0) { 
                if (isKokushi(counts)) { 
                    const score = settings.seat===0 ? 48000 : 32000; 
                    const pay = settings.seat===0 ? { type: settings.winType, total: score + settings.honba*300 } : { type: settings.winType, total: score + settings.honba*300 };
                    if(settings.winType !== 'ron') {
                        if(settings.seat===0) { pay.type='tsumo_oya'; pay.ko = 16000 + settings.honba*100; }
                        else { pay.type='tsumo_ko'; pay.oya = 16000 + settings.honba*100; pay.ko = 8000 + settings.honba*100; }
                    }
                    resScore.textContent = `${score}ç‚¹`; resYaku.textContent = "å½¹æº€ å›½å£«ç„¡åŒ"; 
                    lastCalculationResult = { han:13, fu:0, score: score+settings.honba*300, yakuNames:["å›½å£«ç„¡åŒ"], fuDetails:[], payments: pay }; 
                    document.getElementById('btn-transfer').classList.remove('hidden'); return; 
                } 
                resScore.textContent = "å½¹ãªã—"; resYaku.textContent = "ã‚¢ã‚¬ãƒªå½¢ã«ãªã£ã¦ã„ã¾ã›ã‚“"; lastCalculationResult = null; return; 
            }
            let bestResult = { han: 0, fu: 0, score: -1, yakuNames: [], fuDetails: [] };
            decompositions.forEach(groups => { const res = evalHand(groups, counts, agariTileStr); if (res.score > bestResult.score || (res.score === bestResult.score && res.han > bestResult.han)) { bestResult = res; } });
            if (bestResult.score === -1 || bestResult.han === 0) { 
                resScore.textContent = "å½¹ãªã—"; resYaku.textContent = "ã‚¢ã‚¬ãƒªå½¢ã§ã™ãŒå½¹ãŒã‚ã‚Šã¾ã›ã‚“"; lastCalculationResult = null; document.getElementById('btn-transfer').classList.add('hidden');
            } else { 
                displayResult(bestResult, resScore, resYaku); lastCalculationResult = bestResult; document.getElementById('btn-transfer').classList.remove('hidden'); 
            }
        }
        function decompose(counts) { const results = []; const keys = Object.keys(counts); keys.forEach(headKey => { if (counts[headKey] >= 2) { const workingCounts = {...counts}; workingCounts[headKey] -= 2; const headGroup = { type: 'head', tile: headKey }; const mentsuRes = decomposeMentsu(workingCounts); mentsuRes.forEach(mList => { results.push([headGroup, ...mList]); }); } }); return results; }
        function decomposeMentsu(c) { let first = null; const keys = ['man','pin','sou','ji']; for(let t of keys) { const limit = t==='ji'?7:9; for(let v=1; v<=limit; v++) { if (c[t+v] > 0) { first = t+v; break; } } if(first) break; } if (!first) return [[]]; const results = []; const type = first.substring(0, first.length-1); const val = parseInt(first.substring(first.length-1)); if (c[first] >= 3) { const nextC = {...c}; nextC[first] -= 3; const tails = decomposeMentsu(nextC); tails.forEach(t => { results.push([{type:'koutsu', tile:first}, ...t]); }); } if (type !== 'ji' && val <= 7) { const k1 = type + val; const k2 = type + (val+1); const k3 = type + (val+2); if (c[k1]>0 && c[k2]>0 && c[k3]>0) { const nextC = {...c}; nextC[k1]--; nextC[k2]--; nextC[k3]--; const tails = decomposeMentsu(nextC); tails.forEach(t => { results.push([{type:'shuntsu', tile:k1}, ...t]); }); } } return results; }
        function isKokushi(c) { const yaochu = ['man1','man9','pin1','pin9','sou1','sou9','ji1','ji2','ji3','ji4','ji5','ji6','ji7']; const keys = Object.keys(c); if(keys.length !== 13) return false; return keys.every(k => yaochu.includes(k)); }
        function evalHand(groups, counts, agariTileStr) {
            let bestRes = { han: 0, fu: 0, score: -1, yakuNames: [], fuDetails: [] };
            const head = groups.find(g => g.type === 'head'); const mentsu = groups.filter(g => g.type !== 'head'); const shuntsu = mentsu.filter(g => g.type === 'shuntsu'); const koutsu = mentsu.filter(g => g.type === 'koutsu');
            let possibleWaits = []; if (head.tile === agariTileStr) possibleWaits.push({ type: 'tanki', fu: 2, pinfu: false, name: 'å˜é¨å¾…ã¡' });
            koutsu.forEach(k => { if (k.tile === agariTileStr) possibleWaits.push({ type: 'shanpon', fu: 0, pinfu: false, name: 'åŒç¢°å¾…ã¡', targetGroup: k }); });
            shuntsu.forEach(s => { let t = s.tile.slice(0, -1), v = parseInt(s.tile.slice(-1)); let aT = agariTileStr.slice(0, -1), aV = parseInt(agariTileStr.slice(-1)); if (t === aT) { if (aV === v + 1) possibleWaits.push({ type: 'kanchan', fu: 2, pinfu: false, name: 'åµŒå¼µå¾…ã¡' }); else if (aV === v && v === 7) possibleWaits.push({ type: 'penchan', fu: 2, pinfu: false, name: 'è¾ºå¼µå¾…ã¡' }); else if (aV === v + 2 && v === 1) possibleWaits.push({ type: 'penchan', fu: 2, pinfu: false, name: 'è¾ºå¼µå¾…ã¡' }); else if (aV === v || aV === v + 2) possibleWaits.push({ type: 'ryanmen', fu: 0, pinfu: true, name: 'ä¸¡é¢å¾…ã¡' }); } });
            let baseHan = 0; let baseYaku = []; if (settings.reach === 1) { baseHan+=1; baseYaku.push("ç«‹ç›´(1)"); } if (settings.reach === 2) { baseHan+=2; baseYaku.push("Wç«‹ç›´(2)"); } if (settings.winType === 'tsumo') { baseHan+=1; baseYaku.push("é–€å‰æ¸…è‡ªæ‘¸(1)"); } if (settings.dora > 0) { baseHan+=settings.dora; baseYaku.push(`ãƒ‰ãƒ©(${settings.dora})`); }
            const isTanyao = Object.keys(counts).every(k => { const t = k.slice(0,-1), v=parseInt(k.slice(-1)); return t!=='ji' && v>1 && v<9; }); if (isTanyao) { baseHan+=1; baseYaku.push("æ–­å¹ºä¹(1)"); }
            let yakuhaiHan = 0; koutsu.forEach(k => { if (k.tile === 'ji5' || k.tile === 'ji6' || k.tile === 'ji7') yakuhaiHan++; if (k.tile === `ji${settings.prevalent+1}`) yakuhaiHan++; if (k.tile === `ji${settings.seat+1}`) yakuhaiHan++; }); if (yakuhaiHan>0) { baseHan+=yakuhaiHan; baseYaku.push(`å½¹ç‰Œ(${yakuhaiHan})`); }
            const headVal = parseInt(head.tile.slice(-1)); const headType = head.tile.slice(0,-1); const isHeadYakuhai = (headType==='ji' && (headVal>=5 || headVal===settings.prevalent+1 || headVal===settings.seat+1));
            let iipeiko = 0; const seqStr = shuntsu.map(s => s.tile).sort(); for(let i=0; i<seqStr.length-1; i++) { if(seqStr[i] === seqStr[i+1]) { iipeiko++; i++; } } if(iipeiko === 1) { baseHan+=1; baseYaku.push("ä¸€ç›ƒå£(1)"); } if(iipeiko === 2) { baseHan+=3; baseYaku.push("äºŒç›ƒå£(3)"); }
            const types = new Set(Object.keys(counts).map(k=>k.slice(0,-1))); const hasJi = types.has('ji'); types.delete('ji'); if(types.size === 1) { if(hasJi) { baseHan+=3; baseYaku.push("æ··ä¸€è‰²(3)"); } else { baseHan+=6; baseYaku.push("æ¸…ä¸€è‰²(6)"); } }
            if (koutsu.length === 4) { baseHan+=2; baseYaku.push("å¯¾ã€…å’Œ(2)"); }
            const sMap = {man:[], pin:[], sou:[]}; shuntsu.forEach(s => sMap[s.tile.slice(0,-1)].push(parseInt(s.tile.slice(-1)))); let sanshoku = false; sMap.man.forEach(v => { if(sMap.pin.includes(v) && sMap.sou.includes(v)) sanshoku = true; }); if(sanshoku) { baseHan+=2; baseYaku.push("ä¸‰è‰²åŒé †(2)"); }
            let ittsu = false; ['man','pin','sou'].forEach(t => { const vals = shuntsu.filter(s=>s.tile.startsWith(t)).map(s=>parseInt(s.tile.slice(-1))); if(vals.includes(1) && vals.includes(4) && vals.includes(7)) ittsu = true; }); if(ittsu) { baseHan+=2; baseYaku.push("ä¸€æ°—é€šè²«(2)"); }
            possibleWaits.forEach(wait => {
                let han = baseHan; let yaku = [...baseYaku]; let fuDetails = [{ text: 'å‰¯åº•', points: 20 }]; let fu = 20;
                const isPinfu = (shuntsu.length === 4 && !isHeadYakuhai && wait.pinfu); if (isPinfu) { han += 1; yaku.push("å¹³å’Œ(1)"); }
                let ankouCount = 0; koutsu.forEach(k => { let isAnkou = true; if (wait.type === 'shanpon' && wait.targetGroup === k && settings.winType === 'ron') { isAnkou = false; } if (isAnkou) ankouCount++; });
                if (ankouCount === 3) { han += 2; yaku.push("ä¸‰æš—åˆ»(2)"); } if (ankouCount === 4) { han += 8; yaku.push("å››æš—åˆ»(å½¹æº€)"); }
                if (settings.winType === 'ron') { fu += 10; fuDetails.push({ text: 'é–€å‰åŠ ç¬¦', points: 10 }); } if (settings.winType === 'tsumo') { fu += 2; fuDetails.push({ text: 'ãƒ„ãƒ¢ç¬¦', points: 2 }); }
                koutsu.forEach(k => { const t = k.tile.slice(0,-1), v=parseInt(k.tile.slice(-1)); const isYaochu = (t==='ji' || v===1 || v===9); let isAnkou = true; if (wait.type === 'shanpon' && wait.targetGroup === k && settings.winType === 'ron') { isAnkou = false; } const p = isYaochu ? (isAnkou ? 8 : 4) : (isAnkou ? 4 : 2); fu += p; fuDetails.push({ text: `${isYaochu?'å¹ºä¹':'ä¸­å¼µ'}${isAnkou?'æš—åˆ»':'æ˜åˆ»'}`, points: p }); });
                if (isHeadYakuhai) { fu += 2; fuDetails.push({ text: 'å½¹ç‰Œé›€é ­', points: 2 }); } if (wait.fu > 0) { fu += wait.fu; fuDetails.push({ text: wait.name, points: wait.fu }); }
                if (isPinfu && settings.winType === 'tsumo') { fu = 20; fuDetails = [{ text: 'å¹³å’Œãƒ„ãƒ¢(å›ºå®š)', points: 20 }]; } else { fu = Math.ceil(fu/10)*10; }
                let res = calculateFinalScore(han, fu, yaku, fuDetails); if (res.score > bestRes.score || (res.score === bestRes.score && res.han > bestRes.han)) { bestRes = res; }
            });
            return bestRes.score === -1 ? { han: 0, fu: 0, score: 0, yakuNames: [], fuDetails: [] } : bestRes;
        }
        function calcChiitoiResult(counts) { let han=2; let yaku=["ä¸ƒå¯¾å­(2)"]; if(settings.reach===1) {han++; yaku.push("ç«‹ç›´(1)");} if(settings.reach===2) {han+=2; yaku.push("Wç«‹ç›´(2)");} if(settings.winType==='tsumo') {han++; yaku.push("é–€å‰æ¸…è‡ªæ‘¸(1)");} if(settings.dora>0) {han+=settings.dora; yaku.push(`ãƒ‰ãƒ©(${settings.dora})`);} const isTanyao = Object.keys(counts).every(k => { const t = k.slice(0,-1), v=parseInt(k.slice(-1)); return t!=='ji' && v>1 && v<9; }); if (isTanyao) { han++; yaku.push("æ–­å¹ºä¹(1)"); } const types = new Set(Object.keys(counts).map(k=>k.slice(0,-1))); const hasJi = types.has('ji'); types.delete('ji'); if(types.size===1) { if(hasJi){han+=3;yaku.push("æ··ä¸€è‰²(3)");} else{han+=6;yaku.push("æ¸…ä¸€è‰²(6)");} } const fuDetails = [{ text: 'ä¸ƒå¯¾å­(å›ºå®š)', points: 25 }]; return calculateFinalScore(han, 25, yaku, fuDetails); }
        function calculateFinalScore(han, fu, yakuNames, fuDetails) { 
            let base = fu * Math.pow(2, han+2); if(han>=5) base=2000; if(han>=6) base=3000; if(han>=8) base=4000; if(han>=11) base=6000; if(han>=13) base=8000; 
            let score=0; let payments = { type: '', total: 0, ko: 0, oya: 0 };
            let honba = settings.honba;
            if(settings.seat===0){ 
                if (settings.winType==='ron') { score = Math.ceil((base*6)/100)*100; payments = { type: 'ron', total: score + honba*300 }; } 
                else { let k = Math.ceil((base*2)/100)*100; score = k * 3; payments = { type: 'tsumo_oya', total: score + honba*300, ko: k + honba*100 }; }
            } else { 
                if (settings.winType==='ron') { score = Math.ceil((base*4)/100)*100; payments = { type: 'ron', total: score + honba*300 }; } 
                else { let o = Math.ceil((base*2)/100)*100; let k = Math.ceil((base*1)/100)*100; score = o + k*2; payments = { type: 'tsumo_ko', total: score + honba*300, oya: o + honba*100, ko: k + honba*100 }; }
            }
            score += honba * 300; return { han, fu, score, yakuNames, fuDetails, payments }; 
        }
        function displayResult(res, elScore, elYaku) { elScore.textContent = `${res.score}ç‚¹`; elYaku.textContent = `${res.han}é£œ ${res.fu}ç¬¦\n${res.yakuNames.join(' ')}`; }
        init();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // ==========================================
        // â˜…â˜…â˜… ã“ã“ã‚’æ›¸ãæ›ãˆã‚‹ â˜…â˜…â˜…
Â  const firebaseConfig = {
Â  Â  apiKey: "AIzaSyBNYx05vPh_8H217AP4sVYOq7Xu3k9vzVA",
Â  Â  authDomain: "mj-score-app.firebaseapp.com",
Â  Â  projectId: "mj-score-app",
Â  Â  storageBucket: "mj-score-app.firebasestorage.app",
Â  Â  messagingSenderId: "772380184697",
Â  Â  appId: "1:772380184697:web:e4f42a83baf9910bacc4a8"
Â  };
        // ==========================================

        let app, db, currentRoomId = null;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); } catch(e) { console.error(e); }

        window.createRoom = async function() {
            if (!db) return alert("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­å®šãŒæœªå®Œäº†ã§ã™ã€‚");
            const roomId = Math.floor(1000 + Math.random() * 9000).toString(); 
            try {
                await setDoc(doc(db, "rooms", roomId), { scores: [25000, 25000, 25000, 25000] });
                window.joinRoom(roomId);
                alert(`å“ã‚’ä½œã‚Šã¾ã—ãŸï¼\nã¿ã‚“ãªã« ãƒ«ãƒ¼ãƒ ID:ã€ ${roomId} ã€‘ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚`);
            } catch(e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
        }

        window.joinRoom = function(id) {
            if (!db) return;
            const roomId = id || prompt("4æ¡ã®ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if(!roomId) return;
            currentRoomId = roomId;
            onSnapshot(doc(db, "rooms", roomId), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('score-0').textContent = data.scores[0];
                    document.getElementById('score-1').textContent = data.scores[1];
                    document.getElementById('score-2').textContent = data.scores[2];
                    document.getElementById('score-3').textContent = data.scores[3];
                }
            });
            document.getElementById('room-id-display').textContent = roomId;
        }

        let t_agari = 0, t_furi = 1, t_oya = 1;

        window.openTransferModal = function(e) {
            if(e) e.stopPropagation();
            if(!lastCalculationResult) return;
            
            const p = lastCalculationResult.payments;
            document.getElementById('transfer-amount-text').textContent = p.total + " ç‚¹";
            
            if(p.type === 'ron') {
                document.getElementById('transfer-furi-section').classList.remove('hidden');
                document.getElementById('transfer-oya-section').classList.add('hidden');
            } else if (p.type === 'tsumo_ko') {
                document.getElementById('transfer-furi-section').classList.add('hidden');
                document.getElementById('transfer-oya-section').classList.remove('hidden');
            } else { 
                document.getElementById('transfer-furi-section').classList.add('hidden');
                document.getElementById('transfer-oya-section').classList.add('hidden');
            }
            
            document.getElementById('transfer-modal').classList.add('active');
        }

        window.closeTransferModal = function() { document.getElementById('transfer-modal').classList.remove('active'); }

        window.setTransferAgari = function(val) { t_agari = val; updateTransferBtns('ta', val); }
        window.setTransferFuri = function(val) { t_furi = val; updateTransferBtns('tf', val); }
        window.setTransferOya = function(val) { t_oya = val; updateTransferBtns('to', val); }
        
        function updateTransferBtns(prefix, val) {
            for(let i=0; i<4; i++) {
                const btn = document.getElementById(`${prefix}-${i}`);
                if(i === val) { btn.classList.add('active'); btn.classList.replace('text-gray-300', 'text-gray-900'); }
                else { btn.classList.remove('active'); btn.classList.replace('text-gray-900', 'text-gray-300'); }
            }
        }

        window.executeTransfer = async function() {
            const p = lastCalculationResult.payments;
            let diff = [0, 0, 0, 0];
            
            diff[t_agari] += p.total;
            
            if(p.type === 'ron') {
                if(t_agari === t_furi) return alert("ã‚¢ã‚¬ã£ãŸäººã¨æŒ¯ã‚Šè¾¼ã‚“ã äººã¯åŒã˜ã«ã§ãã¾ã›ã‚“ï¼");
                diff[t_furi] -= p.total;
            } else if (p.type === 'tsumo_oya') {
                for(let i=0; i<4; i++) { if(i !== t_agari) diff[i] -= p.ko; }
            } else if (p.type === 'tsumo_ko') {
                if(t_agari === t_oya) return alert("ã‚¢ã‚¬ã£ãŸäººã¨è¦ªã¯åŒã˜ã«ã§ãã¾ã›ã‚“ï¼");
                for(let i=0; i<4; i++) {
                    if(i === t_agari) continue;
                    if(i === t_oya) diff[i] -= p.oya;
                    else diff[i] -= p.ko;
                }
            }

            let newScores = [
                parseInt(document.getElementById('score-0').textContent) + diff[0],
                parseInt(document.getElementById('score-1').textContent) + diff[1],
                parseInt(document.getElementById('score-2').textContent) + diff[2],
                parseInt(document.getElementById('score-3').textContent) + diff[3]
            ];

            if (currentRoomId && db) {
                try {
                    await updateDoc(doc(db, "rooms", currentRoomId), { scores: newScores });
                } catch(e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + e.message); return; }
            } else {
                document.getElementById('score-0').textContent = newScores[0];
                document.getElementById('score-1').textContent = newScores[1];
                document.getElementById('score-2').textContent = newScores[2];
                document.getElementById('score-3').textContent = newScores[3];
            }

            closeTransferModal();
            clearHand(); 
        }
    </script>
</body>
</html>