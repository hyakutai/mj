<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éº»é›€ç‚¹æ•°è¨ˆç®—æ©Ÿ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* UIã‚¹ã‚¿ã‚¤ãƒ« (å‰å›ã¨åŒã˜) */
        body { font-family: sans-serif; background-color: #1a202c; color: white; height: 100vh; overflow: hidden; user-select: none; touch-action: manipulation; }
        .tile { width: 2.8rem; height: 3.8rem; display: flex; align-items: center; justify-content: center; background-color: #f7fafc; border-radius: 0.25rem; font-size: 2.2rem; line-height: 1; box-shadow: 0 3px 5px rgba(0,0,0,0.4); cursor: pointer; position: relative; transition: transform 0.1s; touch-action: none; color: #333; }
        .tile-man { color: #c53030; } .tile-pin { color: #2b6cb0; } .tile-sou { color: #2f855a; } .tile-ji { color: #000; }
        .tile-empty { background-color: transparent; border: 2px dashed #4a5568; box-shadow: none; color: transparent; }
        .agari-tile { border: 3px solid #ecc94b; transform: translateY(-4px); z-index: 10; }
        .agari-tile::after { content: 'å’Œ'; position: absolute; top: -10px; right: -8px; background-color: #e53e3e; color: white; font-size: 0.6rem; width: 1.2rem; height: 1.2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid white; font-weight: bold; }
        .palette-tile { width: 100%; height: 3.5rem; display: flex; align-items: center; justify-content: center; background-color: #f7fafc; border-radius: 0.25rem; font-size: 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col h-full p-2 box-border text-gray-100">

    <div class="flex flex-1 gap-2 mb-2 min-h-0">
        <div class="w-1/3 bg-gray-800 rounded-lg p-3 flex flex-col gap-2 shadow-lg overflow-y-auto no-scrollbar border border-gray-700">
            <div class="grid grid-cols-2 gap-2">
                <button id="btn-prevalent" class="bg-gray-700 py-1 rounded text-xs font-bold border border-gray-600" onclick="togglePrevalent()">æ±å ´</button>
                <button id="btn-seat" class="bg-red-900 py-1 rounded text-xs font-bold border border-red-700" onclick="toggleSeat()">æ±å®¶(è¦ª)</button>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button id="btn-win-type" class="bg-red-800 py-1 rounded text-xs font-bold border border-red-600" onclick="toggleWinType()">ãƒ­ãƒ³ã‚ãŒã‚Š</button>
                <button id="btn-reach" class="bg-gray-700 py-1 rounded text-xs font-bold border border-gray-600 text-gray-400" onclick="toggleReach()">ç«‹ç›´ãªã—</button>
            </div>
            <div class="flex items-center justify-between bg-gray-700 px-2 py-1 rounded border border-gray-600">
                <span class="text-xs">ãƒ‰ãƒ©</span>
                <div class="flex items-center gap-2">
                    <button class="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-sm" onclick="updCnt('dora',-1)">-</button>
                    <span id="dora-disp" class="font-mono text-sm w-4 text-center text-yellow-400">0</span>
                    <button class="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-sm" onclick="updCnt('dora',1)">+</button>
                </div>
            </div>
            <div class="flex items-center justify-between bg-gray-700 px-2 py-1 rounded border border-gray-600">
                <span class="text-xs">æœ¬å ´</span>
                <div class="flex items-center gap-2">
                    <button class="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-sm" onclick="updCnt('honba',-1)">-</button>
                    <span id="honba-disp" class="font-mono text-sm w-4 text-center">0</span>
                    <button class="w-6 h-6 bg-gray-600 rounded flex items-center justify-center text-sm" onclick="updCnt('honba',1)">+</button>
                </div>
            </div>

            <div class="mt-auto bg-gray-900 p-2 rounded border border-gray-700 flex flex-col justify-center min-h-[5rem]">
                <div id="result-score" class="text-center text-2xl font-bold text-yellow-400">--- ç‚¹</div>
                <div id="result-yaku" class="text-center text-[10px] text-gray-300 mt-1 leading-tight whitespace-pre-wrap">å½¹ãªã—</div>
            </div>
        </div>

        <div class="w-2/3 bg-gray-800 rounded-lg p-2 flex flex-col shadow-lg border border-gray-700">
            <div class="flex gap-1 mb-1">
                <button onclick="renderPalette('man')" class="flex-1 py-1 rounded-t bg-blue-600 text-white text-xs font-bold tab-btn" data-type="man">è¬å­</button>
                <button onclick="renderPalette('pin')" class="flex-1 py-1 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn" data-type="pin">ç­’å­</button>
                <button onclick="renderPalette('sou')" class="flex-1 py-1 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn" data-type="sou">ç´¢å­</button>
                <button onclick="renderPalette('ji')" class="flex-1 py-1 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn" data-type="ji">å­—ç‰Œ</button>
            </div>
            <div id="tile-container" class="grid grid-cols-9 gap-1 auto-rows-min overflow-y-auto flex-1 content-start p-1 bg-gray-900 rounded"></div>
        </div>
    </div>

    <div class="h-28 bg-green-900 rounded-lg p-1 flex flex-col items-center justify-center relative border-b-4 border-green-950 shadow-inner overflow-hidden">
        <div class="text-[10px] text-green-200 opacity-60 font-mono absolute top-1 left-2">TAP:ä¸ŠãŒã‚Šç‰ŒæŒ‡å®š / UP-FLICK:å‰Šé™¤</div>
        <div id="hand-container" class="flex gap-1 z-10 mt-2 scale-90 sm:scale-100"></div>
        <div class="absolute right-2 bottom-2 flex gap-2 z-20">
            <button onclick="clearHand()" class="bg-red-900/80 hover:bg-red-800 text-white px-3 py-2 rounded text-xs font-bold border border-red-700">ã‚¯ãƒªã‚¢</button>
            <button onclick="calculateFull()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-6 py-2 rounded font-bold text-sm shadow-lg border border-yellow-400">è¨ˆç®—</button>
        </div>
    </div>

    <script>
        // --- 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»åˆæœŸè¨­å®š ---
        const TILES = {
            man: ['ğŸ€‡','ğŸ€ˆ','ğŸ€‰','ğŸ€Š','ğŸ€‹','ğŸ€Œ','ğŸ€','ğŸ€','ğŸ€'],
            pin: ['ğŸ€™','ğŸ€š','ğŸ€›','ğŸ€œ','ğŸ€','ğŸ€','ğŸ€Ÿ','ğŸ€ ','ğŸ€¡'],
            sou: ['ğŸ€','ğŸ€‘','ğŸ€’','ğŸ€“','ğŸ€”','ğŸ€•','ğŸ€–','ğŸ€—','ğŸ€˜'],
            ji:  ['ğŸ€€','ğŸ€','ğŸ€‚','ğŸ€ƒ','ğŸ€†','ğŸ€…','ğŸ€„']
        };
        const TYPE_ORDER = { 'man':0, 'pin':1, 'sou':2, 'ji':3 };
        const WINDS = ['æ±','å—','è¥¿','åŒ—'];
        let currentHand = []; // {type, value, char, id, isAgari}
        let idCounter = 0;
        
        let settings = {
            prevalent: 0, // 0:æ±, 1:å—
            seat: 0,      // 0:æ±, 1:å—, 2:è¥¿, 3:åŒ—
            winType: 'ron', // 'ron' or 'tsumo'
            reach: 0,     // 0:ãªã—, 1:ç«‹ç›´, 2:ãƒ€ãƒ–ãƒªãƒ¼
            dora: 0,
            honba: 0
        };

        function init() { renderPalette('man'); renderHand(); updateUI(); }

        // --- 2. UIæ“ä½œç³» ---
        function updateUI() {
            document.getElementById('btn-prevalent').textContent = WINDS[settings.prevalent] + "å ´";
            
            const sBtn = document.getElementById('btn-seat');
            sBtn.textContent = WINDS[settings.seat] + "å®¶" + (settings.seat===0?"(è¦ª)":"(å­)");
            sBtn.className = settings.seat===0 ? "bg-red-900 py-1 rounded text-xs font-bold border border-red-700 w-full" : "bg-blue-900 py-1 rounded text-xs font-bold border border-blue-700 w-full";

            const wBtn = document.getElementById('btn-win-type');
            wBtn.textContent = settings.winType === 'ron' ? "ãƒ­ãƒ³ã‚ãŒã‚Š" : "ãƒ„ãƒ¢ã‚ãŒã‚Š";
            wBtn.className = settings.winType === 'ron' ? "bg-red-800 py-1 rounded text-xs font-bold border border-red-600 w-full" : "bg-green-700 py-1 rounded text-xs font-bold border border-green-600 w-full";

            const rBtn = document.getElementById('btn-reach');
            rBtn.textContent = ["ç«‹ç›´ãªã—", "ç«‹ç›´(1é£œ)", "Wç«‹ç›´(2é£œ)"][settings.reach];
            rBtn.className = ["bg-gray-700 text-gray-400","bg-red-600 text-white","bg-yellow-600 text-white"][settings.reach] + " py-1 rounded text-xs font-bold border border-gray-600 w-full";

            document.getElementById('dora-disp').textContent = settings.dora;
            document.getElementById('honba-disp').textContent = settings.honba;
        }

        function togglePrevalent() { settings.prevalent = (settings.prevalent+1)%2; updateUI(); }
        function toggleSeat() { settings.seat = (settings.seat+1)%4; updateUI(); }
        function toggleWinType() { settings.winType = settings.winType==='ron'?'tsumo':'ron'; updateUI(); }
        function toggleReach() { settings.reach = (settings.reach+1)%3; updateUI(); }
        function updCnt(k, d) { settings[k] = Math.max(0, settings[k]+d); updateUI(); }

        // --- 3. æ‰‹ç‰Œãƒ»ãƒ‘ãƒ¬ãƒƒãƒˆæ“ä½œ (ã‚¿ãƒƒãƒUI) ---
        function renderPalette(type) {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.className = b.dataset.type===type 
                    ? "flex-1 py-1 rounded-t bg-blue-600 text-white text-xs font-bold tab-btn"
                    : "flex-1 py-1 rounded-t bg-gray-700 text-gray-300 text-xs font-bold tab-btn";
            });
            const c = document.getElementById('tile-container');
            c.innerHTML = '';
            TILES[type].forEach((char, i) => {
                const d = document.createElement('div');
                d.className = `palette-tile ${['tile-man','tile-pin','tile-sou','tile-ji'][TYPE_ORDER[type]]}`;
                d.textContent = char;
                d.onclick = () => addTile(type, i+1, char);
                c.appendChild(d);
            });
        }

        function addTile(type, val, char) {
            if (currentHand.length < 14) {
                currentHand.push({ type, value: val, char, id: idCounter++, isAgari: false });
                currentHand.sort((a,b) => {
                    if (TYPE_ORDER[a.type] !== TYPE_ORDER[b.type]) return TYPE_ORDER[a.type] - TYPE_ORDER[b.type];
                    return a.value - b.value;
                });
                renderHand();
            }
        }

        function renderHand() {
            const c = document.getElementById('hand-container');
            c.innerHTML = '';
            currentHand.forEach(t => {
                const d = document.createElement('div');
                d.className = `tile ${['tile-man','tile-pin','tile-sou','tile-ji'][TYPE_ORDER[t.type]]}`;
                if (t.isAgari) d.classList.add('agari-tile');
                d.textContent = t.char;
                
                // Touch Logic
                let sy=0, isDrag=false;
                d.addEventListener('touchstart', e=>{ sy=e.touches[0].clientY; isDrag=true; d.style.transition='none'; }, {passive:false});
                d.addEventListener('touchmove', e=>{
                    if(!isDrag)return;
                    let dy = e.touches[0].clientY - sy;
                    if(dy<0) { e.preventDefault(); d.style.transform=`translateY(${dy}px)`; d.style.opacity = dy<-50?'0.5':'1'; }
                }, {passive:false});
                d.addEventListener('touchend', e=>{
                    if(!isDrag)return; isDrag=false;
                    let dy = e.changedTouches[0].clientY - sy;
                    d.style.transition='transform 0.2s, opacity 0.2s';
                    if(dy < -50) { 
                        d.style.transform='translateY(-100px)'; d.style.opacity='0';
                        setTimeout(()=>{ currentHand = currentHand.filter(x=>x.id!==t.id); renderHand(); }, 200);
                    } else if(Math.abs(dy)<10) {
                        d.style.transform=''; d.style.opacity='1';
                        currentHand.forEach(x => x.isAgari = (x.id === t.id));
                        renderHand();
                    } else { d.style.transform=''; d.style.opacity='1'; }
                });
                // PC Debug
                d.addEventListener('click', ()=> { currentHand.forEach(x => x.isAgari = (x.id === t.id)); renderHand(); });
                d.addEventListener('contextmenu', e=>{ e.preventDefault(); currentHand = currentHand.filter(x=>x.id!==t.id); renderHand(); });

                c.appendChild(d);
            });
            for(let i=currentHand.length; i<14; i++){
                const d = document.createElement('div'); d.className='tile tile-empty'; c.appendChild(d);
            }
        }
        function clearHand() { currentHand=[]; renderHand(); document.getElementById('result-score').textContent="--- ç‚¹"; }

        // --- 4. è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãƒ»ã‚³ã‚¢ (Proç‰ˆ) ---
        
        function calculateFull() {
            const resScore = document.getElementById('result-score');
            const resYaku = document.getElementById('result-yaku');

            if (currentHand.length !== 14) {
                resScore.textContent = "æšæ•°ä¸è¶³"; resYaku.textContent = "ç‰Œã¯14æšå¿…è¦ã§ã™"; return;
            }
            const agariTile = currentHand.find(t => t.isAgari);
            if (!agariTile) {
                resScore.textContent = "æŒ‡å®šãªã—"; resYaku.textContent = "ä¸ŠãŒã‚Šç‰Œã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„"; return;
            }

            // ãƒ‡ãƒ¼ã‚¿å¤‰æ›: è§£æç”¨é…åˆ—ä½œæˆ (man1~9, pin1~9, sou1~9, ji1~7)
            // countMap: { 'man1': 2, 'ji5': 3 ... }
            const counts = {};
            currentHand.forEach(t => {
                const k = t.type + t.value;
                counts[k] = (counts[k]||0) + 1;
            });

            // --- A. ä¸ƒå¯¾å­åˆ¤å®š ---
            const pairs = Object.values(counts).filter(c => c === 2).length;
            if (pairs === 7) {
                calcScoreAndDisplay(25, calcChiitoiYaku(counts), "ä¸ƒå¯¾å­", resScore, resYaku);
                return;
            }

            // --- B. ä¸€èˆ¬æ‰‹ (4é¢å­1é›€é ­) åˆ†è§£ & å½¹åˆ¤å®š ---
            // è¤‡é›‘ãªå½¢ï¼ˆä¾‹: 11123ï¼‰ã¯åˆ»å­ã¨ã‚‚é †å­ã¨ã‚‚å–ã‚Œã‚‹ã€‚å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã—ã¦æœ€é«˜ç‚¹ã‚’æ¢ã™ã€‚
            const decompositions = decompose(counts);
            
            if (decompositions.length === 0) {
                // å›½å£«ç„¡åŒãƒã‚§ãƒƒã‚¯ (ç°¡æ˜“)
                if (isKokushi(counts)) {
                    // å½¹æº€
                    resScore.textContent = settings.seat===0 ? "48000ç‚¹" : "32000ç‚¹";
                    resYaku.textContent = "å½¹æº€ å›½å£«ç„¡åŒ";
                    return;
                }
                resScore.textContent = "å½¹ãªã—"; resYaku.textContent = "ã‚¢ã‚¬ãƒªå½¢ã«ãªã£ã¦ã„ã¾ã›ã‚“";
                return;
            }

            // å„åˆ†è§£ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦å½¹ã¨ç¬¦ã‚’è¨ˆç®—ã—ã€æœ€å¤§ã‚’æ¡ç”¨
            let bestResult = { han: 0, fu: 0, score: 0, yakuNames: [], yakuFull: "" };

            decompositions.forEach(groups => {
                // groups: [{type:'toitsu', tiles:[]}, {type:'shuntsu', tiles:[]}, ...]
                const res = evalHand(groups, counts, agariTile);
                if (res.score > bestResult.score) bestResult = res;
            });

            if (bestResult.han === 0) {
                resScore.textContent = "å½¹ãªã—"; resYaku.textContent = "ã‚¢ã‚¬ãƒªå½¢ã§ã™ãŒå½¹ãŒã‚ã‚Šã¾ã›ã‚“";
            } else {
                resScore.textContent = `${bestResult.score}ç‚¹`;
                resYaku.textContent = `${bestResult.han}é£œ ${bestResult.fu}ç¬¦\n${bestResult.yakuNames.join(' ')}`;
            }
        }

        // --- 5. æ‰‹ç‰Œåˆ†è§£ã‚¨ãƒ³ã‚¸ãƒ³ (å†å¸°æ¢ç´¢) ---
        function decompose(counts) {
            // countsã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ç”¨
            const results = [];
            // ã¾ãšé›€é ­å€™è£œã‚’æ¢ã™
            const keys = Object.keys(counts);
            
            keys.forEach(headKey => {
                if (counts[headKey] >= 2) {
                    const workingCounts = {...counts};
                    workingCounts[headKey] -= 2;
                    const headGroup = { type: 'head', tile: headKey };
                    
                    // æ®‹ã‚Šã®12æšã‚’4ãƒ¡ãƒ³ãƒ„ã«åˆ†è§£
                    const mentsuRes = decomposeMentsu(workingCounts);
                    mentsuRes.forEach(mList => {
                        results.push([headGroup, ...mList]);
                    });
                }
            });
            return results;
        }

        function decomposeMentsu(c) {
            // å†å¸°çš„ã«é¢å­ã‚’å–ã‚Šå‡ºã™
            // å…¨ã¦ã®ç‰ŒãŒãªããªã‚Œã°æˆåŠŸ ([[group1, group2...]])
            // å¤±æ•—ã™ã‚Œã°ç©ºé…åˆ—
            
            // æ®‹ã‚Šç‰ŒãŒã‚ã‚‹æœ€åˆã®ã‚­ãƒ¼ã‚’æ¢ã™
            let first = null;
            const keys = ['man','pin','sou','ji'];
            for(let t of keys) {
                const limit = t==='ji'?7:9;
                for(let v=1; v<=limit; v++) {
                    if (c[t+v] > 0) { first = t+v; break; }
                }
                if(first) break;
            }

            if (!first) return [[]]; // å…¨ã¦ä½¿ã„åˆ‡ã£ãŸï¼æˆåŠŸ

            const results = [];
            const type = first.substring(0, first.length-1);
            const val = parseInt(first.substring(first.length-1));

            // 1. åˆ»å­ (Triplets) ãƒˆãƒ©ã‚¤
            if (c[first] >= 3) {
                const nextC = {...c};
                nextC[first] -= 3;
                const tails = decomposeMentsu(nextC);
                tails.forEach(t => {
                    results.push([{type:'koutsu', tile:first}, ...t]);
                });
            }

            // 2. é †å­ (Sequences) ãƒˆãƒ©ã‚¤ (å­—ç‰Œã¯ä¸å¯)
            if (type !== 'ji' && val <= 7) {
                const k1 = type + val;
                const k2 = type + (val+1);
                const k3 = type + (val+2);
                if (c[k1]>0 && c[k2]>0 && c[k3]>0) {
                    const nextC = {...c};
                    nextC[k1]--; nextC[k2]--; nextC[k3]--;
                    const tails = decomposeMentsu(nextC);
                    tails.forEach(t => {
                        results.push([{type:'shuntsu', tile:k1}, ...t]); // tileã¯é–‹å§‹ç‰Œ
                    });
                }
            }

            return results;
        }

        // --- 6. å½¹ãƒ»ç¬¦ è©•ä¾¡é–¢æ•° ---
        function evalHand(groups, counts, agariTile) {
            let han = 0;
            let yaku = [];
            
            // -- è¨­å®šç”±æ¥ã®å½¹ --
            if (settings.reach === 1) { han+=1; yaku.push("ç«‹ç›´(1)"); }
            if (settings.reach === 2) { han+=2; yaku.push("Wç«‹ç›´(2)"); }
            if (settings.winType === 'tsumo' && settings.seat === 0) { /* è¦ªã®ãƒ„ãƒ¢ã¯ãƒ¡ãƒ³ã‚¼ãƒ³ãƒ„ãƒ¢å½¹ã¤ããŒã€ã“ã“ã§ã¯ç°¡æ˜“çš„ã« */ }
            // ãƒ¡ãƒ³ã‚¼ãƒ³ãƒ„ãƒ¢ (é³´ããªã—å‰æ)
            if (settings.winType === 'tsumo') { han+=1; yaku.push("é–€å‰æ¸…è‡ªæ‘¸(1)"); }
            // ãƒ‰ãƒ©
            if (settings.dora > 0) { han+=settings.dora; yaku.push(`ãƒ‰ãƒ©(${settings.dora})`); }

            // -- æ‰‹ç‰Œæ§‹æˆã®å½¹ --
            const head = groups.find(g => g.type === 'head');
            const mentsu = groups.filter(g => g.type !== 'head');
            const shuntsu = mentsu.filter(g => g.type === 'shuntsu');
            const koutsu = mentsu.filter(g => g.type === 'koutsu');

            // æ–­å¹ºä¹ (Tanyao)
            const isTanyao = Object.keys(counts).every(k => {
                const t = k.slice(0,-1), v=parseInt(k.slice(-1));
                return t!=='ji' && v>1 && v<9;
            });
            if (isTanyao) { han+=1; yaku.push("æ–­å¹ºä¹(1)"); }

            // å½¹ç‰Œ (Yakuhai)
            let yakuhaiHan = 0;
            koutsu.forEach(k => {
                if (k.tile === 'ji5' || k.tile === 'ji6' || k.tile === 'ji7') yakuhaiHan++; // ç™½ç™ºä¸­
                if (k.tile === `ji${settings.prevalent+1}`) yakuhaiHan++; // å ´é¢¨
                if (k.tile === `ji${settings.seat+1}`) yakuhaiHan++; // è‡ªé¢¨
            });
            if (yakuhaiHan>0) { han+=yakuhaiHan; yaku.push(`å½¹ç‰Œ(${yakuhaiHan})`); }

            // å¹³å’Œ (Pinfu) - ç°¡æ˜“åˆ¤å®š: å…¨ã¦é †å­ & é ­ãŒå½¹ç‰Œã˜ã‚ƒãªã„ & (å¾…ã¡åˆ¤å®šã¯æœ¬æ¥å¿…è¦ã ãŒ..)
            // ã“ã“ã§ã¯ã€Œé †å­4ã¤ & é ­ãŒå½¹ç‰Œã§ãªã„ã€ãªã‚‰å¹³å’Œã¨ã¿ãªã™ (å¾…ã¡åˆ¤å®šçœç•¥)
            const headVal = parseInt(head.tile.slice(-1));
            const headType = head.tile.slice(0,-1);
            const isHeadYakuhai = (headType==='ji' && (headVal>=5 || headVal===settings.prevalent+1 || headVal===settings.seat+1));
            const isPinfu = (shuntsu.length === 4 && !isHeadYakuhai);
            if (isPinfu) { han+=1; yaku.push("å¹³å’Œ(1)"); }

            // ä¸€ç›ƒå£ (Iipeiko)
            let iipeiko = 0;
            const seqStr = shuntsu.map(s => s.tile).sort();
            for(let i=0; i<seqStr.length-1; i++) {
                if(seqStr[i] === seqStr[i+1]) { iipeiko++; i++; }
            }
            if(iipeiko === 1) { han+=1; yaku.push("ä¸€ç›ƒå£(1)"); }
            if(iipeiko === 2) { han+=3; yaku.push("äºŒç›ƒå£(3)"); }

            // æ··ä¸€è‰²/æ¸…ä¸€è‰²
            const types = new Set(Object.keys(counts).map(k=>k.slice(0,-1)));
            const hasJi = types.has('ji');
            types.delete('ji');
            if(types.size === 1) {
                if(hasJi) { han+=3; yaku.push("æ··ä¸€è‰²(3)"); }
                else { han+=6; yaku.push("æ¸…ä¸€è‰²(6)"); }
            }

            // å¯¾ã€…å’Œ (Toitoi)
            if (koutsu.length === 4) { han+=2; yaku.push("å¯¾ã€…å’Œ(2)"); }

            // ä¸‰æš—åˆ» (Sanankou) - ä»Šå›ã¯å…¨ã¦ãƒ¡ãƒ³ã‚¼ãƒ³(æš—åˆ»)æ‰±ã„ãªã®ã§ã€koutsuãŒ3ã¤ã‚ã‚Œã°OK
            if (koutsu.length === 3) { han+=2; yaku.push("ä¸‰æš—åˆ»(2)"); }
            if (koutsu.length === 4) { han+=8; yaku.push("å››æš—åˆ»(å½¹æº€)"); } // ç°¡æ˜“

            // ä¸‰è‰²åŒé † (Sanshoku)
            // manX, pinX, souX ã®é †å­ãŒã‚ã‚‹ã‹
            const sMap = {man:[], pin:[], sou:[]};
            shuntsu.forEach(s => sMap[s.tile.slice(0,-1)].push(parseInt(s.tile.slice(-1))));
            let sanshoku = false;
            sMap.man.forEach(v => {
                if(sMap.pin.includes(v) && sMap.sou.includes(v)) sanshoku = true;
            });
            if(sanshoku) { han+=2; yaku.push("ä¸‰è‰²åŒé †(2)"); }

            // ä¸€æ°—é€šè²« (Ittsu)
            let ittsu = false;
            ['man','pin','sou'].forEach(t => {
                const vals = shuntsu.filter(s=>s.tile.startsWith(t)).map(s=>parseInt(s.tile.slice(-1)));
                if(vals.includes(1) && vals.includes(4) && vals.includes(7)) ittsu = true;
            });
            if(ittsu) { han+=2; yaku.push("ä¸€æ°—é€šè²«(2)"); }

            // --- ç¬¦è¨ˆç®— ---
            let fu = 20; // å‰¯åº•
            
            // ãƒ¡ãƒ³ã‚¼ãƒ³ãƒ­ãƒ³
            if (settings.winType === 'ron') fu += 10;
            // ãƒ„ãƒ¢
            if (settings.winType === 'tsumo') fu += 2; // å¹³å’Œãƒ„ãƒ¢ã®å ´åˆã¯20ç¬¦å›ºå®šã ãŒã€å¾Œã§è£œæ­£

            // åˆ»å­ã®ç¬¦
            koutsu.forEach(k => {
                const t = k.tile.slice(0,-1), v=parseInt(k.tile.slice(-1));
                const isYaochu = (t==='ji' || v===1 || v===9);
                fu += isYaochu ? 8 : 4; // æš—åˆ»ã®ã¿ã¨ä»®å®š
            });

            // é›€é ­ã®ç¬¦
            if (isHeadYakuhai) fu += 2;

            // å¾…ã¡ã®ç¬¦ (ãƒšãƒ³ãƒãƒ£ãƒ³ãƒ»ã‚«ãƒ³ãƒãƒ£ãƒ³ãƒ»å˜é¨)
            // â€»å³å¯†ãªå¾…ã¡åˆ¤å®šã¯è¤‡é›‘ãªã®ã§ã€ä»Šå›ã¯ã€Œå¹³å’ŒãŒã¤ã„ãŸã‚‰0ç¬¦ã€ã¤ã‹ãªã‘ã‚Œã°+2ç¬¦ã€ã¨ç°¡æ˜“åŒ–
            // ã“ã‚Œã«ã‚ˆã‚Šã€æ‚ªå½¢ã®å¾…ã¡ã§ã‚‚ã‚ã‚‹ç¨‹åº¦è¿‘ä¼¼å€¤ãŒå‡ºã‚‹
            if (!isPinfu) fu += 2; 

            // åˆ‡ã‚Šä¸Šã’
            if (isPinfu && settings.winType==='tsumo') fu = 20; // å¹³å’Œãƒ„ãƒ¢
            else fu = Math.ceil(fu/10)*10;
            if (isChiitoi(yaku)) fu = 25; // ä¸ƒå¯¾å­ã¯25ç¬¦å›ºå®š

            // --- ç‚¹æ•°ç®—å‡º ---
            let base = fu * Math.pow(2, han+2);
            let score = 0;
            
            // æº€è²«ä»¥ä¸Šã®æ‰“ã¡åˆ‡ã‚Š
            if (han >= 5) base = 2000;
            if (han >= 6) base = 3000;
            if (han >= 8) base = 4000;
            if (han >= 11) base = 6000;
            if (han >= 13) base = 8000;

            if (settings.seat === 0) { // è¦ª
                if (settings.winType === 'ron') score = Math.ceil((base*6)/100)*100;
                else score = Math.ceil((base*2)/100)*100 * 3; // ALL
            } else { // å­
                if (settings.winType === 'ron') score = Math.ceil((base*4)/100)*100;
                else {
                    const oyabun = Math.ceil((base*2)/100)*100;
                    const kobun = Math.ceil((base*1)/100)*100;
                    score = oyabun + kobun*2;
                }
            }
            score += settings.honba * 300;

            return { han, fu, score, yakuNames: yaku };
        }

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---
        function isChiitoi(yakuList) { return yakuList.some(y => y.includes("ä¸ƒå¯¾å­")); }
        function calcChiitoiYaku(counts) {
            let han=2; let yaku=["ä¸ƒå¯¾å­(2)"];
            if(settings.reach===1) {han++; yaku.push("ç«‹ç›´(1)");}
            if(settings.reach===2) {han+=2; yaku.push("Wç«‹ç›´(2)");}
            if(settings.winType==='tsumo') {han++; yaku.push("é–€å‰æ¸…è‡ªæ‘¸(1)");}
            if(settings.dora>0) {han+=settings.dora; yaku.push(`ãƒ‰ãƒ©(${settings.dora})`);}
            // ã‚¿ãƒ³ãƒ¤ã‚ªä¸ƒå¯¾å­
            const isTanyao = Object.keys(counts).every(k => {
                const t = k.slice(0,-1), v=parseInt(k.slice(-1));
                return t!=='ji' && v>1 && v<9;
            });
            if (isTanyao) { han++; yaku.push("æ–­å¹ºä¹(1)"); }
            // æ··ä¸€è‰²ä¸ƒå¯¾å­
            const types = new Set(Object.keys(counts).map(k=>k.slice(0,-1)));
            const hasJi = types.has('ji');
            types.delete('ji');
            if(types.size===1) {
                if(hasJi){han+=3;yaku.push("æ··ä¸€è‰²(3)");} else{han+=6;yaku.push("æ¸…ä¸€è‰²(6)");}
            }
            return { han, fu:25, score:0, yakuNames:yaku };
        }
        function calcScoreAndDisplay(fu, yakuRes, name, elScore, elYaku) {
            // ä¸ƒå¯¾å­ç”¨ãªã©ç‰¹æ®Šãƒ«ãƒ¼ãƒˆ
            let base = fu * Math.pow(2, yakuRes.han+2);
            if(yakuRes.han>=5) base=2000;
            // ... (æº€è²«ãƒ­ã‚¸ãƒƒã‚¯çœç•¥ã€evalHandã¨åŒã˜)
            if(yakuRes.han>=6) base=3000; if(yakuRes.han>=8) base=4000; if(yakuRes.han>=13) base=8000;

            let score=0;
            if(settings.seat===0){
                if(settings.winType==='ron') score = Math.ceil((base*6)/100)*100;
                else score = Math.ceil((base*2)/100)*100 * 3;
            } else {
                if(settings.winType==='ron') score = Math.ceil((base*4)/100)*100;
                else score = Math.ceil((base*2)/100)*100 + Math.ceil((base*1)/100)*100*2;
            }
            score += settings.honba * 300;
            elScore.textContent = `${score}ç‚¹`;
            elYaku.textContent = `${yakuRes.han}é£œ ${fu}ç¬¦\n${yakuRes.yakuNames.join(' ')}`;
        }
        function isKokushi(c) {
            const yaochu = ['man1','man9','pin1','pin9','sou1','sou9','ji1','ji2','ji3','ji4','ji5','ji6','ji7'];
            const keys = Object.keys(c);
            if(keys.length !== 13) return false;
            return keys.every(k => yaochu.includes(k));
        }

        init();
    </script>
</body>
</html>